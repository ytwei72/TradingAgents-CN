# 模拟分析模式使用指南

## 📋 概述

模拟分析模式是一个用于测试进度跟踪功能的开关。启用后，系统不会执行实际的股票分析任务，而是模拟各个分析步骤，每个步骤随机sleep 2-10秒，以便测试进度显示、时间统计等功能。

## 🎯 使用场景

- **测试进度跟踪功能**：验证进度条、步骤时间戳、用时统计是否正确
- **UI/UX测试**：测试前端显示效果，无需等待实际分析完成
- **开发调试**：快速验证分析流程的各个环节
- **性能测试**：测试系统在多个分析任务并发时的表现

## 🔧 启用方法

### 方法 1：环境变量（推荐）

在项目根目录的 `.env` 文件中添加或修改：

```bash
# 启用模拟分析模式
MOCK_ANALYSIS_MODE=true
```

### 方法 2：临时启用（仅当前会话）

**Windows (PowerShell):**
```powershell
$env:MOCK_ANALYSIS_MODE="true"
python start_web.py
```

**Linux/Mac:**
```bash
export MOCK_ANALYSIS_MODE=true
python start_web.py
```

## ⚙️ 配置选项

| 环境变量 | 默认值 | 说明 |
|---------|-------|------|
| `MOCK_ANALYSIS_MODE` | `false` | 是否启用模拟模式 |

**有效值：**
- `true` - 启用模拟模式
- `false` - 禁用模拟模式（使用实际分析）

## 🎭 模拟行为说明

### 模拟的步骤

当启用模拟模式后，系统会模拟以下步骤：

1. **准备阶段**
   - 📋 验证股票代码
   - 🔧 检查API密钥配置
   - 💰 估算分析成本
   - ⚙️ 配置分析参数
   - 🚀 初始化分析引擎

2. **分析师分析**（根据选择的分析师）
   - 📊 市场分析师
   - 💼 基本面分析师
   - 📈 技术分析师
   - 💭 情绪分析师
   - 📰 新闻分析师
   - 🌐 社交媒体分析师
   - ⚠️ 风险分析师

3. **研究员辩论**（根据研究深度）
   - 📈 多头观点分析
   - 📉 空头观点分析
   - 🤝 观点整合

4. **投资建议**
   - 💡 生成投资建议

5. **风险评估**（根据研究深度）
   - 🔥 激进策略评估
   - 🛡️ 保守策略评估
   - ⚖️ 平衡策略评估
   - 🎯 风险控制措施

6. **报告生成**
   - 📊 生成分析报告

### 时间模拟

- 每个步骤随机sleep **2-10秒**
- 总耗时约为：**步骤数 × 平均6秒**
- 例如：15个步骤大约需要 1.5-2.5 分钟

### 模拟结果

模拟模式会返回简化的分析结果：

```python
{
    'success': True,
    'stock_symbol': '股票代码',
    'analysis_date': '分析日期',
    'mock_mode': True,  # 标识这是模拟结果
    'market_report': '市场分析报告（模拟）',
    'fundamentals_report': '基本面分析报告（模拟）',
    # ... 其他模拟报告
    'final_trade_decision': '投资建议（模拟）',
}
```

## 📊 测试进度跟踪功能

启用模拟模式后，你可以测试以下功能：

### 1. 时间戳精确度
- ✅ 验证每个步骤的完成时间戳秒数不同
- ✅ 验证时间戳按实际完成时间记录

### 2. 步骤用时统计
- ✅ 验证每个步骤显示实际执行时间
- ✅ 验证步骤用时在 2-10秒 范围内

### 3. 总用时统计
- ✅ 验证总用时随步骤推进而递增
- ✅ 验证总用时 = 各步骤用时之和

### 4. 进度显示
- ✅ 验证进度条正确更新
- ✅ 验证步骤名称和描述正确显示
- ✅ 验证步骤状态（待执行/进行中/已完成）正确

## 🔍 使用示例

### 示例 1：测试基本进度跟踪

```bash
# 1. 启用模拟模式
echo "MOCK_ANALYSIS_MODE=true" >> .env

# 2. 启动Web应用
python start_web.py

# 3. 在Web界面提交分析任务

# 4. 观察进度显示：
#    - 展开"查看详细分析步骤日志"
#    - 观察各步骤的时间戳、步骤用时、总用时
#    - 验证时间统计是否正确
```

### 示例 2：测试不同研究深度

```python
# 快速分析（research_depth=1）
# 预计步骤数：约 10 步
# 预计耗时：1-2 分钟

# 标准分析（research_depth=2）
# 预计步骤数：约 13 步
# 预计耗时：1.5-2.5 分钟

# 深度分析（research_depth=3）
# 预计步骤数：约 17 步
# 预计耗时：2-3 分钟
```

### 示例 3：压力测试

```bash
# 同时启动多个分析任务
# 验证系统在并发情况下的表现
# 验证进度跟踪是否互不干扰
```

## ⚠️ 注意事项

1. **模拟模式不执行实际分析**
   - 不会调用API获取真实数据
   - 不会使用LLM进行分析
   - 生成的报告仅为测试数据

2. **不在页面显示**
   - 模拟模式开关仅通过环境变量控制
   - 页面上不会显示"模拟模式"的标识
   - 查看日志可以确认是否在模拟模式

3. **日志标识**
   - 模拟模式的日志会包含 `[模拟模式]` 或 `🎭` 标识
   - 例如：`🎭 [模拟模式] 开始模拟分析 AAPL（不执行实际任务）`

4. **禁用方法**
   ```bash
   # 将环境变量设为 false 或删除该行
   MOCK_ANALYSIS_MODE=false
   
   # 或者
   # MOCK_ANALYSIS_MODE=true  # 注释掉
   ```

## 🐛 故障排除

### 问题 1：修改环境变量后未生效

**解决方案：**
1. 重启Web应用（环境变量在启动时加载）
2. 检查 `.env` 文件格式是否正确
3. 确认没有多余的空格或引号

### 问题 2：无法确认是否在模拟模式

**解决方案：**
查看日志文件，搜索 `[模拟模式]` 关键字：
```bash
# Windows PowerShell
Get-Content logs/tradingagents.log | Select-String "模拟模式"

# Linux/Mac
grep "模拟模式" logs/tradingagents.log
```

### 问题 3：想要更改sleep时间范围

**解决方案：**
修改 `web/utils/analysis_runner.py` 中的 `mock_sleep()` 函数：

```python
def mock_sleep():
    """随机sleep 2-10秒"""
    # 修改这里的范围
    sleep_time = random.uniform(2, 10)  # 改为你想要的范围，如 (1, 5)
    logger.info(f"[模拟] 模拟执行中，睡眠 {sleep_time:.1f} 秒...")
    time.sleep(sleep_time)
```

## 📚 相关文档

- [进度跟踪时间显示修复](../fixes/progress_timing_fix.md)
- [异步进度跟踪器使用指南](../technical/async_progress_tracker.md)

## 🔄 更新日志

### v1.0.0 (2025-10-30)
- ✨ 新增模拟分析模式
- ✨ 支持通过环境变量 `MOCK_ANALYSIS_MODE` 控制
- ✨ 模拟各个分析步骤，随机sleep 2-10秒
- ✨ 返回简化的模拟分析结果

