# 进度跟踪时间显示修复

## 修复日期
2025-10-30

## 问题描述

在实时任务执行步骤中发现了两个问题：

1. **时间戳秒针相同**：代码使用了简化的时间估算（`step_start_time = start_time + (i * 60)`），导致所有步骤的秒数都相同，无法真实反映步骤的实际完成时间。

2. **用时显示错误**：当前显示的是"从分析开始到该步骤"的总用时，而不是该步骤本身的执行时间，用户无法了解每个步骤具体耗费了多少时间。

## 解决方案

### 1. 记录实际步骤执行历史

在 `AsyncProgressTracker` 类中添加了步骤历史跟踪功能：

#### 修改文件：`web/utils/async_progress_tracker.py`

**新增属性：**
```python
self.step_history = []  # 记录每个步骤的实际执行历史
self.step_start_times = {0: self.start_time}  # 记录每个步骤的开始时间
```

**更新 `update_progress` 方法：**
- 当步骤发生变化时，记录前一个步骤的实际完成时间
- 记录新步骤的实际开始时间
- 在分析完成时，记录最后一个步骤的完成时间

**步骤历史记录包含：**
- `step_index`: 步骤索引
- `step_name`: 步骤名称
- `start_time`: 实际开始时间戳
- `end_time`: 实际结束时间戳
- `duration`: 步骤实际执行时长（秒）
- `message`: 完成时的消息

### 2. 更新进度显示逻辑

#### 修改文件：`web/components/async_progress_display.py`

**更新 `_render_step_log` 函数：**

1. **使用实际时间戳**：
   - 已完成步骤：使用 `history['end_time']` 作为实际完成时间
   - 当前步骤：使用当前时间 `time.time()`
   - 待执行步骤：时间戳为 None

2. **同时显示两种用时**：
   - **步骤用时** (`step_duration`)：该步骤本身的执行时间
   - **总用时** (`total_elapsed`)：从分析开始到该步骤完成的总用时

3. **更新显示界面**：

布局优化：
- 左侧：步骤标题后直接显示该步骤的用时（蓝色）
- 右侧：显示时间戳和总用时

```
左侧：                              右侧：
✅ 阶段 1: 📋 准备阶段 (用时: 1.2分钟)   🕐 2025-10-30 14:23:45
   验证股票代码... - 已完成              📊 总用时: 3.5分钟
```

## 修改文件清单

1. **web/utils/async_progress_tracker.py**
   - 添加步骤历史跟踪（`step_history`, `step_start_times`）
   - 更新 `update_progress` 方法记录实际执行时间
   - 在 `progress_data` 中保存 `step_history`

2. **web/components/async_progress_display.py**
   - 更新 `_render_step_log` 函数使用实际步骤历史
   - 添加步骤用时和总用时的双重显示
   - 优化时间显示布局，增加最小宽度到 180px

## 预期效果

### 修复前：
- 所有步骤的时间戳秒数相同（如：14:00:00, 14:01:00, 14:02:00）
- 只显示总用时，无法了解单个步骤的耗时

### 修复后：
- 每个步骤显示真实的完成时间（如：14:00:32, 14:01:47, 14:03:15）
- 同时显示：
  - ⏱️ 步骤用时：该步骤本身的执行时间
  - 📊 总用时：从分析开始到该步骤的累计时间

## 向后兼容性

- 如果旧的进度数据中没有 `step_history` 字段，系统会优雅降级
- 对于待执行的步骤，仍然显示为"未开始"状态
- 不影响现有的进度跟踪和显示功能

## 显示效果示例

步骤卡片显示布局（最终效果）：

```
┌────────────────────────────────────────────────────────────────┐
│ ✅ 阶段 1: 📋 准备阶段 (用时: 0.5分钟)    🕐 2025-10-30 14:00:32 │
│    正在验证股票代码... - 已完成           📊 总用时: 0.5分钟     │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│ ✅ 阶段 2: 📊 市场分析 (用时: 1.2分钟)    🕐 2025-10-30 14:01:47 │
│    分析股价走势、成交量... - 已完成       📊 总用时: 1.7分钟     │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│ 🔄 阶段 3: 💼 基本面分析 (用时: 0.8分钟)  🕐 2025-10-30 14:02:35 │
│    正在分析财务数据...                    📊 总用时: 2.5分钟     │
└────────────────────────────────────────────────────────────────┘
```

**布局说明：**
- **左侧**：步骤图标 + 标题 + **步骤用时**（蓝色显示，紧跟标题后）
- **右侧**：完成时间戳 + 累计总用时
- **智能显示**：步骤用时只在大于0时显示，避免显示"用时: 0秒"

## 测试建议

1. 启动一个新的股票分析任务
2. 在分析过程中刷新进度显示页面
3. 展开"查看详细分析步骤日志"
4. 验证：
   - 每个已完成步骤的时间戳秒数不同（精确到秒）
   - 步骤用时显示在标题后面（蓝色文字）
   - 步骤用时反映该步骤的实际执行时间
   - 总用时递增且合理（在右侧显示）
   - 当前步骤的用时持续增加

## 相关问题

此修复解决了用户报告的以下问题：
- 时间戳不够精确，所有步骤秒数相同
- 无法了解单个步骤的实际耗时
- 无法区分快速步骤和慢速步骤

## 测试工具

### 模拟分析模式

为了方便测试进度跟踪功能，我们添加了模拟分析模式。启用后，系统不会执行实际分析，而是模拟各个步骤（每步随机sleep 2-10秒）。

**启用方法：**

在 `.env` 文件中添加：
```bash
MOCK_ANALYSIS_MODE=true
```

**详细说明：**
- [模拟模式快速启用指南](../guides/MOCK_MODE_QUICKSTART.md)
- [模拟模式完整文档](../guides/mock_analysis_mode.md)

## 后续改进建议

1. 可以添加步骤用时的统计分析（平均值、最慢步骤等）
2. 可以对异常耗时的步骤进行高亮提示
3. 可以保存历史分析的步骤用时，用于更准确的预估

