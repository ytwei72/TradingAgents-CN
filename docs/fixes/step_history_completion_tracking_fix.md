# æ­¥éª¤å®ŒæˆçŠ¶æ€è·Ÿè¸ªä¿®å¤

## ä¿®å¤æ—¥æœŸ
2025-10-30

## é—®é¢˜æè¿°

å³ä½¿æŸä¸ªæ­¥éª¤ï¼ˆå¦‚"é˜¶æ®µ15: âš–ï¸ å¹³è¡¡ç­–ç•¥"ï¼‰å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œä½†åœ¨åˆ†ææµç¨‹è¿½è¸ªçš„ä»»åŠ¡åˆ—è¡¨ä¸­ä»ç„¶æ˜¾ç¤ºä¸º"ç­‰å¾…æ‰§è¡Œ"çŠ¶æ€ã€‚

## é—®é¢˜åˆ†æ

æ­¥éª¤å†å²è®°å½•é€»è¾‘å­˜åœ¨ç¼ºé™·ï¼š

### åŸæœ‰é€»è¾‘
1. **æ­¥éª¤æ¨è¿›æ—¶**ï¼ˆ`step != old_step`ï¼‰ï¼šè®°å½•æ—§æ­¥éª¤å®Œæˆ
2. **åˆ†æå®Œæˆæ—¶**ï¼šè®°å½•æœ€åä¸€æ­¥å®Œæˆ

### é—®é¢˜åœºæ™¯
å¦‚æœæŸä¸ªæ­¥éª¤çš„"æ¨¡å—å¼€å§‹"æ¶ˆæ¯æ²¡æœ‰è¢«æ­£ç¡®æ£€æµ‹ï¼Œå¯¼è‡´æ­¥éª¤æ²¡æœ‰æ¨è¿›åˆ°è¯¥æ­¥éª¤ï¼š

```
å½“å‰æ­¥éª¤: 14 (ä¿å®ˆç­–ç•¥)
æ”¶åˆ°æ¶ˆæ¯: ğŸ“Š [æ¨¡å—å¼€å§‹] neutral_analyst
æ£€æµ‹ç»“æœ: åº”è¯¥æ¨è¿›åˆ°æ­¥éª¤ 15
å®é™…æƒ…å†µ: ç”±äºæŸç§åŸå› ï¼Œæ£€æµ‹å¤±è´¥æˆ–è¢«è·³è¿‡
å½“å‰æ­¥éª¤: ä»ç„¶æ˜¯ 14

æ”¶åˆ°æ¶ˆæ¯: ğŸ“Š [æ¨¡å—å®Œæˆ] neutral_analyst  
å½“å‰æ­¥éª¤: 14
å¤„ç†é€»è¾‘: æ¨è¿›åˆ° 15
ç»“æœ: æ­¥éª¤15æ²¡æœ‰è¢«è®°å½•åˆ° step_historyï¼Œå› ä¸ºä»æœªä½œä¸º"å½“å‰æ­¥éª¤"è¢«å¤„ç†
```

## è§£å†³æ–¹æ¡ˆ

é‡‡ç”¨**ä¸‰é‡ä¿éšœæœºåˆ¶**ç¡®ä¿æ­¥éª¤å®ŒæˆçŠ¶æ€æ­£ç¡®æ˜¾ç¤ºï¼š

### 1. æ¨¡å—å¼€å§‹æ—¶è®°å½•æ­¥éª¤å¼€å§‹æ—¶é—´

åœ¨æ£€æµ‹åˆ°"æ¨¡å—å¼€å§‹"æ¶ˆæ¯æ—¶ï¼Œå³ä½¿ä¸æ¨è¿›æ­¥éª¤ï¼Œä¹Ÿè®°å½•è¯¥æ­¥éª¤çš„å¼€å§‹æ—¶é—´ï¼š

```python
# æ¨¡å—å¼€å§‹æ—¥å¿— - æ¨è¿›åˆ°å¯¹åº”æ­¥éª¤å¹¶è®°å½•æ­¥éª¤å¼€å§‹æ—¶é—´
elif "æ¨¡å—å¼€å§‹" in message:
    # ... æ£€æµ‹æ­¥éª¤é€»è¾‘ ...
    detected_step = ...
    
    # å¦‚æœæ£€æµ‹åˆ°æ­¥éª¤ï¼Œè®°å½•è¯¥æ­¥éª¤çš„å¼€å§‹æ—¶é—´ï¼ˆå¦‚æœè¿˜æ²¡æœ‰è®°å½•çš„è¯ï¼‰
    if detected_step is not None and detected_step not in self.step_start_times:
        self.step_start_times[detected_step] = time.time()
        logger.debug(f"ğŸ“Š [æ­¥éª¤å¼€å§‹] è®°å½•æ­¥éª¤ {detected_step} çš„å¼€å§‹æ—¶é—´")
    
    return detected_step
```

**ä¼˜ç‚¹ï¼š** å³ä½¿æ­¥éª¤æ²¡æœ‰ç«‹å³æ¨è¿›ï¼Œä¹Ÿèƒ½è®°å½•å‡†ç¡®çš„å¼€å§‹æ—¶é—´ã€‚

### 2. æ¨¡å—å®Œæˆæ—¶ç¡®ä¿æ­¥éª¤è¢«è®°å½•

åœ¨"æ¨¡å—å®Œæˆ"æ¶ˆæ¯æ¨è¿›åˆ°ä¸‹ä¸€æ­¥ä¹‹å‰ï¼Œå…ˆæ£€æŸ¥å¹¶è®°å½•å½“å‰æ­¥éª¤ï¼š

```python
# æ¨¡å—å®Œæˆæ—¥å¿— - ç¡®ä¿å½“å‰æ­¥éª¤è¢«è®°å½•ï¼Œç„¶åæ¨è¿›åˆ°ä¸‹ä¸€æ­¥
elif "æ¨¡å—å®Œæˆ" in message:
    # æ£€æŸ¥å½“å‰æ­¥éª¤æ˜¯å¦å·²è®°å½•ï¼Œå¦‚æœæ²¡æœ‰åˆ™è®°å½•
    if self.current_step not in [s['step_index'] for s in self.step_history]:
        step_start = self.step_start_times.get(self.current_step, time.time())
        step_duration = time.time() - step_start
        current_step_info = self.analysis_steps[self.current_step] if self.current_step < len(self.analysis_steps) else {'name': 'æœªçŸ¥'}
        self.step_history.append({
            'step_index': self.current_step,
            'step_name': current_step_info['name'],
            'start_time': step_start,
            'end_time': time.time(),
            'duration': step_duration,
            'message': message
        })
        logger.debug(f"ğŸ“Š [æ­¥éª¤è®°å½•] è®°å½•æ­¥éª¤ {self.current_step} ({current_step_info['name']}) å®Œæˆ")
    
    # ç„¶åæ¨è¿›åˆ°ä¸‹ä¸€æ­¥
    next_step = min(self.current_step + 1, len(self.analysis_steps) - 1)
    logger.debug(f"ğŸ“Š [æ­¥éª¤æ¨è¿›] æ¨¡å—å®Œæˆï¼Œä»æ­¥éª¤{self.current_step}æ¨è¿›åˆ°æ­¥éª¤{next_step}")
    return next_step
```

**ä¼˜ç‚¹ï¼š** 
- ä¿è¯æ¯ä¸ªæ­¥éª¤éƒ½ä¼šè¢«è®°å½•
- ä½¿ç”¨ä¹‹å‰è®°å½•çš„å¼€å§‹æ—¶é—´ï¼Œè®¡ç®—å‡†ç¡®çš„æ‰§è¡Œæ—¶é•¿
- å³ä½¿æ£€æµ‹é€»è¾‘æœ‰æ¼æ´ï¼Œä¹Ÿèƒ½ç¡®ä¿æ­¥éª¤ä¸ä¼šè¢«é—æ¼

### 3. æ˜¾ç¤ºæ—¶è¡¥å½•å·²è¿‡å»çš„æ­¥éª¤

åœ¨æ¸²æŸ“æ­¥éª¤åˆ—è¡¨æ—¶ï¼Œå¯¹äº `i < current_step` ä½†ä¸åœ¨å†å²è®°å½•ä¸­çš„æ­¥éª¤ï¼Œè‡ªåŠ¨è¡¥å½•ä¸º"å·²å®Œæˆ"ï¼š

**æ–‡ä»¶ï¼š** `web/components/async_progress_display.py`

```python
elif i < current_step:
    # å·²ç»è¿‡å»çš„æ­¥éª¤ï¼Œä½†æ²¡æœ‰å†å²è®°å½•ï¼ˆè¡¥å½•ï¼‰
    # å°è¯•ä»å‰åæ­¥éª¤æ¨ç®—æ—¶é—´
    if i > 0 and (i-1) in step_history_map:
        estimated_time = step_history_map[i-1]['end_time']
    else:
        estimated_time = start_time + (i * 30)  # ä¼°ç®—æ¯æ­¥30ç§’
    
    steps_history.append({
        'phase': f'é˜¶æ®µ {i+1}: {step_name}',
        'message': f'{step_description} - å·²å®Œæˆï¼ˆæœªè®°å½•è¯¦ç»†æ—¶é—´ï¼‰',
        'timestamp': estimated_time,
        'step_duration': 0,  # æœªè®°å½•å…·ä½“ç”¨æ—¶
        'total_elapsed': estimated_time - start_time,
        'status': 'completed',
        'icon': 'âœ…'
    })
```

**ä¼˜ç‚¹ï¼š**
- æœ€åä¸€é“é˜²çº¿ï¼Œå³ä½¿å‰ä¸¤é“ä¿éšœéƒ½å¤±æ•ˆï¼Œä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º
- åŸºäºé€»è¾‘æ¨ç†ï¼šå¦‚æœ current_step å·²ç»è¶…è¿‡æŸæ­¥éª¤ï¼Œè¯´æ˜è¯¥æ­¥éª¤å¿…ç„¶å·²æ‰§è¡Œ
- æä¾›æ˜ç¡®çš„æ ‡è¯†"æœªè®°å½•è¯¦ç»†æ—¶é—´"ï¼Œè®©ç”¨æˆ·çŸ¥é“è¿™æ˜¯è¡¥å½•çš„
- å°è¯•ä¼°ç®—æ—¶é—´æˆ³ï¼Œä¿è¯æ˜¾ç¤ºçš„è¿è´¯æ€§

## å·¥ä½œæµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šneutral_analystï¼ˆå¹³è¡¡ç­–ç•¥ï¼‰æ‰§è¡Œ

#### ä¿®å¤å‰ï¼š
```
1. æ”¶åˆ°: ğŸ“Š [æ¨¡å—å¼€å§‹] neutral_analyst
   - æ£€æµ‹åˆ°æ­¥éª¤15
   - ä½†ç”±äºæŸç§åŸå› æœªæ¨è¿›
   - current_step ä»ä¸º 14

2. æ”¶åˆ°: ğŸ“Š [æ¨¡å—å®Œæˆ] neutral_analyst
   - current_step = 14
   - æ¨è¿›åˆ° next_step = 15
   - æ­¥éª¤14è¢«è®°å½•åˆ°å†å²
   - æ­¥éª¤15ä»æœªè¢«å¤„ç†ï¼Œæœªè®°å½•åˆ°å†å²
   
3. æ˜¾ç¤ºç»“æœï¼š
   - æ­¥éª¤14 âœ… å·²å®Œæˆ
   - æ­¥éª¤15 â³ ç­‰å¾…æ‰§è¡Œ  â† é”™è¯¯ï¼
```

#### ä¿®å¤åï¼š
```
1. æ”¶åˆ°: ğŸ“Š [æ¨¡å—å¼€å§‹] neutral_analyst
   - æ£€æµ‹åˆ°æ­¥éª¤15
   - è®°å½•: step_start_times[15] = å½“å‰æ—¶é—´
   - æ¨è¿›åˆ°æ­¥éª¤15ï¼ˆå¦‚æœæ£€æµ‹æˆåŠŸï¼‰

2. æ”¶åˆ°: ğŸ“Š [æ¨¡å—å®Œæˆ] neutral_analyst
   - current_step = 15ï¼ˆæˆ–14ï¼Œå–å†³äºæ­¥éª¤1æ˜¯å¦æˆåŠŸæ¨è¿›ï¼‰
   - æ£€æŸ¥æ­¥éª¤15æ˜¯å¦åœ¨å†å²ä¸­
   - å¦‚æœä¸åœ¨ï¼Œä½¿ç”¨ step_start_times[15] è®¡ç®—æ—¶é•¿
   - è®°å½•æ­¥éª¤15åˆ°å†å²
   - æ¨è¿›åˆ° next_step = 16
   
3. æ˜¾ç¤ºç»“æœï¼š
   - æ­¥éª¤15 âœ… å·²å®Œæˆ  â† æ­£ç¡®ï¼
   - ä½¿ç”¨å‡†ç¡®çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
```

## ä¿®æ”¹æ–‡ä»¶

### æ–‡ä»¶1ï¼šweb/utils/async_progress_tracker.py

#### ä¿®æ”¹ç‚¹1ï¼š_detect_step_from_message æ–¹æ³•ï¼ˆæ¨¡å—å¼€å§‹ï¼‰

**ä½ç½®ï¼š** ç¬¬ 453-495 è¡Œ

**ä¿®æ”¹å†…å®¹ï¼š**
- åœ¨"æ¨¡å—å¼€å§‹"åˆ†æ”¯ä¸­ï¼Œè®°å½•æ£€æµ‹åˆ°çš„æ­¥éª¤çš„å¼€å§‹æ—¶é—´
- æ·»åŠ è°ƒè¯•æ—¥å¿—

#### ä¿®æ”¹ç‚¹2ï¼š_detect_step_from_message æ–¹æ³•ï¼ˆæ¨¡å—å®Œæˆï¼‰

**ä½ç½®ï¼š** ç¬¬ 492-513 è¡Œ

**ä¿®æ”¹å†…å®¹ï¼š**
- åœ¨"æ¨¡å—å®Œæˆ"åˆ†æ”¯ä¸­ï¼Œå…ˆæ£€æŸ¥å¹¶è®°å½•å½“å‰æ­¥éª¤
- ç„¶åå†æ¨è¿›åˆ°ä¸‹ä¸€æ­¥
- æ·»åŠ è°ƒè¯•æ—¥å¿—

### æ–‡ä»¶2ï¼šweb/components/async_progress_display.py

#### ä¿®æ”¹ç‚¹ï¼š_render_step_log æ–¹æ³•

**ä½ç½®ï¼š** ç¬¬ 671-687 è¡Œ

**ä¿®æ”¹å†…å®¹ï¼š**
- æ·»åŠ  `elif i < current_step` åˆ†æ”¯
- å¯¹å·²è¿‡å»ä½†æœªè®°å½•çš„æ­¥éª¤è¿›è¡Œè¡¥å½•
- æ ‡è®°ä¸º"å·²å®Œæˆï¼ˆæœªè®°å½•è¯¦ç»†æ—¶é—´ï¼‰"

## æµ‹è¯•éªŒè¯

### 1. æ­£å¸¸æµç¨‹æµ‹è¯•
```
æ­¥éª¤é¡ºåºæ‰§è¡Œï¼Œæ¯ä¸ªæ­¥éª¤éƒ½æœ‰"æ¨¡å—å¼€å§‹"å’Œ"æ¨¡å—å®Œæˆ"
âœ… æ‰€æœ‰æ­¥éª¤éƒ½åº”è¯¥è¢«è®°å½•
âœ… æ‰€æœ‰æ­¥éª¤éƒ½æ˜¾ç¤ºä¸º"å·²å®Œæˆ"
```

### 2. å¼‚å¸¸æµç¨‹æµ‹è¯•
```
æŸä¸ªæ­¥éª¤çš„"æ¨¡å—å¼€å§‹"è¢«è·³è¿‡
âœ… "æ¨¡å—å®Œæˆ"æ—¶åº”è¯¥è¡¥å……è®°å½•è¯¥æ­¥éª¤
âœ… è¯¥æ­¥éª¤åº”è¯¥æ˜¾ç¤ºä¸º"å·²å®Œæˆ"è€Œä¸æ˜¯"ç­‰å¾…æ‰§è¡Œ"
```

### 3. æ—¶é—´å‡†ç¡®æ€§æµ‹è¯•
```
æ£€æŸ¥æ­¥éª¤çš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´
âœ… å¼€å§‹æ—¶é—´åº”è¯¥æ˜¯"æ¨¡å—å¼€å§‹"çš„æ—¶é—´
âœ… ç»“æŸæ—¶é—´åº”è¯¥æ˜¯"æ¨¡å—å®Œæˆ"çš„æ—¶é—´
âœ… æ­¥éª¤ç”¨æ—¶ = ç»“æŸæ—¶é—´ - å¼€å§‹æ—¶é—´
```

## æ—¥å¿—ç¤ºä¾‹

å¯ç”¨ä¿®å¤åï¼Œæ—¥å¿—ä¸­ä¼šçœ‹åˆ°ï¼š

```
ğŸ“Š [æ­¥éª¤å¼€å§‹] è®°å½•æ­¥éª¤ 15 çš„å¼€å§‹æ—¶é—´
ğŸ“Š [æ­¥éª¤è®°å½•] è®°å½•æ­¥éª¤ 15 (âš–ï¸ å¹³è¡¡ç­–ç•¥) å®Œæˆ
ğŸ“Š [æ­¥éª¤æ¨è¿›] æ¨¡å—å®Œæˆï¼Œä»æ­¥éª¤15æ¨è¿›åˆ°æ­¥éª¤16
```

## ç›¸å…³ä¿®å¤

æ­¤ä¿®å¤é…åˆä»¥ä¸‹åŠŸèƒ½ä¸€èµ·å·¥ä½œï¼š

1. [å®é™…åˆ†ææ­¥éª¤è·Ÿè¸ªä¿®å¤](actual_analysis_step_tracking_fix.md)
   - ä¸ºæ‰€æœ‰æ¨¡å—æ·»åŠ æ—¥å¿—è£…é¥°å™¨

2. [è¿›åº¦è·Ÿè¸ªæ—¶é—´æ˜¾ç¤ºä¿®å¤](progress_timing_fix.md)
   - è®°å½•å®é™…æ­¥éª¤æ‰§è¡Œæ—¶é—´

3. [æ¨¡æ‹Ÿæ¨¡å¼æ­¥éª¤æ£€æµ‹ä¿®å¤](mock_mode_step_detection_fix.md)
   - Mockæ¨¡å¼ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯æ ¼å¼

## ä¼˜åŠ¿

1. **å®¹é”™æ€§å¼º**ï¼šå³ä½¿æ­¥éª¤æ£€æµ‹æœ‰é—æ¼ï¼Œä¹Ÿèƒ½ä¿è¯æ­¥éª¤è¢«è®°å½•
2. **æ—¶é—´å‡†ç¡®**ï¼šä½¿ç”¨å®é™…çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
3. **è°ƒè¯•å‹å¥½**ï¼šæ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
4. **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰æ­£å¸¸å·¥ä½œçš„æµç¨‹

## æ³¨æ„äº‹é¡¹

1. **æ­¥éª¤å¼€å§‹æ—¶é—´**
   - åªåœ¨é¦–æ¬¡æ£€æµ‹åˆ°"æ¨¡å—å¼€å§‹"æ—¶è®°å½•
   - é¿å…é‡å¤è®°å½•å¯¼è‡´æ—¶é—´è¢«è¦†ç›–

2. **æ­¥éª¤å®Œæˆè®°å½•**
   - åªåœ¨æ­¥éª¤æœªè®°å½•æ—¶è¡¥å……è®°å½•
   - é¿å…é‡å¤è®°å½•å¯¼è‡´å†å²æ··ä¹±

3. **æ€§èƒ½è€ƒè™‘**
   - æ£€æŸ¥æ­¥éª¤æ˜¯å¦å·²è®°å½•æ—¶ï¼Œéå† step_history
   - å¯¹äºæ­¥éª¤æ•°é‡ä¸å¤šçš„æƒ…å†µï¼ˆé€šå¸¸10-20æ­¥ï¼‰ï¼Œæ€§èƒ½å½±å“å¯å¿½ç•¥

## æ€»ç»“

é€šè¿‡**ä¸‰é‡ä¿éšœæœºåˆ¶**ï¼ŒæˆåŠŸè§£å†³äº†æ­¥éª¤å®ŒæˆçŠ¶æ€è·Ÿè¸ªä¸å‡†ç¡®çš„é—®é¢˜ï¼š

### ä¸‰é‡ä¿éšœ
1. **ç¬¬ä¸€é“é˜²çº¿**ï¼šæ¨¡å—å¼€å§‹æ—¶è®°å½•æ­¥éª¤å¼€å§‹æ—¶é—´
   - å³ä½¿æ­¥éª¤æœªæ¨è¿›ï¼Œä¹Ÿèƒ½è®°å½•å‡†ç¡®çš„å¼€å§‹æ—¶é—´
   
2. **ç¬¬äºŒé“é˜²çº¿**ï¼šæ¨¡å—å®Œæˆæ—¶ç¡®ä¿æ­¥éª¤è¢«è®°å½•
   - æ¨è¿›å‰æ£€æŸ¥å¹¶è®°å½•å½“å‰æ­¥éª¤
   - ä½¿ç”¨ç¬¬ä¸€é“é˜²çº¿è®°å½•çš„æ—¶é—´è®¡ç®—æ—¶é•¿
   
3. **ç¬¬ä¸‰é“é˜²çº¿**ï¼šæ˜¾ç¤ºæ—¶è¡¥å½•å·²è¿‡å»çš„æ­¥éª¤
   - åŸºäºé€»è¾‘æ¨ç†ï¼šcurrent_step å·²è¶…è¿‡ = å¿…ç„¶å·²æ‰§è¡Œ
   - å³ä½¿å‰ä¸¤é“é˜²çº¿éƒ½å¤±æ•ˆï¼Œä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º
   - æ ‡è®°"æœªè®°å½•è¯¦ç»†æ—¶é—´"ä¿æŒé€æ˜åº¦

### æ•ˆæœ
- âœ… æ‰€æœ‰å·²æ‰§è¡Œçš„æ­¥éª¤éƒ½ä¼šæ˜¾ç¤ºä¸º"å·²å®Œæˆ"
- âœ… ä¸ä¼šå†å‡ºç°"ç­‰å¾…æ‰§è¡Œ"çš„è¯¯æŠ¥
- âœ… æ—¶é—´è®°å½•å°½å¯èƒ½å‡†ç¡®
- âœ… å³ä½¿éƒ¨åˆ†è®°å½•ç¼ºå¤±ï¼Œæ˜¾ç¤ºä¹Ÿä¿æŒæ­£ç¡®

ç°åœ¨"é˜¶æ®µ15: âš–ï¸ å¹³è¡¡ç­–ç•¥"ç­‰æ‰€æœ‰å·²æ‰§è¡Œæ­¥éª¤éƒ½èƒ½æ­£ç¡®æ˜¾ç¤ºä¸º"âœ… å·²å®Œæˆ"çŠ¶æ€ï¼

