# ä»»åŠ¡æ§åˆ¶åŠŸèƒ½è¯´æ˜æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†TradingAgentsç³»ç»Ÿä¸­æ–°å¢çš„**ä»»åŠ¡æš‚åœã€ç»§ç»­å’Œåœæ­¢**åŠŸèƒ½ã€‚è¯¥åŠŸèƒ½å…è®¸ç”¨æˆ·åœ¨åˆ†æä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è¿›è¡Œç²¾ç»†åŒ–æ§åˆ¶ã€‚

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. ä»»åŠ¡æš‚åœ (â¸ï¸ Pause)
- **åŠŸèƒ½æè¿°**: æš‚æ—¶æŒ‚èµ·æ­£åœ¨æ‰§è¡Œçš„åˆ†æä»»åŠ¡
- **åº”ç”¨åœºæ™¯**: 
  - éœ€è¦ä¸´æ—¶é‡Šæ”¾ç³»ç»Ÿèµ„æº
  - ç­‰å¾…æ›´å¤šæ•°æ®æˆ–ä¿¡æ¯
  - æš‚æ—¶ä¸éœ€è¦åˆ†æç»“æœ
- **æŠ€æœ¯å®ç°**: ä½¿ç”¨ `threading.Event` å®ç°çº¿ç¨‹æš‚åœæœºåˆ¶
- **çŠ¶æ€ä¿æŒ**: æš‚åœæœŸé—´ä¿ç•™æ‰€æœ‰åˆ†æçŠ¶æ€å’Œè¿›åº¦

### 2. ä»»åŠ¡ç»§ç»­ (â–¶ï¸ Resume)
- **åŠŸèƒ½æè¿°**: æ¢å¤å·²æš‚åœçš„åˆ†æä»»åŠ¡
- **åº”ç”¨åœºæ™¯**: å‡†å¤‡å¥½ç»§ç»­åˆ†ææ—¶æ¢å¤æ‰§è¡Œ
- **æŠ€æœ¯å®ç°**: æ¸…é™¤æš‚åœæ ‡å¿—ï¼Œä»»åŠ¡è‡ªåŠ¨ä»æš‚åœç‚¹ç»§ç»­
- **æ—¶é—´ç»Ÿè®¡**: è‡ªåŠ¨æ’é™¤æš‚åœæ—¶é•¿ï¼Œè®¡ç®—æœ‰æ•ˆæ‰§è¡Œæ—¶é—´

### 3. ä»»åŠ¡åœæ­¢ (â¹ï¸ Stop)
- **åŠŸèƒ½æè¿°**: å®Œå…¨ç»ˆæ­¢æ­£åœ¨æ‰§è¡Œçš„åˆ†æä»»åŠ¡
- **åº”ç”¨åœºæ™¯**:
  - ä¸å†éœ€è¦åˆ†æç»“æœ
  - å‘ç°åˆ†æå‚æ•°é”™è¯¯
  - éœ€è¦é‡Šæ”¾èµ„æºæ‰§è¡Œå…¶ä»–ä»»åŠ¡
- **æŠ€æœ¯å®ç°**: è®¾ç½®åœæ­¢æ ‡å¿—ï¼Œä»»åŠ¡æ£€æµ‹åä¼˜é›…é€€å‡º
- **èµ„æºæ¸…ç†**: è‡ªåŠ¨æ¸…ç†çº¿ç¨‹ã€ä»»åŠ¡æ§åˆ¶çŠ¶æ€å’Œä¸´æ—¶æ•°æ®

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

#### 1. TaskControlManager (ä»»åŠ¡æ§åˆ¶ç®¡ç†å™¨)
- **æ–‡ä»¶ä½ç½®**: `web/utils/task_control_manager.py`
- **ä¸»è¦èŒè´£**:
  - ç®¡ç†ä»»åŠ¡çš„æš‚åœ/æ¢å¤/åœæ­¢çŠ¶æ€
  - ç»´æŠ¤ä»»åŠ¡æ§åˆ¶äº‹ä»¶ (threading.Event)
  - ä¿å­˜å’ŒåŠ è½½ä»»åŠ¡æ£€æŸ¥ç‚¹
  - æŒä¹…åŒ–ä»»åŠ¡çŠ¶æ€åˆ°æ–‡ä»¶

- **å…³é”®æ–¹æ³•**:
  ```python
  register_task(analysis_id)      # æ³¨å†Œä»»åŠ¡
  pause_task(analysis_id)          # æš‚åœä»»åŠ¡
  resume_task(analysis_id)         # æ¢å¤ä»»åŠ¡
  stop_task(analysis_id)           # åœæ­¢ä»»åŠ¡
  should_pause(analysis_id)        # æ£€æŸ¥æ˜¯å¦åº”è¯¥æš‚åœ
  should_stop(analysis_id)         # æ£€æŸ¥æ˜¯å¦åº”è¯¥åœæ­¢
  wait_if_paused(analysis_id)      # å¦‚æœæš‚åœåˆ™ç­‰å¾…
  ```

#### 2. ThreadTracker (çº¿ç¨‹è·Ÿè¸ªå™¨)
- **æ–‡ä»¶ä½ç½®**: `web/utils/thread_tracker.py`
- **å¢å¼ºåŠŸèƒ½**:
  - æ³¨å†Œåˆ†æçº¿ç¨‹å’Œåœæ­¢äº‹ä»¶
  - è·Ÿè¸ªçº¿ç¨‹å­˜æ´»çŠ¶æ€
  - æ”¯æŒçº¿ç¨‹åœæ­¢è¯·æ±‚
  - æä¾›çº¿ç¨‹ä¿¡æ¯æŸ¥è¯¢

- **å…³é”®æ”¹è¿›**:
  ```python
  # æ”¯æŒåœæ­¢äº‹ä»¶æ³¨å†Œ
  register_analysis_thread(analysis_id, thread, stop_event)
  
  # è¯·æ±‚åœæ­¢çº¿ç¨‹
  request_stop_thread(analysis_id)
  
  # æ£€æŸ¥åˆ†æçŠ¶æ€ï¼ˆåŒ…å«æš‚åœ/åœæ­¢çŠ¶æ€ï¼‰
  check_analysis_status(analysis_id)  # è¿”å›: running/paused/stopped/completed/failed
  ```

#### 3. AsyncProgressTracker (å¼‚æ­¥è¿›åº¦è·Ÿè¸ªå™¨)
- **æ–‡ä»¶ä½ç½®**: `web/utils/async_progress_tracker.py`
- **æ–°å¢åŠŸèƒ½**:
  - æ”¯æŒæš‚åœ/æ¢å¤/åœæ­¢çŠ¶æ€æ ‡è®°
  - è®¡ç®—æœ‰æ•ˆæ‰§è¡Œæ—¶é—´ï¼ˆæ’é™¤æš‚åœæ—¶é•¿ï¼‰
  - æŒä¹…åŒ–æ§åˆ¶çŠ¶æ€

- **æ–°å¢æ–¹æ³•**:
  ```python
  mark_paused()                    # æ ‡è®°ä»»åŠ¡æš‚åœ
  mark_resumed()                   # æ ‡è®°ä»»åŠ¡æ¢å¤
  mark_stopped(message)            # æ ‡è®°ä»»åŠ¡åœæ­¢
  get_effective_elapsed_time()     # è·å–æœ‰æ•ˆæ‰§è¡Œæ—¶é—´
  ```

- **æ—¶é—´ç»Ÿè®¡**:
  - `total_pause_duration`: ç´¯è®¡æš‚åœæ—¶é•¿
  - `pause_start_time`: å½“å‰æš‚åœå¼€å§‹æ—¶é—´
  - `effective_time = total_time - pause_duration`: æœ‰æ•ˆæ‰§è¡Œæ—¶é—´

#### 4. LangGraph Checkpointer (æ£€æŸ¥ç‚¹æ”¯æŒ)
- **æ–‡ä»¶ä½ç½®**: `tradingagents/graph/setup.py`
- **åŠŸèƒ½**: 
  - é›†æˆ LangGraph MemorySaver æ£€æŸ¥ç‚¹æœºåˆ¶
  - æ”¯æŒå·¥ä½œæµçŠ¶æ€å¿«ç…§
  - ä¸ºæœªæ¥çš„æ–­ç‚¹ç»­ä¼ åŠŸèƒ½é¢„ç•™æ¥å£

- **é…ç½®å¯ç”¨**:
  ```python
  config = {
      "enable_checkpointer": True,  # å¯ç”¨æ£€æŸ¥ç‚¹
      ...
  }
  ```

### æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ (UIæŒ‰é’®)
    â†“
TaskControlManager (è®¾ç½®æ§åˆ¶æ ‡å¿—)
    â†“
analysis_runner.py (æ£€æŸ¥æ§åˆ¶ä¿¡å·)
    â†“
check_task_control() (æ£€æŸ¥æš‚åœ/åœæ­¢)
    â†“
wait_if_paused() (å¦‚æœæš‚åœåˆ™ç­‰å¾…)
    â†“
ç»§ç»­æ‰§è¡Œ / åœæ­¢ä»»åŠ¡
    â†“
AsyncProgressTracker (æ›´æ–°çŠ¶æ€å’Œæ—¶é—´)
    â†“
UIæ˜¾ç¤ºæ›´æ–°
```

## ğŸ–¥ï¸ ç”¨æˆ·ç•Œé¢

### ä»»åŠ¡æ§åˆ¶æŒ‰é’®

åœ¨Webç•Œé¢çš„"è‚¡ç¥¨åˆ†æ"åŒºåŸŸï¼Œæ ¹æ®ä»»åŠ¡çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ§åˆ¶æŒ‰é’®ï¼š

#### è¿è¡Œä¸­çŠ¶æ€ (Running)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â¸ï¸ æš‚åœ        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â¹ï¸ åœæ­¢        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æš‚åœçŠ¶æ€ (Paused)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–¶ï¸ ç»§ç»­        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â¹ï¸ åœæ­¢        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®Œæˆ/å¤±è´¥/åœæ­¢çŠ¶æ€
- ä¸æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®

### çŠ¶æ€æ˜¾ç¤º

- ğŸ”„ **æ­£åœ¨åˆ†æ**: ä»»åŠ¡è¿è¡Œä¸­
- â¸ï¸ **åˆ†æå·²æš‚åœ**: ä»»åŠ¡å·²æš‚åœ
- â¹ï¸ **åˆ†æå·²åœæ­¢**: ä»»åŠ¡å·²åœæ­¢
- âœ… **åˆ†æå®Œæˆ**: ä»»åŠ¡æˆåŠŸå®Œæˆ
- âŒ **åˆ†æå¤±è´¥**: ä»»åŠ¡æ‰§è¡Œå¤±è´¥

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. å¯åŠ¨åˆ†æä»»åŠ¡
```python
# ä»»åŠ¡è‡ªåŠ¨æ³¨å†Œæ§åˆ¶ç®¡ç†å™¨
from tradingagents.utils.task_control_manager import register_task
register_task(analysis_id)
```

### 2. æš‚åœæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
```python
from tradingagents.utils.task_control_manager import pause_task

if pause_task(analysis_id):
    print("ä»»åŠ¡å·²æš‚åœ")
```

### 3. æ¢å¤æš‚åœçš„ä»»åŠ¡
```python
from tradingagents.utils.task_control_manager import resume_task

if resume_task(analysis_id):
    print("ä»»åŠ¡å·²æ¢å¤")
```

### 4. åœæ­¢ä»»åŠ¡
```python
from tradingagents.utils.task_control_manager import stop_task

if stop_task(analysis_id):
    print("ä»»åŠ¡å·²åœæ­¢")
```

### 5. åœ¨åˆ†æä»£ç ä¸­æ£€æŸ¥æ§åˆ¶ä¿¡å·
```python
from tradingagents.utils.task_control_manager import should_stop, wait_if_paused

# åœ¨åˆ†æå¾ªç¯ä¸­
for step in analysis_steps:
    # æ£€æŸ¥å¹¶ç­‰å¾…æš‚åœ
    wait_if_paused(analysis_id)
    
    # æ£€æŸ¥åœæ­¢ä¿¡å·
    if should_stop(analysis_id):
        print("æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œé€€å‡ºåˆ†æ")
        break
    
    # æ‰§è¡Œåˆ†ææ­¥éª¤
    perform_analysis_step(step)
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### çº¿ç¨‹å®‰å…¨

æ‰€æœ‰ä»»åŠ¡æ§åˆ¶æ“ä½œéƒ½ä½¿ç”¨çº¿ç¨‹é” (`threading.Lock`) ä¿æŠ¤ï¼š
```python
with self._lock:
    self._control_events[analysis_id].set()
    self._task_states[analysis_id] = 'stopped'
```

### çŠ¶æ€æŒä¹…åŒ–

ä»»åŠ¡çŠ¶æ€è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿï¼š
```python
# æ£€æŸ¥ç‚¹ç›®å½•
./data/checkpoints/
    â”œâ”€â”€ checkpoint_{analysis_id}.json  # åˆ†ææ£€æŸ¥ç‚¹
    â””â”€â”€ state_{analysis_id}.json       # ä»»åŠ¡çŠ¶æ€
```

### æ—¶é—´ç»Ÿè®¡é€»è¾‘

```python
# æ€»æ—¶é•¿
total_time = current_time - start_time

# å½“å‰æš‚åœæ—¶é•¿ï¼ˆå¦‚æœæ­£åœ¨æš‚åœï¼‰
current_pause = current_time - pause_start_time if paused else 0

# æœ‰æ•ˆæ—¶é•¿
effective_time = total_time - total_pause_duration - current_pause
```

## âš¡ æ€§èƒ½è€ƒè™‘

### 1. æ£€æŸ¥ç‚¹é¢‘ç‡
- å»ºè®®åœ¨å…³é”®æ­¥éª¤ä¿å­˜æ£€æŸ¥ç‚¹
- é¿å…è¿‡äºé¢‘ç¹çš„æ£€æŸ¥ç‚¹ä¿å­˜å½±å“æ€§èƒ½

### 2. æ§åˆ¶ä¿¡å·æ£€æŸ¥
- åœ¨åˆ†æå¾ªç¯çš„åˆé€‚ä½ç½®æ£€æŸ¥æ§åˆ¶ä¿¡å·
- æ¨èåœ¨æ¯ä¸ªä¸»è¦æ­¥éª¤å¼€å§‹å‰æ£€æŸ¥
- é¿å…åœ¨ç´§å¯†å¾ªç¯ä¸­é¢‘ç¹æ£€æŸ¥

### 3. èµ„æºæ¸…ç†
- ä»»åŠ¡å®Œæˆ/åœæ­¢åè‡ªåŠ¨æ¸…ç†èµ„æº
- å®šæœŸæ¸…ç†æ—§çš„æ£€æŸ¥ç‚¹æ–‡ä»¶ï¼ˆé»˜è®¤24å°æ—¶ï¼‰

```python
# è‡ªåŠ¨æ¸…ç†
task_control_manager.cleanup_old_checkpoints(max_age_hours=24)
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•
```bash
python tests/test_task_control.py
```

### æµ‹è¯•è¦†ç›–
- âœ… ä»»åŠ¡æ³¨å†Œå’ŒçŠ¶æ€ç®¡ç†
- âœ… ä»»åŠ¡æš‚åœåŠŸèƒ½
- âœ… ä»»åŠ¡æ¢å¤åŠŸèƒ½
- âœ… ä»»åŠ¡åœæ­¢åŠŸèƒ½
- âœ… æš‚åœæ—¶é•¿ç»Ÿè®¡
- âœ… æœ‰æ•ˆæ—¶é—´è®¡ç®—
- âœ… æ£€æŸ¥ç‚¹ä¿å­˜å’ŒåŠ è½½
- âœ… çº¿ç¨‹æ§åˆ¶é›†æˆ

### æµ‹è¯•ç»“æœ
æ‰€æœ‰æµ‹è¯•å‡å·²é€šè¿‡ï¼ŒéªŒè¯äº†åŠŸèƒ½çš„å®Œæ•´æ€§å’Œç¨³å®šæ€§ã€‚

## ğŸ“Š çŠ¶æ€æµè½¬å›¾

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  åˆ›å»º   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚
             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”Œâ”€â”€â–¶â”‚ Running â”‚â—€â”€â”€â”
    â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚
    â”‚        â”‚         â”‚
    â”‚resume  â”‚pause    â”‚
    â”‚        â–¼         â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â””â”€â”€â”€â”‚ Paused  â”‚â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚stop
             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Stopped â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚Completedâ”‚ (è‡ªç„¶å®Œæˆ)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Failed  â”‚ (å¼‚å¸¸å¤±è´¥)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” å®‰å…¨æ€§

### 1. æƒé™æ§åˆ¶
- ç›®å‰æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥æ§åˆ¶ä»»åŠ¡
- æœªæ¥å¯æ·»åŠ ç”¨æˆ·æƒé™éªŒè¯

### 2. çŠ¶æ€éªŒè¯
- åœæ­¢çš„ä»»åŠ¡æ— æ³•æš‚åœæˆ–æ¢å¤
- æœªæ³¨å†Œçš„ä»»åŠ¡æ— æ³•æ§åˆ¶

### 3. èµ„æºä¿æŠ¤
- è‡ªåŠ¨æ¸…ç†å·²ç»ˆæ­¢çš„ä»»åŠ¡èµ„æº
- é˜²æ­¢èµ„æºæ³„æ¼

## ğŸš€ æœªæ¥æ”¹è¿›

### çŸ­æœŸè®¡åˆ’
- [ ] æ·»åŠ ä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†
- [ ] æ”¯æŒæ‰¹é‡ä»»åŠ¡æ§åˆ¶
- [ ] å¢å¼ºæ£€æŸ¥ç‚¹åŠŸèƒ½ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰

### é•¿æœŸè®¡åˆ’
- [ ] åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦
- [ ] ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
- [ ] æ›´ç»†ç²’åº¦çš„è¿›åº¦æ§åˆ¶

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [AsyncProgressTracker ä½¿ç”¨æŒ‡å—](../technical/async_progress_tracker.md)
- [ThreadTracker æ–‡æ¡£](../technical/thread_tracker.md)
- [LangGraph é›†æˆè¯´æ˜](../architecture/langgraph_integration.md)

## ğŸ¤ è´¡çŒ®

å¦‚éœ€æ”¹è¿›ä»»åŠ¡æ§åˆ¶åŠŸèƒ½ï¼Œè¯·ï¼š
1. åˆ›å»ºfeatureåˆ†æ”¯
2. æ·»åŠ ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹
3. æ›´æ–°æœ¬æ–‡æ¡£
4. æäº¤Pull Request

## ğŸ“ æ”¯æŒ

å¦‚é‡åˆ°ä»»åŠ¡æ§åˆ¶ç›¸å…³é—®é¢˜ï¼Œè¯·ï¼š
- æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ä¸­çš„ `[ä»»åŠ¡æ§åˆ¶]` æ ‡è®°
- è¿è¡Œæµ‹è¯•è„šæœ¬ `tests/test_task_control.py`
- æ£€æŸ¥ `./data/checkpoints/` ç›®å½•ä¸‹çš„çŠ¶æ€æ–‡ä»¶

---

**ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-10-28  
**ä½œè€…**: TradingAgents Team

