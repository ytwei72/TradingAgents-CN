## 批量回测功能需求说明

### 1. 功能目标概述

在选定的「研究分析日期区间」内，批量获取所有符合条件的研报 `formatted_decision`，支持用户多选若干研报进行统一回测。  
对每一篇被选中的研报，根据预设的历史数据区间和买卖逻辑，计算 1–N 天（暂定 N=100，自然日或交易日统一由后端定义）的模拟收益序列，并对多篇研报的收益序列做加权平均，输出当前策略在该时间维度上的平均收益表现，并以图表和表格形式展示。

---

### 2. 数据来源与新增后端接口

#### 2.1 在指定分析日期区间内获取所有报告的 `formatted_decision`

**用途**：为批量回测提供候选研报列表，包含每篇研报的关键元数据与 `formatted_decision` 字段。  
**建议在 reports 相关模块中新开接口**：

- **接口路径（示例）**：`GET /reports/formatted-decisions`
- **请求参数（Query）**：
  - `start_date`: string，必填，形如 `2024-01-01`
  - `end_date`: string，必填，形如 `2024-01-31`
  - 可选过滤项（如有需要）：
    - `stock_code`: string，按股票代码筛选
    - `action`: string，按决策类型筛选，如 `buy` / `hold` / `sell`
    - `analyst`: string，按分析师筛选

- **返回结构（示例）**：

  ```ts
  interface FormattedDecisionItem {
    analysis_id: string;
    stock_symbol: string;
    analysis_date: string;       // 分析日期
    formatted_decision: {
      action: 'buy' | 'hold' | 'sell';
      confidence?: number;
      target_price?: number;
      risk_score?: number;
      // 如有需要，可扩展字段，例如：
      // weight?: number;  // 单篇研报的权重（可选，用于后续加权）
    };
    summary?: string;
  }

  interface FormattedDecisionsResponse {
    success: boolean;
    data: FormattedDecisionItem[];
    total: number;
    message: string;
  }
  ```

- **前端 `frontend/src/api/index.ts` 中对应方法建议**：

  ```ts
  export interface FormattedDecisionItem { /* 同上 */ }

  export interface FormattedDecisionsResponse { /* 同上 */ }

  export const getFormattedDecisions = async (
    startDate: string,
    endDate: string
  ): Promise<FormattedDecisionsResponse> => {
    const params = new URLSearchParams({
      start_date: startDate,
      end_date: endDate
    });
    const res = await api.get<FormattedDecisionsResponse>(
      `/reports/formatted-decisions?${params.toString()}`
    );
    return res.data;
  };
  ```

前端在用户选定「研究分析时间段」后，通过该接口拉取对应日期区间内的候选研报列表，用于后续多选与回测。

---

### 3. 单篇研报股票历史数据区间

**规则**：  
对每一篇研报，对应的股票历史数据区间为：

- 起始时间：分析日期前 1 个月（按自然日向前推 30 天）
- 结束时间：分析日期后 6 个月（按自然日向后推约 180 天）

记：

- 分析日期为 \( D_0 \)
- 历史数据起始日期 \( D_{start} = D_0 - 30 \) 天
- 历史数据结束日期 \( D_{end} = D_0 + 180 \) 天

**实现建议**：

- 后端统一在批量回测任务中，根据每篇研报的 `stock_symbol`、`analysis_date` 计算 `D_start` 和 `D_end`，并从数据库中一次性获取该区间内的历史行情数据（包括开盘价、收盘价、最高价、最低价、成交量等）。
- 不建议前端循环调用单只股票历史数据接口来计算，以避免前端请求风暴和高延迟。  
  即：**历史数据获取与收益计算统一放在后端完成**，前端只消费回测结果。

---

### 4. 买入/持有研报的收益计算逻辑

当 `formatted_decision.action` 为「买入」或「持有」时，采用「买入→卖出」顺序进行模拟：

#### 4.1 买入点价格

- 买入时点：分析日期当日。
- 买入价格 \( P_{\text{buy}} \)：  
  取分析日期当日的 **收盘价**：

  \[
  P_{\text{buy}} = \text{close\_price}(stock,\ D_0)
  \]

- 交易日非交易日处理规则（建议统一约定一种）：
  - 若 \( D_0 \) 为非交易日，可选：
    - 方案 A：取最近的 **下一个交易日** 收盘价；
    - 方案 B：取最近的 **前一个交易日** 收盘价。  
  - 推荐统一使用 **方案 A（下一个交易日）**，以利于模拟「下一次可交易时点」的买入。

#### 4.2 买入后 1–90 天收益（按交易日开盘价成交）

- 对每篇研报 \( i \)，在买入后，分别计算第 \( d \) 天（\( d = 1 \dots 90 \)）的收益率。
- 这里的「天」可有两种定义方式（需在实现时统一）：
  - 方式 1：自然日，\( D_d = D_0 + d \) 天，然后映射到最近的交易日；
  - 方式 2：直接定义为第 \( d \) 个 **交易日**。

下面以「自然日 + 最近交易日」为例：

1. 计算目标自然日：\( D_d = D_0 + d \) 天；
2. 使用函数 `nearest_trade_day(D_d)` 映射为最近的交易日（可约定向后取最近交易日）；
3. 获取该交易日开盘价 \( P_{\text{sell}, d} = \text{open\_price}(stock,\ \text{nearest\_trade\_day}(D_d)) \)；
4. 模拟持有到第 \( d \) 天开盘价卖出，收益率：

   \[
   r_{i,d} = \frac{P_{\text{sell}, d} - P_{\text{buy}}}{P_{\text{buy}}}
   \]

后端伪代码示意：

```python
for report in selected_reports:
    stock = report.stock_symbol
    D0 = report.analysis_date
    P_buy = close_price(stock, trade_day_for(D0))

    for d in range(1, 91):  # 1..90
        Dd = D0 + d days
        trade_day = nearest_trade_day(Dd)
        P_sell = open_price(stock, trade_day)
        r[report.id][d] = (P_sell - P_buy) / P_buy
```

---

### 5. 卖出研报的收益计算逻辑（止损/止盈）

当 `formatted_decision.action` 为「卖出」时，采用「卖出→买入」顺序来计算模拟收益，体现「提前平仓、避免未来风险」或「卖早错过收益」的效果。

#### 5.1 卖出点价格

- 卖出时点：分析日期当日。
- 卖出价格 \( P_{\text{sell}} \)：  
  同样取分析日期当日（或最近交易日）的 **收盘价**：

  \[
  P_{\text{sell}} = \text{close\_price}(stock,\ D_0)
  \]

#### 5.2 卖出后的模拟收益计算

- 对每篇卖出研报 \( i \)，在卖出后的第 \( d \) 天 \( (d = 1\dots 90) \)，模拟「如果当时没有卖出，而是在第 \( d \) 天以开盘价卖出」时的结果：
  - 目标日期：\( D_d = D_0 + d \)；
  - 对应交易日：`nearest_trade_day(D_d)`；
  - 假设在该交易日开盘价 \( P_{\text{buy}, d} \) 才进行卖出（或理解为**未卖出而继续持有**，对比当前的提前卖出）。

- 模拟收益（止损/止盈）可定义为：

  \[
  r_{i,d} = \frac{P_{\text{sell}} - P_{\text{buy}, d}}{P_{\text{buy}, d}}
  \]

- 解读：
  - 若股价之后下跌（\( P_{\text{buy}, d} < P_{\text{sell}} \)），则 \( r_{i,d} > 0 \)，表示提前卖出是正确的，**避免了亏损**；
  - 若股价之后上涨（\( P_{\text{buy}, d} > P_{\text{sell}} \)），则 \( r_{i,d} < 0 \)，表示卖得太早，**错过了收益**。

同样可用类似的伪代码计算。

---

### 6. 多篇研报收益序列的加权平均

在完成对每篇选中研报的收益序列计算后，得到：

- 对第 \( i \) 篇研报，收益序列为：

  \[
  r_{i,1}, r_{i,2}, \dots, r_{i,N}
  \]

其中 \( N \) 暂定为 100（可配置），表示从分析日起往后第 1～100 天的收益表现。

#### 6.1 权重设定

可支持两类权重模式：

- **等权模式**：

  - 所有研报权重 \( w_i = 1 \)

- **置信度加权模式**（如使用 `formatted_decision.confidence`）：

  - 令：

    \[
    w_i = \text{confidence}_i
    \]

  - 归一化后：

    \[
    \tilde{w}_i = \frac{w_i}{\sum_j w_j}
    \]

如业务上有其他维度（如风险评分、研究深度等），也可以在后续扩展权重计算逻辑。

#### 6.2 加权平均收益序列计算

对每一个天数 \( d = 1 \dots N \)，定义策略平均收益率 \( R_d \) 为：

\[
R_d = \sum_i \tilde{w}_i \cdot r_{i,d}
\]

注意事项：

- 若某篇研报在某些天数上缺少价格数据（例如超出该股票历史记录范围），可选处理策略：
  - 仅在有数据的研报之间做平均；
  - 或视为价格不变（收益率维持最近一次可用值）。  
  建议在实现时选择一种清晰的规则，并在代码注释中说明。

最终得到长度为 \( N \) 的 **平均收益序列**：

\[
\{ R_1, R_2, \dots, R_N \}
\]

---

### 7. 后端批量回测接口设计

#### 7.1 回测配置管理

回测配置存储在 MongoDB 的 `dict_settings` 集合中，通过 `SystemConfigManager` 进行读写管理。

- **配置字段**：`backtest_config`，包含以下键值：
  - `backtest_start_date`: string，回测历史数据起始日期
  - `backtest_end_date`: string，回测历史数据结束日期
  - `horizon_days`: int，回测期限（天）
  - `extend_days_before`: int，分析日前向前扩展的历史天数
  - `extend_days_after`: int，分析日后向后扩展的历史天数
  - `weight_mode`: string，加权模式（"equal" 或 "confidence"）
  - `date_mode`: string，日期模式（"calendar_day" 或 "trading_day"）

- **配置读写接口**：
  - `SystemConfigManager.load_backtest_config()`: 读取回测配置
  - `SystemConfigManager.save_backtest_config(config)`: 保存回测配置

#### 7.2 批量回测接口

为统一封装上述计算逻辑，新增批量回测接口：

- **接口路径**：`POST /backtest/batch/start-backtest`

- **请求体（JSON 示例）**：

  ```json
  {
    "analysis_ids": ["id1", "id2", "id3"]
  }
  ```

  **说明**：回测配置参数（`horizon_days`、`extend_days_before`、`extend_days_after`、`weight_mode`、`date_mode`）从数据库的 `backtest_config` 中获取，不再通过请求参数传递。

- **接口内部处理流程**：
  1. 从数据库读取回测配置（`SystemConfigManager.load_backtest_config()`）
  2. 根据 `analysis_ids` 从 `analysis_reports` 集合读取对应研报的：
     - `analysis_id`
     - `analysis_date`
     - `stock_symbol`
     - `formatted_decision`
     - 从 `stock_dict` 集合获取股票代码对应的公司名称
  3. 对每篇研报：
     - 根据分析日期计算历史数据区间：  
       \( D_{start} = D_0 - \text{extend\_days\_before} \)，  
       \( D_{end} = D_0 + \text{extend\_days\_after} \)；
     - 从数据库中获取该股票在 \([D_{start}, D_{end}]\) 区间内的全部历史行情数据；
     - 以 `analysis_date` 为起始交易日进行起始操作（买入或卖出）；
     - 第二个交易日到第 n 个交易日进行结束操作（卖出或买入）；
     - 计算每个结束操作的收益（%），作为一个序列（List）。
     - **决定操作顺序的方式**：
       - 如果 `formatted_decision.action` 是买入或持有，按融资模式，进行"先买入--后卖出"
       - 如果 `formatted_decision.action` 是卖出，按融券模式，进行"先卖出--后买入"
     - **计算收益的方式**：
       - 融资模式：\( r = \frac{P_{\text{sell}} - P_{\text{buy}}}{P_{\text{buy}}} \)
       - 融券模式：\( r = \frac{P_{\text{buy}} - P_{\text{sell}}}{P_{\text{buy}}} \)
  4. 根据 `weight_mode` 计算各研报权重 \( \tilde{w}_i \)，并按第 6 节的公式得到平均收益序列 \( R_d \)。
  5. 组装返回结果。

- **返回结构**：

  ```ts
  interface SingleReportProfit {
    analysis_id: string;
    stock_symbol: string;
    company_name: string;      // 公司名称（从stock_dict获取）
    analysis_date: string;
    action: 'buy' | 'hold' | 'sell';
    profits: number[];          // 收益序列（%），每个元素对应第1天到第N天的收益
  }

  interface BatchBacktestResult {
    success: boolean;
    data: {
      profits: SingleReportProfit[];  // 每个研报的收益序列
      stats: {
        weighted_avg: number[];       // 加权平均收益序列
      };
    };
    message: string;
  }
  ```

---

### 8. 前端页面（`BatchBacktest.vue`）交互与展示需求

#### 8.1 时间区间与研报筛选

- 已有组件：`研究分析时间段` 与 `回测历史数据时间段` 的时间选择器。
  - **研究分析时间段**：用于调用 `GET /reports/formatted-decisions` 获取候选研报；
  - **回测历史数据时间段**：可选作为额外限制或展示（当前方案中核心历史数据区间由后端按每篇研报自动计算）。

- 新增交互：
  - 「查询研报」按钮：在用户设置好研究分析时间段后，点击按钮请求 `getFormattedDecisions`；
  - 将返回的 `FormattedDecisionItem[]` 展示在一个可多选的表格中。

**（已实现补充说明）**

- 实际页面中，上述「查询研报」以「加载候选研报」按钮形式存在，点击后：
  - 使用 `getFormattedDecisions(researchStart, researchEnd)` 请求后端；
  - 将返回的 `data` 数组赋给 `reports: FormattedDecisionItem[]`；
  - 同时重置 `selectedAnalysisIds` 与 `backtestResult`，避免旧结果干扰新一次回测。
- 回测参数区提供：
  - `horizonDays: number`（默认 90，1~100）；
  - `weightMode: 'equal' | 'confidence'`，映射到后端 `weight_mode`。

#### 8.2 研报多选与回测参数配置

- 表格列（建议）：
  - 勾选框
  - `analysis_date`
  - `stock_symbol`
  - `formatted_decision.action`
  - `formatted_decision.confidence`
  - `summary`（简要摘要）

- 状态：
  - `selectedAnalysisIds: string[]`，存放当前选中的研报 ID；
  - 允许用户配置：
    - `horizon_days`（默认 90，可放在表单中）；
    - `weight_mode`（等权 / 置信度加权等）。

**（已实现补充说明）**

- 实际实现的核心状态：
  - `reports: FormattedDecisionItem[]`：候选研报列表；
  - `selectedAnalysisIds: string[]`：当前被选中用于回测的研报 ID；
  - `loadingReports: boolean`：候选研报加载中的状态；
  - `isAllSelected` / `isIndeterminate`：控制表头全选复选框的样式和状态。
- 列表行与复选框交互：
  - 点击行或复选框均会调用 `toggleSelect(analysis_id)` 切换选中状态；
  - 点击表头复选框或「全选/清空选择」按钮调用 `toggleSelectAll()`，在「全选全部研报」与「清空选择」之间切换。

- 「启动回测任务」按钮行为：
  - 校验：至少选择一条研报，且 `horizon_days` 等参数有效；
  - 调用 `POST /backtest/batch`，传入：
    - `analysis_ids = selectedAnalysisIds`
    - `horizon_days`
    - `extend_days_before = 30`
    - `extend_days_after = 180`
    - 其他可选参数（权重模式、日期模式等）。

#### 8.3 回测结果的图表与表格展示

- 接口返回的 `BatchBacktestResult` 存入前端状态，例如：
  - `backtestResult`（包括 `average_returns` 与 `report_results`）。

- **图表展示**（示例需求）：
  - 折线图 X 轴：`day`（1..N）；
  - 折线图 Y 轴：平均收益率 `avg_return_pct`；
  - 可选：支持在图例中勾选若干单篇研报，在同一张图上叠加其收益曲线（便于对比）。

- **表格展示**（示例需求）：
  1. **平均收益表**：
     - 行：`day`（1..N）
     - 列：`avg_return_pct`，可额外显示「累计收益率」等衍生指标；
  2. **单篇研报摘要表**：
     - 合计各研报在关键时间点（如第 1、5、10、30、60、90 天）的收益；
     - 支持按某个时间点收益排序，方便定位表现最好的 / 最差的研报。

**（已实现补充说明）**

- 平均收益曲线图：
  - 使用 `vue-chartjs` + `chart.js` 绘制一条平均收益折线图：

    ```ts
    const averageChartData = computed(() => {
      if (!backtestResult.value) return null
      const labels = backtestResult.value.data.average_returns.map(r => `第 ${r.day} 天`)
      const values = backtestResult.value.data.average_returns.map(r => r.avg_return_pct * 100)
      return {
        labels,
        datasets: [{
          label: '平均收益(%)',
          data: values,
          borderColor: 'rgb(34, 197, 94)',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          fill: true,
          tension: 0.2,
          pointRadius: 2
        }]
      }
    })
    ```

- 统计与表格：
  - 从 `backtestResult.data.average_returns` 中直接计算第 1 天和第 N 天的平均收益，作为右侧统计卡片展示；
  - 从 `backtestResult.data.report_results` 中截取前若干条（如 5 条）作为示例研报，展示其在 D1/D5/D10/D30 的收益率；
  - 平均收益明细表按天逐行展示 `avg_return_pct`，并用绿色/红色区分正负。

---

### 9. 可配置与扩展点

为后续扩展方便，建议将以下参数抽象为可配置项或接口参数：

- 历史数据的前后延伸天数：
  - `extend_days_before`（默认 30）
  - `extend_days_after`（默认 180）
- 回测期限：
  - `horizon_days`（默认 90，上限 100 或以上）
- 权重模式：
  - 等权、置信度加权、复合权重等
- 日期模式：
  - 自然日模式（自然日 + 最近交易日映射）
  - 交易日计数模式（直接按照第 N 个交易日）

这些均可以通过接口参数 + 配置文件控制，前端页面只暴露一部分关键参数给用户，其他作为高级设置或在后台配置。

---

### 10. 小结

- 在 **reports 类接口** 中新增 `GET /reports/formatted-decisions`，用于在指定分析日期区间内获取所有研报的 `formatted_decision` 信息。
- 在 **回测模块** 中新增 `POST /backtest/batch` 接口，后端统一完成：
  - 每篇研报历史行情数据读取；
  - 买入 / 持有 / 卖出情形下的 1–N 天收益序列计算；
  - 多篇研报收益序列的加权平均。
- 前端 `BatchBacktest.vue` 负责：
  - 研究分析日期区间选择；
  - 研报列表加载与多选；
  - 回测参数配置与接口调用；
  - 将返回的平均收益序列和单篇研报结果，以图表与表格形式展示给用户。
