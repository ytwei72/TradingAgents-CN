# 前端开发需求

## 后端接口参考

前端页面涉及到后端服务接口的调用时，需要参考 [app/后端服务接口规范.md](../app/后端服务接口规范.md)。

## 前端功能开发计划

### 状态说明
- ✅ **已完成**
- 📅 **计划中**
- ⏳ **待定**

### 功能列表

#### 1. 分析任务页面 (StockAnalyzeView)

- ✅ **分析任务的页面框架**
  - 描述：搭建股票分析的主界面，包括侧边栏布局、配置面板、分析状态展示区域等基础结构。

- ✅ **WebSocket 机制**
  - 描述：实现前端与后端的 WebSocket 连接管理，支持实时接收后端推送的消息（如任务进度、状态更新）。

- ✅ **任务控制的设计**
  - 描述：实现开始分析、停止分析等任务控制逻辑，与后端 API 进行交互以触发或终止分析流程。

- ✅ **定时刷新的功能**
  - 描述：在 WebSocket 连接之外，提供轮询机制作为备选方案，支持用户开启/关闭定时刷新以获取最新任务状态。

- ⏳ **WebSocket消息响应与任务进度展现**
  - 描述：响应 WebSocket 推送的任务状态消息，实时更新界面上的任务进度展示。

- ✅ **任务历史步骤风琴夹组件**
  - 描述：在任务运行过程展示区域增加一个可展开/收起的风琴夹（Accordion）组件，展开后可查看任务的历史执行步骤。
  - 技术要求：
    - 使用定时轮询方式（每3秒）获取任务状态
    - 调用 `GET /api/analysis/{analysis_id}/history` 接口获取历史步骤数据

- ✅ **任务步骤状态可视化**
  - 描述：每个步骤展示以下信息：
    - 步骤名称
    - 步骤执行状态（正在运行、完成、错误、暂停、停止）
    - 开始时间
    - 当前已用时间
  - 样式要求：
    - 根据运行状态使用不同的背景颜色：
      - 🟢 **正在运行 (running)**：绿色背景
      - 🔵 **完成 (completed)**：蓝色背景
      - 🔴 **错误 (error/failed)**：红色背景
      - 🟡 **暂停 (paused)**：黄色/橙色背景
      - ⚫ **停止 (stopped)**：灰色背景
      - ⬜ **未执行 (pending)**：浅灰色背景，显示"未执行"标识

- ✅ **辩论过程步骤细分**
  - 描述：在辩论过程中，每个角色（bull/bear/trader/risky/safe/neutral/judge等）的每次思考都作为单独的步骤展示
  - 要求：
    - 步骤名称中体现"第n轮"信息（如："第1轮-看多分析师思考"、"第2轮-风险评估师分析"）
    - 不同角色可使用不同的图标或颜色标识

- ✅ **任务计划步骤预览**
  - 描述：在任务启动前/启动时，根据选择的分析师和配置，预先展示整个任务包含的所有步骤
  - 步骤组成（按顺序）：
    1. **准备阶段**（6步）：环境验证、参数验证、数据源初始化、工具初始化、图配置、数据收集
    2. **分析师阶段**：根据选择的分析师动态生成（market_analyst、fundamental_analyst、technical_analyst、news_analyst、social_media_analyst）
    3. **辩论阶段**：研究团队辩论（bull、bear、manager）
    4. **交易决策阶段**：trader
    5. **风险评估阶段**：risky、safe、neutral、judge
    6. **最终报告输出**
  - 样式要求：
    - 未运行的步骤使用浅灰色背景
    - 显示"未执行"标识
    - 当步骤开始执行时，自动切换为对应状态的背景色

#### 2. 任务查询与管理

- ⏳ **任务查询页面的框架**
  - 描述：设计并搭建用于查询历史分析任务的页面框架。

- ⏳ **任务列表的风琴夹模式及组件化封装**
  - 描述：将任务列表设计为手风琴（Accordion）样式，支持展开/收起查看详情，并将该列表封装为可复用的 Vue 组件。

#### 3. 分析报告

- ⏳ **分析结果的报告部分做组件化封装**
  - 描述：将分析生成的报告展示部分（Markdown 渲染、图表等）封装为独立的组件，以便在不同页面或模块中复用。

---

## 后端接口需求分析

### 现有接口（已满足）

| 接口 | 说明 | 状态 |
|------|------|------|
| `GET /api/analysis/{id}/status` | 获取任务状态和进度 | ✅ 可用 |
| `GET /api/analysis/{id}/history` | 获取任务历史步骤 | ✅ 可用 |
| `GET /api/analysis/{id}/current_step` | 获取当前执行步骤 | ✅ 可用 |
| `WS /ws/notifications` | WebSocket 实时消息推送 | ✅ 可用 |

### 需要新增/调整的接口

为满足上述前端开发需求，后端接口需要进行以下调整：

#### 1. 📋 **任务计划步骤接口**（新增）

**接口**: `GET /api/analysis/{analysis_id}/planned_steps`

**功能**: 在任务启动时或启动前，返回该任务预计执行的所有步骤列表

**响应示例**:
```json
{
  "total_steps": 18,
  "steps": [
    {
      "step_index": 1,
      "step_name": "environment_validation",
      "display_name": "环境验证",
      "phase": "preparation",
      "status": "pending"
    },
    {
      "step_index": 7,
      "step_name": "market_analyst",
      "display_name": "市场分析师",
      "phase": "analyst",
      "status": "pending"
    },
    {
      "step_index": 10,
      "step_name": "bull_round_1",
      "display_name": "第1轮-看多分析师",
      "phase": "debate",
      "round": 1,
      "role": "bull",
      "status": "pending"
    }
  ]
}
```

#### 2. 📋 **辩论轮次信息增强**（调整现有接口）

**接口**: `GET /api/analysis/{id}/history` 及 WebSocket 消息

**调整**: 在步骤信息中增加辩论轮次和角色信息

**响应字段增强**:
```json
{
  "step_name": "bull_debate",
  "display_name": "看多分析师辩论",
  "debate_info": {
    "round": 1,
    "role": "bull",
    "role_display": "看多分析师"
  }
}
```

#### 3. 📋 **WebSocket 消息格式增强**（调整现有接口）

**当前格式**: 
```json
{
  "topic": "task/progress",
  "payload": {
    "analysis_id": "...",
    "current_step": 3,
    "current_step_name": "市场分析",
    "message": "..."
  }
}
```

**建议增强**:
```json
{
  "topic": "task/progress",
  "payload": {
    "analysis_id": "...",
    "current_step": 3,
    "total_steps": 18,
    "current_step_name": "market_analyst",
    "display_name": "市场分析师",
    "phase": "analyst",
    "status": "running",
    "start_time": "2025-12-08T10:01:00",
    "elapsed_time": 15.5,
    "message": "正在分析市场趋势...",
    "debate_info": null
  }
}
```

### 接口需求优先级

| 优先级 | 接口需求 | 说明 |
|--------|----------|------|
| P0 | 调整历史步骤接口增加中文显示名称 | 用于步骤列表展示 |
| P1 | 新增任务计划步骤接口 | 用于预览所有计划步骤 |
| P1 | WebSocket消息增强 | 增加阶段、显示名称等字段 |
| P2 | 辩论轮次信息增强 | 支持辩论过程细分展示 |
