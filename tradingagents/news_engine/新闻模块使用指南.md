# TradingAgents 新闻模块指南

模块化新闻数据获取系统,支持A股、港股、美股等多个市场的新闻数据获取。

## 目录

- [快速开始](#快速开始)
- [主要功能](#主要功能)
- [配置说明](#配置说明)
- [使用示例](#使用示例)
- [测试说明](#测试说明)
- [故障排查](#故障排查)
- [架构说明](#架构说明)

---

## 快速开始

### 1. 初始化配置

运行配置初始化脚本,从全局 `.env` 文件生成模块级配置:

```bash
.venv\Scripts\python.exe tradingagents\news\init_config.py
```

这个脚本会:
- ✅ 读取项目根目录的 `.env` 文件
- ✅ 提取新闻相关的 API 密钥
- ✅ 生成 `tradingagents/news/.env` 文件
- ✅ 保留 `.env.example` 的所有内容和注释
- ✅ 只更新 API 密钥值(注释形式)

### 2. 运行基础测试

测试 news 模块的基本功能:

```bash
.venv\Scripts\python.exe tradingagents\news\test_news.py
```

### 3. 基本使用

```python
from tradingagents.news import get_stock_news

# 获取A股新闻
response = get_stock_news("000002", max_news=10)

if response.success:
    for news in response.news_items:
        print(f"{news.title}")
        print(f"  来源: {news.source.value}")
        print(f"  时间: {news.publish_time}")
```

---

## 主要功能

✅ **多市场支持**: A股、港股、美股  
✅ **多数据源**: Tushare, AKShare, FinnHub, EODHD  
✅ **智能聚合**: 自动选择最佳数据源  
✅ **模块化配置**: 支持环境变量配置  
✅ **类型安全**: 完整的类型提示  
✅ **容错设计**: 单个数据源失败不影响整体  
✅ **去重过滤**: 自动去除重复新闻  
✅ **格式化报告**: 支持生成 Markdown 报告  

---

## 配置说明

### 配置初始化脚本 (init_config.py)

#### 功能说明

`init_config.py` 脚本用于初始化 News 模块的配置文件。它会:

1. ✅ **保留** `.env.example` 的所有内容和注释
2. ✅ **读取** 项目根目录 `.env` 中的 API 密钥
3. ✅ **更新** 模块 `.env` 文件中的 API 密钥值
4. ✅ **保持** 所有其他配置项的默认值

#### 工作原理

**步骤 1: 读取 .env.example**

脚本会读取 `tradingagents/news/.env.example` 文件的完整内容,包括:
- 所有注释和说明
- 所有配置项
- 所有默认值

**步骤 2: 读取全局 API 密钥**

从项目根目录的 `.env` 文件中读取以下 API 密钥:
- `NEWSAPI_KEY`
- `ALPHA_VANTAGE_API_KEY`
- `FINNHUB_API_KEY`
- `TUSHARE_TOKEN`
- `EODHD_API_TOKEN`

**步骤 3: 更新 API 密钥行**

只更新 API 密钥相关的行,格式为:
```bash
# API_KEY=actual_value_from_global_env
```

**注意**: API 密钥行会被注释掉,因为模块会自动从全局 `.env` 继承这些值。

**步骤 4: 生成 .env 文件**

将更新后的内容写入 `tradingagents/news/.env` 文件。

#### 使用方法

```bash
.venv\Scripts\python.exe tradingagents\news\init_config.py
```

如果 `.env` 文件已存在,脚本会询问是否覆盖:
```
⚠️  模块 .env 文件已存在: tradingagents\news\.env
是否覆盖? (y/N):
```

输入 `y` 或 `yes` 确认覆盖,其他输入则取消操作。

### API 密钥继承

News 模块会自动从全局 `.env` 继承以下 API 密钥:

- `FINNHUB_API_KEY` - FinnHub API 密钥
- `TUSHARE_TOKEN` - Tushare Token
- `EODHD_API_TOKEN` - EODHD API Token

如果需要覆盖全局配置,在模块 `.env` 中取消注释并修改相应行。

### 数据源配置

根据您配置的 API 密钥,以下数据源会自动启用:

| 数据源 | 需要 API 密钥 | 适用市场 | 默认状态 |
|--------|--------------|----------|----------|
| AKShare | 无 | A股 | ✅ 启用 |
|   - 财联社 | 无 | A股 | ✅ 启用 |
|   - 新浪财经 | 无 | A股 | ✅ 启用 |
|   - 东方财富 | 无 | A股 | ❌ 禁用 |
| Tushare | TUSHARE_TOKEN | A股 | 根据全局配置 |
| FinnHub | FINNHUB_API_KEY | 美股 | 根据 API 密钥 |
| EODHD | EODHD_API_TOKEN | 港股/美股 | 根据 API 密钥 |
| NewsAPI | NEWSAPI_KEY | 全球 | ❌ 禁用 |
| Alpha Vantage | ALPHA_VANTAGE_API_KEY | 全球 | ❌ 禁用 |

### 推荐配置

**A股用户(免费方案)**:
```bash
NEWS_AKSHARE_ENABLED=true
NEWS_TUSHARE_ENABLED=true  # 需要注册 Tushare
```

**全球市场用户**:
```bash
NEWS_AKSHARE_ENABLED=true      # A股
NEWS_FINNHUB_ENABLED=true      # 美股
NEWS_EODHD_ENABLED=true        # 港股
```

**AkShare 细分配置**:
```bash
NEWS_AKSHARE_CLS_ENABLED=true      # 财联社 (实时电报)
NEWS_AKSHARE_SINA_ENABLED=true     # 新浪财经 (全球快讯)
NEWS_AKSHARE_EM_ENABLED=false      # 东方财富 (详细报道)
```

### 配置优先级

1. **模块 .env 中取消注释的配置** (最高优先级)
2. **全局 .env 中的配置**
3. **模块 .env 中注释掉的配置** (仅作参考)
4. **代码中的默认值** (最低优先级)

### 如何覆盖全局配置

如果需要在模块中使用不同的 API 密钥,只需:

1. 编辑 `tradingagents/news/.env`
2. 找到对应的 API 密钥行
3. 取消注释并修改值

例如:
```bash
# 原来(注释掉,使用全局配置):
# FINNHUB_API_KEY=cqj0rvpr01qvvvvvvvvv

# 修改后(取消注释,使用模块特定配置):
FINNHUB_API_KEY=different_key_for_news_module
```

### 手动配置(可选)

如果需要手动配置,可以复制示例文件:

```bash
cd tradingagents\news
copy .env.example .env
```

然后编辑 `.env` 文件,填入您的 API 密钥。

---

## 使用示例

### 获取不同市场的新闻

```python
from tradingagents.news import get_stock_news

# A股
a_share = get_stock_news("000002")

# 港股
hk_share = get_stock_news("0700.HK")

# 美股
us_share = get_stock_news("AAPL")
```

### 指定日期范围

```python
response = get_stock_news(
    "000002",
    start_date="2025-11-20",
    end_date="2025-11-26",
    max_news=20
)
```

### 指定数据源

```python
from tradingagents.news import get_stock_news
from tradingagents.news.models import NewsSource

# 只使用 AKShare
response = get_stock_news(
    "000002",
    sources=[NewsSource.AKSHARE]
)

# 使用多个数据源
response = get_stock_news(
    "000002",
    sources=[NewsSource.AKSHARE, NewsSource.TUSHARE]
)
```

### 生成报告

```python
response = get_stock_news("000002", max_news=10)
report = response.format_report()

# 打印报告
print(report)

# 保存到文件
with open("news_report.md", "w", encoding="utf-8") as f:
    f.write(report)
```

### 访问新闻详情

```python
response = get_stock_news("000002", max_news=10)

if response.success:
    for news in response.news_items:
        print(f"标题: {news.title}")
        print(f"来源: {news.source.value}")
        print(f"时间: {news.publish_time}")
        print(f"相关性: {news.relevance_score}")
        print(f"紧急度: {news.urgency.value}")
        print(f"内容: {news.content[:100]}...")
        print("-" * 60)
```

---

## 测试说明

### 基础功能测试 (test_news.py)

测试内容:

1. ✅ 配置管理器测试
2. ✅ 数据模型测试
3. ✅ 新闻提供者测试
4. ✅ 新闻聚合器测试
5. ✅ 便捷函数测试
6. ✅ 市场类型选择测试

**运行**:
```bash
.venv\Scripts\python.exe tradingagents\news\test_news.py
```

### 新旧接口对比测试 (test_comparison.py)

测试内容:

1. ✅ 老版接口测试 (`RealtimeNewsAggregator`)
2. ✅ 新版接口测试 (`get_stock_news`)
3. ✅ 功能对比分析
4. ✅ 性能对比分析
5. ✅ 高级功能测试
6. ✅ 配置管理测试

**运行**:
```bash
.venv\Scripts\python.exe tradingagents\news\test_comparison.py
```

**对比内容**:

| 特性 | 老版接口 | 新版接口 |
|------|---------|---------|
| 返回类型 | 字符串 | 结构化对象 (NewsResponse) |
| 数据结构 | 纯文本 | 结构化数据 (NewsItem) |
| 数据源透明度 | 不透明 | 明确显示使用的数据源 |
| 元数据 | 无 | 紧急度、相关性、情绪等 |
| 类型安全 | 无 | 完整类型提示 |
| 去重过滤 | 无 | 自动去重和过滤 |
| 格式化报告 | 无 | 支持 |
| 容错性 | 一般 | 单个数据源失败不影响整体 |

---

## 故障排查

### 问题 1: 没有可用的数据源

**症状**: 测试时显示"没有可用的新闻数据源"

**解决方案**:
1. 运行配置初始化脚本: `python tradingagents/news/init_config.py`
2. 检查 `.env` 文件中的数据源启用状态
3. 确认 API 密钥已正确配置

### 问题 2: API 密钥未生效

**症状**: 数据源显示"未配置"

**解决方案**:
1. 检查全局 `.env` 文件中的 API 密钥
2. 确认模块 `.env` 文件存在
3. 重新运行配置初始化脚本

### 问题 3: 对比测试失败

**症状**: `test_comparison.py` 运行失败

**解决方案**:
1. 确保老版接口可用 (`RealtimeNewsAggregator`)
2. 检查新版接口配置
3. 查看详细错误信息

### 问题 4: 配置文件被 gitignore 保护

**症状**: 无法直接编辑 `.env` 文件

**解决方案**:
- 使用 `init_config.py` 脚本自动生成配置文件
- 或者手动复制 `.env.example` 为 `.env`

---

## 架构说明

### 文件结构

```
tradingagents/news/
├── __init__.py              # 模块导出
├── models.py                # 数据模型
├── config.py                # 配置管理
├── providers.py             # 数据提供者
├── aggregator.py            # 新闻聚合器
├── init_config.py           # 配置初始化脚本
├── test_news.py             # 基础测试
├── test_comparison.py       # 对比测试
├── .env                     # 模块配置 (自动生成)
├── .env.example             # 模块配置示例
└── 新闻模块指南.md          # 本文件
```

### 配置文件位置

```
TradingAgents/
├── .env                          # 全局配置
├── .env.example                  # 全局配置示例
└── tradingagents/
    └── news/
        ├── .env                  # 模块配置 (自动生成)
        ├── .env.example          # 模块配置示例
        ├── init_config.py        # 配置初始化脚本
        ├── test_news.py          # 基础测试
        └── test_comparison.py    # 对比测试
```

### 核心组件

1. **数据模型** (`models.py`)
   - `NewsItem`: 新闻项数据结构
   - `NewsQuery`: 查询参数
   - `NewsResponse`: 响应数据
   - `MarketType`: 市场类型枚举
   - `NewsSource`: 新闻来源枚举

2. **配置管理** (`config.py`)
   - `NewsConfig`: 配置数据类
   - `NewsConfigManager`: 配置管理器
   - 使用模块化环境变量加载器

3. **新闻提供者** (`providers.py`)
   - `NewsProvider`: 提供者基类
   - `TushareNewsProvider`: Tushare 提供者
   - `AKShareNewsProvider`: AKShare 提供者
   - `FinnhubNewsProvider`: FinnHub 提供者
   - `EODHDNewsProvider`: EODHD 提供者

4. **新闻聚合器** (`aggregator.py`)
   - `NewsAggregator`: 聚合器类
   - `get_stock_news()`: 便捷函数

---

## 注意事项

1. ⚠️ **向后兼容**: 本模块是新的独立模块,不影响现有的新闻获取函数
2. ✅ **配置继承**: API 密钥会自动从全局 `.env` 继承
3. ✅ **保留注释**: 配置初始化脚本会保留所有注释和说明
4. ✅ **安全性**: `.env` 文件被 gitignore 保护,不会提交到 Git

---

## 下一步

1. ✅ 运行配置初始化脚本
2. ✅ 运行基础测试验证功能
3. ✅ 运行对比测试了解差异
4. ✅ 在实际项目中使用新接口
5. ✅ 根据需要调整配置

---

## 相关文档

- [接口定义](../../docs/news/news_func_def.md) - 接口规范
- [数据源分析](../../docs/news/) - 数据源对比
- [模块化环境变量配置](../../docs/modular_env_config.md) - 配置系统

---

## 支持

如有问题,请查看:
1. [故障排查](#故障排查)
2. 运行测试查看详细错误信息
3. 查看相关文档
