# 后端服务接口开发需求

## 文档说明

本文档定义了为股票分析报告组件开发后端接口的具体需求和实现指导。

**更新时间**: 2025-12-10

---

## 1. 需求背景

为支持前端报告组件（ReportComponent.vue）的开发，需要提供接口用于获取指定分析任务的报告数据。报告数据以Markdown格式存储，支持多个报告（如不同阶段的分析报告），前端需通过导航方式展示。

## 2. 接口开发范围

### 2.1 接口清单

当前批次：批次1 - 报告组件后端接口支持

待开发接口：
1. GET /api/analysis/{analysis_id}/reports - 获取分析任务报告列表

### 2.2 开发确认

- 本文档聚焦于上述单个接口的开发。
- 后续可扩展支持报告详情获取或下载等。

---

## 3. 接口实现要求

### 3.1 技术框架参考

- **路由层**: 在 `app/routers/analysis.py` 中添加路由端点。
- **服务层**: 创建 `app/services/report_service.py`（如果不存在）处理报告读取逻辑。
- **数据模型**: 在 `app/schemas/` 中定义请求/响应Pydantic模型（如ReportResponse）。
- **核心配置**: 使用 `app/core/config.py` 中的路径配置（如results目录）。
- **参考实现**: 参考现有 `app/routers/analysis.py` 中的任务状态接口实现。

### 3.2 设计规范参考

- **接口规范**: 遵循 `app/后端服务接口规范.md` 中的请求/响应格式、错误码、认证机制。
- **架构设计**: 集成到现有分析模块，确保与任务管理（task_manager.py）兼容。
- **安全考虑**: 验证analysis_id存在且用户有访问权限；内容消毒以防注入。

### 3.3 实现细节

#### 接口: GET /api/analysis/{analysis_id}/reports

**功能描述**: 根据分析任务ID，从文件系统或数据库获取该任务的所有报告数据，返回列表格式。报告内容以Markdown字符串返回，支持前端富文本渲染。

**请求参数**:
- Path: `analysis_id` (str, required) - 分析任务唯一ID
- Query (optional): `stage` (str) - 过滤特定阶段报告（如"market_analyst"），默认返回所有

**响应模型** (Pydantic Schema):
```python
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

class Report(BaseModel):
    report_id: str
    title: str
    stage: str
    content: str  # Markdown内容
    created_at: datetime
    file_path: Optional[str] = None  # 可选文件备份路径

class ReportResponse(BaseModel):
    success: bool
    data: Optional[dict] = None
    message: str = ""
    error: Optional[str] = None
    code: Optional[int] = None
```

**响应示例 (成功)**:
```json
{
  "success": true,
  "data": {
    "analysis_id": "123456",
    "reports": [
      {
        "report_id": "report_001",
        "title": "市场分析报告",
        "stage": "market_analyst",
        "content": "# 市场趋势分析\n\n报告内容...",
        "created_at": "2025-12-10T18:00:00Z",
        "file_path": "/results/123456/reports/market_report.md"
      },
      {
        "report_id": "report_002",
        "title": "最终交易决策报告",
        "stage": "final_decision",
        "content": "# 交易建议\n\n推荐买入...",
        "created_at": "2025-12-10T18:05:00Z"
      }
    ]
  },
  "message": "报告获取成功"
}
```

**错误响应示例**:
```json
{
  "success": false,
  "data": null,
  "message": "任务不存在或无权限",
  "error": "AnalysisNotFound",
  "code": 404
}
```

**实现步骤**:
1. 验证analysis_id存在（检查results/{analysis_id}/目录或DB）。
2. 扫描reports子目录，读取.md文件（如final_trade_decision.md等）。
3. 对于每个文件：提取标题（首行#标题）、stage（从文件名或元数据推断）、content（文件内容）。
4. 按created_at排序返回。
5. 如果无报告，返回空列表而非错误。
6. 处理大文件：限制content长度或提供摘要。

**依赖**:
- 文件系统：使用os/pathlib读取results目录。
- 时间：datetime.fromtimestamp(os.path.getmtime(file_path))。
- 异常处理：FileNotFoundError -> 404；PermissionError -> 403。

### 3.4 Python 环境要求

使用项目虚拟环境 (.venv/) 执行任何测试或调试。

---

## 4. 测试要求

### 4.1 cURL 测试命令

**正常场景**:
```bash
curl -X GET "http://localhost:8000/api/analysis/123456/reports" \
  -H "Authorization: Bearer <token>"  # 如需认证
```

**过滤特定阶段**:
```bash
curl -X GET "http://localhost:8000/api/analysis/123456/reports?stage=market_analyst" \
  -H "Authorization: Bearer <token>"
```

**错误场景 (无效ID)**:
```bash
curl -X GET "http://localhost:8000/api/analysis/invalid_id/reports" \
  -H "Authorization: Bearer <token>"
```

### 4.2 Postman 兼容性

- 支持JSON响应。
- 包含认证头如果适用。
- 验证响应代码：200 (成功), 404 (不存在), 403 (无权限)。

### 4.3 测试覆盖

- ✅ 存在任务，有报告：返回报告列表。
- ✅ 存在任务，无报告：返回空列表。
- ✅ 无效任务ID：404错误。
- ⚠️ 参数过滤：仅返回匹配stage的报告。
- ⚠️ 大文件处理：测试长Markdown渲染。

---

## 5. 文档更新流程

### 5.1 完成接口开发后

更新以下文档：
1. **后端服务接口规范.md** - 添加新接口规范和示例。
2. **接口开发计划.md** - 标记该接口为完成。
3. **后端服务接口架构设计.md** - 如需更新服务层架构。

### 5.2 更新标记

在文档中标注：
```markdown
### 3.X 报告数据获取接口

**状态**: ✅ 已完成
```

---

## 6. 其他要求

- 无需生成walkthrough文档。
- 确保接口异步友好，如果读取IO密集可使用asyncio。
- 缓存考虑：使用Redis缓存热门报告以提升性能。

---

## 附录：相关文档索引

| 文档名称 | 路径 | 用途 |
|----------|------|------|
| 接口开发计划 | `app/接口开发计划.md` | 整体开发进度 |
| 后端服务接口规范 | `app/后端服务接口规范.md` | 接口标准 |
| 参考实现代码 | `reference/TradingAgents-CN/app/` | 代码模式 |
