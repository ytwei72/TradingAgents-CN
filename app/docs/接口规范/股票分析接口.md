# 股票分析接口

## 3.1 启动分析任务

**状态**: ✅ 已完成

启动一个异步股票分析任务。

#### 请求

```http
POST /api/analysis/start
Content-Type: application/json
```

#### 请求体

```json
{
  "stock_symbol": "AAPL",
  "market_type": "美股",
  "analysis_date": "2025-12-02",
  "analysts": [
    "market_analyst",
    "fundamental_analyst",
    "news_analyst"
  ],
  "research_depth": 3,
  "include_sentiment": true,
  "include_risk_assessment": true,
  "custom_prompt": "重点关注公司的AI业务发展",
  "extra_config": {
    "llm_provider": "dashscope",
    "llm_model": "qwen-max"
  }
}
```

#### 请求参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_symbol | string | ✅ | 股票代码（如 AAPL, 000001, 9988.HK） |
| market_type | string | ✅ | 市场类型：`美股` / `A股` / `港股` |
| analysis_date | string | ❌ | 分析日期，格式 YYYY-MM-DD，默认今天 |
| analysts | array | ✅ | 分析师列表，见下表 |
| research_depth | integer | ✅ | 研究深度，1-5，数字越大越深入 |
| include_sentiment | boolean | ❌ | 是否包含情绪分析，默认 true |
| include_risk_assessment | boolean | ❌ | 是否包含风险评估，默认 true |
| custom_prompt | string | ❌ | 自定义分析提示 |
| extra_config | object | ❌ | 额外配置参数 |

**可用分析师列表**:

| 分析师 ID | 说明 |
|-----------|------|
| market_analyst | 市场分析师 |
| fundamental_analyst | 基本面分析师 |
| news_analyst | 新闻分析师 |
| social_media_analyst | 社交媒体分析师 |
| technical_analyst | 技术分析师 |

**extra_config 参数**:

| 参数 | 类型 | 说明 |
|------|------|------|
| llm_provider | string | LLM 提供商：`dashscope` / `openai` / `google` |
| llm_model | string | 模型名称：`qwen-max` / `gpt-4` / `gemini-pro` |

#### 响应

```json
{
  "analysis_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "status": "pending",
  "message": "Analysis task started"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| analysis_id | string | 分析任务唯一标识符（UUID） |
| status | string | 任务状态：`pending` |
| message | string | 状态消息 |

#### 示例

```bash
curl -X POST http://localhost:8000/api/analysis/start \
  -H "Content-Type: application/json" \
  -d '{
    "stock_symbol": "AAPL",
    "market_type": "美股",
    "analysts": ["market_analyst", "fundamental_analyst"],
    "research_depth": 3
  }'
```

---

## 3.2 查询任务状态

**状态**: ✅ 已完成

查询分析任务的当前状态和进度。

#### 请求

```http
GET /api/analysis/{analysis_id}/status
```

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| analysis_id | string | 分析任务 ID |

#### 响应

```json
{
  "task_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "status": "running",
  "created_at": "2025-12-02T14:30:00",
  "updated_at": "2025-12-02T14:35:00",
  "params": {
    "stock_symbol": "AAPL",
    "market_type": "美股",
    "analysis_date": "2025-12-02",
    "analysts": ["market_analyst", "fundamental_analyst"],
    "research_depth": 3
  },
  "progress": {
    "current_step": 3,
    "total_steps": 10,
    "percentage": 30.0,
    "message": "正在执行基本面分析..."
  },
  "error": null,
  "result": null
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| task_id | string | 分析任务 ID |
| status | string | 任务状态，见下表 |
| created_at | string | 任务创建时间 (ISO 8601) |
| updated_at | string | 任务最后更新时间 (ISO 8601) |
| params | object | 任务参数 |
| progress | object | 进度信息对象 |
| error | string/null | 错误信息（仅失败时） |
| result | object/null | 分析结果（仅完成时） |

**任务状态说明**:

| 状态 | 说明 |
|------|------|
| pending | 等待执行 |
| running | 正在执行 |
| paused | 已暂停 |
| stopped | 已停止 |
| completed | 已完成 |
| failed | 执行失败 |
| cancelled | 已取消 |

**进度信息字段** (`progress` 对象):

| 字段 | 类型 | 说明 |
|------|------|------|
| current_step | integer | 当前步骤编号 |
| total_steps | integer | 总步骤数 |
| percentage | float | 完成百分比 (0-100) |
| message | string | 当前步骤描述 |

#### 示例

```bash
curl http://localhost:8000/api/analysis/a1b2c3d4-e5f6-7890-abcd-ef1234567890/status
```

---

## 3.3 获取分析结果

**状态**: ✅ 已完成

获取已完成的分析任务的完整结果。

#### 请求

```http
GET /api/analysis/{analysis_id}/result
```

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| analysis_id | string | 分析任务 ID |

#### 响应

```json
{
  "stock_symbol": "AAPL",
  "market_type": "美股",
  "analysis_date": "2025-12-02",
  "decision": "买入",
  "confidence": 0.85,
  "full_report": "# 苹果公司(AAPL)投资分析报告\n\n## 综合评分: 85/100\n\n...",
  "analyst_reports": {
    "market_analyst": {
      "summary": "市场趋势向好，技术面支撑强劲",
      "rating": "买入",
      "confidence": 0.82,
      "key_points": [
        "大盘走势稳健，科技股表现优异",
        "成交量放大，资金流入明显"
      ]
    },
    "fundamental_analyst": {
      "summary": "基本面稳健，盈利能力强",
      "rating": "买入",
      "confidence": 0.88,
      "key_points": [
        "营收同比增长15%，超出市场预期",
        "净利润率保持在25%以上",
        "现金流充沛，财务状况健康"
      ]
    }
  },
  "risk_assessment": {
    "overall_risk": "中等",
    "risk_factors": [
      "市场波动风险",
      "行业竞争加剧"
    ],
    "risk_score": 0.45
  },
  "sentiment_analysis": {
    "overall_sentiment": "积极",
    "sentiment_score": 0.72,
    "news_sentiment": 0.68,
    "social_sentiment": 0.76
  },
  "metadata": {
    "analysis_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "created_at": "2025-12-02T14:30:00",
    "completed_at": "2025-12-02T14:35:30",
    "duration_seconds": 330,
    "llm_provider": "dashscope",
    "llm_model": "qwen-max",
    "analysts_used": ["market_analyst", "fundamental_analyst"]
  }
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| stock_symbol | string | 股票代码 |
| market_type | string | 市场类型 |
| analysis_date | string | 分析日期 |
| decision | string | 投资决策：`买入` / `持有` / `卖出` |
| confidence | float | 决策置信度 (0-1) |
| full_report | string | 完整分析报告（Markdown 格式） |
| analyst_reports | object | 各分析师的详细报告 |
| risk_assessment | object | 风险评估结果 |
| sentiment_analysis | object | 情绪分析结果 |
| metadata | object | 元数据信息 |

#### 错误响应

**任务未完成**:
```json
{
  "detail": "Analysis not completed. Current status: running"
}
```
HTTP 状态码: 400

**任务不存在**:
```json
{
  "detail": "Analysis ID not found"
}
```
HTTP 状态码: 404

#### 示例

```bash
curl http://localhost:8000/api/analysis/a1b2c3d4-e5f6-7890-abcd-ef1234567890/result
```

---

## 3.4 暂停分析任务

**状态**: ✅ 已完成

暂停正在运行的分析任务。

#### 请求

```http
POST /api/analysis/{analysis_id}/pause
```

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| analysis_id | string | 分析任务 ID |

#### 响应

```json
{
  "analysis_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "status": "paused",
  "message": "Analysis task paused"
}
```

#### 示例

```bash
curl -X POST http://localhost:8000/api/analysis/a1b2c3d4-e5f6-7890-abcd-ef1234567890/pause
```

---

## 3.5 恢复分析任务

**状态**: ✅ 已完成

恢复已暂停的分析任务。

#### 请求

```http
POST /api/analysis/{analysis_id}/resume
```

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| analysis_id | string | 分析任务 ID |

#### 响应

```json
{
  "analysis_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "status": "running",
  "message": "Analysis task resumed"
}
```

#### 示例

```bash
curl -X POST http://localhost:8000/api/analysis/a1b2c3d4-e5f6-7890-abcd-ef1234567890/resume
```

---

## 3.6 停止分析任务

**状态**: ✅ 已完成

停止分析任务（不可恢复）。

#### 请求

```http
POST /api/analysis/{analysis_id}/stop
```

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| analysis_id | string | 分析任务 ID |

#### 响应

```json
{
  "analysis_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "status": "stopped",
  "message": "Analysis task stopped"
}
```

#### 示例

```bash
curl -X POST http://localhost:8000/api/analysis/a1b2c3d4-e5f6-7890-abcd-ef1234567890/stop
```

---

## 3.7 查询任务当前步骤

**状态**: ✅ 已完成

从任务状态机查询任务的当前步骤信息。

#### 请求

```http
GET /api/analysis/{analysis_id}/current_step
```

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| analysis_id | string | 分析任务 ID |

#### 响应

```json
{
  "step_name": "market_analyst",
  "step_index": 3,
  "description": "正在执行市场分析...",
  "status": "running",
  "start_time": "2025-12-03T14:30:00",
  "end_time": null,
  "elapsed_time": 0.0,
  "events": [
    {
      "event": "start",
      "timestamp": "2025-12-03T14:30:00",
      "message": "模块开始: market_analyst"
    }
  ],
  "timestamp": "2025-12-03T14:30:05"
}
```

#### 示例

```bash
curl http://localhost:8000/api/analysis/a1b2c3d4-e5f6-7890-abcd-ef1234567890/current_step
```

---

## 3.8 查询任务历史步骤

**状态**: ✅ 已完成

获取任务历史步骤（从状态机获取）。每个步骤记录包含完整的生命周期事件。

#### 请求

```http
GET /api/analysis/{analysis_id}/history
```

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| analysis_id | string | 分析任务 ID |

#### 响应

返回完整的历史状态列表（JSON数组格式）。每个步骤只有一条记录，包含该步骤的所有生命周期事件：

```json
[
  {
    "step_name": "market_analyst",
    "step_index": 1,
    "status": "completed",
    "start_time": "2025-12-08T10:01:00.000000",
    "end_time": "2025-12-08T10:01:40.750000",
    "elapsed_time": 40.75,
    "events": [
      {
        "event": "start",
        "timestamp": "2025-12-08T10:01:00.000000",
        "message": "模块开始: market_analyst"
      },
      {
        "event": "complete",
        "timestamp": "2025-12-08T10:01:40.750000",
        "message": "模块完成: market_analyst",
        "duration": 40.75
      }
    ],
    "timestamp": "2025-12-08T10:01:40.750000"
  },
  {
    "step_name": "fundamentals_analyst",
    "step_index": 2,
    "status": "completed",
    "start_time": "2025-12-08T10:01:41.000000",
    "end_time": "2025-12-08T10:03:11.000000",
    "elapsed_time": 90.10,
    "events": [
      {
        "event": "start",
        "timestamp": "2025-12-08T10:01:41.000000",
        "message": "模块开始: fundamentals_analyst"
      },
      {
        "event": "tool_calling",
        "timestamp": "2025-12-08T10:01:50.500000",
        "message": "工具调用中: fundamentals_analyst",
        "duration": 9.5
      },
      {
        "event": "complete",
        "timestamp": "2025-12-08T10:03:11.000000",
        "message": "模块完成: fundamentals_analyst",
        "duration": 80.6
      }
    ],
    "timestamp": "2025-12-08T10:03:11.000000"
  }
]
```

#### 响应字段说明

**步骤对象**:

| 字段 | 类型 | 说明 |
|------|------|------|
| step_name | string | 步骤名称（模块ID） |
| step_index | integer | 步骤序号（从1开始） |
| status | string | 步骤状态：`running` / `completed` / `failed` |
| start_time | string | 步骤开始时间 (ISO 8601) |
| end_time | string/null | 步骤结束时间（运行中为 null） |
| elapsed_time | float | 总耗时（秒），所有阶段累计 |
| events | array | 生命周期事件列表 |
| timestamp | string | 最后更新时间 |

**事件对象** (`events` 数组元素):

| 字段 | 类型 | 说明 |
|------|------|------|
| event | string | 事件类型：`start` / `tool_calling` / `complete` / `error` |
| timestamp | string | 事件发生时间 (ISO 8601) |
| message | string | 事件描述 |
| duration | float | 该阶段耗时（秒，仅非 start 事件有此字段） |

**事件类型说明**:

| 事件类型 | 说明 |
|----------|------|
| start | 步骤开始 |
| tool_calling | 工具调用中（如 LLM 调用外部数据接口） |
| complete | 步骤完成 |
| error | 步骤出错 |

#### 示例

```bash
curl http://localhost:8000/api/analysis/a1b2c3d4-e5f6-7890-abcd-ef1234567890/history
```

---

## 3.9 获取任务计划步骤

**状态**: ✅ 已完成

在任务启动时或启动前，返回该任务预计执行的所有步骤列表。

#### 请求

```http
GET /api/analysis/{analysis_id}/planned_steps
```

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| analysis_id | string | 分析任务 ID |

#### 响应

```json
{
  "total_steps": 18,
  "steps": [
    {
      "step_index": 1,
      "step_name": "environment_validation",
      "display_name": "环境验证",
      "phase": "preparation",
      "status": "pending",
      "round": null,
      "role": null
    },
    {
      "step_index": 7,
      "step_name": "market_analyst",
      "display_name": "市场分析师",
      "phase": "analyst",
      "status": "pending",
      "round": null,
      "role": null
    },
    {
      "step_index": 10,
      "step_name": "bull_debate",
      "display_name": "看多分析师辩论",
      "phase": "debate",
      "status": "pending",
      "round": 1,
      "role": "bull"
    }
  ]
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| total_steps | integer | 总步骤数 |
| steps | array | 计划步骤列表 |

**步骤对象字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| step_index | integer | 步骤序号（从1开始） |
| step_name | string | 步骤名称（模块ID） |
| display_name | string | 步骤中文显示名称 |
| phase | string | 步骤阶段：`preparation` / `analyst` / `debate` / `trading` / `risk_assessment` |
| status | string | 步骤状态：`pending` |
| round | integer/null | 辩论轮次（仅辩论阶段有效） |
| role | string/null | 角色名称（仅辩论阶段有效） |

**步骤阶段说明**:

| 阶段 | 说明 | 包含步骤 |
|------|------|----------|
| preparation | 准备阶段 | 环境验证、参数验证、数据源初始化、工具初始化、图配置、数据收集 |
| analyst | 分析师阶段 | 市场分析师、基本面分析师、新闻分析师、社交媒体分析师（根据任务配置） |
| debate | 研究团队辩论 | 看多分析师、看空分析师、研究经理 |
| trading | 交易决策 | 交易员 |
| risk_assessment | 风险评估 | 激进风险评估、保守风险评估、中性风险评估、风险裁决 |

#### 示例

```bash
curl http://localhost:8000/api/analysis/a1b2c3d4-e5f6-7890-abcd-ef1234567890/planned_steps
```

