# TradingAgents 接口规范 - 总览

**版本**: 1.2  
**更新时间**: 2025-12-15  
**基础 URL**: `http://localhost:8000` (开发环境)  
**API 文档**: `http://localhost:8000/docs` (Swagger UI)

---

## 1. 通用说明

### 1.1 请求格式

- **Content-Type**: `application/json`
- **字符编码**: UTF-8
- **时间格式**: ISO 8601 (`YYYY-MM-DDTHH:mm:ss`)
- **日期格式**: `YYYY-MM-DD`

### 1.2 响应格式

所有接口返回 JSON 格式数据，基本结构如下:

**成功响应**:
```json
{
  "data": { ... },
  "message": "操作成功",
  "timestamp": "2025-12-02T14:30:00"
}
```

**错误响应**:
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": "详细错误信息",
    "timestamp": "2025-12-02T14:30:00"
  }
}
```

### 1.3 HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（需要登录） |
| 403 | 禁止访问（权限不足） |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |
| 503 | 服务暂时不可用 |

### 1.4 认证方式（计划中）

使用 JWT (JSON Web Token) 进行认证:

```http
Authorization: Bearer <token>
```

### 1.5 限流策略（计划中）

- 未认证用户: 100 请求/小时
- 已认证用户: 1000 请求/小时
- 分析接口: 10 并发任务/用户

---

## 2. 接口文档索引

| 接口大类 | 文档文件 |
|----------|----------|
| 健康检查接口 | `健康检查接口.md` |
| 股票数据查询接口 | `股票数据查询接口.md` |
| 股票分析接口 | `股票分析接口.md` |
| 报告管理接口 | `报告管理接口.md` |
| 配置管理接口 | `配置管理接口.md` |
| 日志管理接口 | `日志管理接口.md` |
| WebSocket接口 | `WebSocket接口.md` |
| 用户认证接口（计划中） | `用户认证接口.md` |

---

## 3. 错误码说明

### 3.1 通用错误码

| 错误码 | HTTP 状态 | 说明 |
|--------|-----------|------|
| INVALID_REQUEST | 400 | 请求参数无效 |
| UNAUTHORIZED | 401 | 未授权，需要登录 |
| FORBIDDEN | 403 | 禁止访问 |
| NOT_FOUND | 404 | 资源不存在 |
| INTERNAL_ERROR | 500 | 服务器内部错误 |

### 3.2 分析相关错误码

| 错误码 | HTTP 状态 | 说明 |
|--------|-----------|------|
| ANALYSIS_NOT_FOUND | 404 | 分析任务不存在 |
| ANALYSIS_NOT_COMPLETED | 400 | 分析任务未完成 |
| ANALYSIS_FAILED | 500 | 分析任务执行失败 |
| INVALID_STOCK_SYMBOL | 400 | 无效的股票代码 |
| INVALID_MARKET_TYPE | 400 | 无效的市场类型 |
| INVALID_ANALYST | 400 | 无效的分析师类型 |
| TASK_CONTROL_FAILED | 400 | 任务控制操作失败 |

### 3.3 配置相关错误码

| 错误码 | HTTP 状态 | 说明 |
|--------|-----------|------|
| CONFIG_LOAD_FAILED | 500 | 配置加载失败 |
| CONFIG_SAVE_FAILED | 500 | 配置保存失败 |
| INVALID_CONFIG_VALUE | 422 | 配置值无效（如 research_depth_default 超出范围） |

### 3.4 认证相关错误码（计划中）

| 错误码 | HTTP 状态 | 说明 |
|--------|-----------|------|
| INVALID_CREDENTIALS | 401 | 用户名或密码错误 |
| TOKEN_EXPIRED | 401 | 令牌已过期 |
| TOKEN_INVALID | 401 | 令牌无效 |
| USER_EXISTS | 400 | 用户已存在 |

---

## 4. 完整使用示例

### 4.1 Python 示例

```python
import requests
import time

# 基础 URL
BASE_URL = "http://localhost:8000"

# 1. 启动分析任务
response = requests.post(
    f"{BASE_URL}/api/analysis/start",
    json={
        "stock_symbol": "AAPL",
        "market_type": "美股",
        "analysts": ["market_analyst", "fundamental_analyst"],
        "research_depth": 3,
        "include_sentiment": True,
        "include_risk_assessment": True
    }
)

analysis_id = response.json()["analysis_id"]
print(f"分析任务已启动: {analysis_id}")

# 2. 轮询任务状态
while True:
    status_response = requests.get(
        f"{BASE_URL}/api/analysis/{analysis_id}/status"
    )
    status_data = status_response.json()
    
    print(f"当前状态: {status_data['status']}")
    print(f"当前步骤: {status_data['current_message']}")
    
    if status_data['status'] == 'completed':
        break
    elif status_data['status'] == 'failed':
        print(f"分析失败: {status_data['error']}")
        exit(1)
    
    time.sleep(5)  # 每5秒查询一次

# 3. 获取分析结果
result_response = requests.get(
    f"{BASE_URL}/api/analysis/{analysis_id}/result"
)
result = result_response.json()

print(f"投资决策: {result['decision']}")
print(f"置信度: {result['confidence']}")
print(f"\n完整报告:\n{result['full_report']}")
```

### 4.2 JavaScript 示例

```javascript
const BASE_URL = 'http://localhost:8000';

// 启动分析任务
async function startAnalysis() {
  const response = await fetch(`${BASE_URL}/api/analysis/start`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      stock_symbol: 'AAPL',
      market_type: '美股',
      analysts: ['market_analyst', 'fundamental_analyst'],
      research_depth: 3,
    }),
  });
  
  const data = await response.json();
  return data.analysis_id;
}

// 查询任务状态
async function checkStatus(analysisId) {
  const response = await fetch(
    `${BASE_URL}/api/analysis/${analysisId}/status`
  );
  return await response.json();
}

// 获取分析结果
async function getResult(analysisId) {
  const response = await fetch(
    `${BASE_URL}/api/analysis/${analysisId}/result`
  );
  return await response.json();
}

// 主流程
async function main() {
  const analysisId = await startAnalysis();
  console.log(`分析任务已启动: ${analysisId}`);
  
  // 轮询状态
  while (true) {
    const status = await checkStatus(analysisId);
    console.log(`当前状态: ${status.status}`);
    
    if (status.status === 'completed') {
      break;
    } else if (status.status === 'failed') {
      console.error(`分析失败: ${status.error}`);
      return;
    }
    
    await new Promise(resolve => setTimeout(resolve, 5000));
  }
  
  // 获取结果
  const result = await getResult(analysisId);
  console.log(`投资决策: ${result.decision}`);
  console.log(`置信度: ${result.confidence}`);
}

main();
```

---

## 5. 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 0.3 | 2025-12-15 | 新增模型使用日志接口（查询、统计、添加、清理等） |
| 0.2 | 2025-12-22 | 新增配置管理接口（获取和更新系统配置） |
| 0.1 | 2025-12-02 | 初始版本，包含已完成的健康检查和分析接口 |

---

## 6. 联系方式

- **项目仓库**: https://github.com/hsliuping/TradingAgents-CN
- **问题反馈**: GitHub Issues
- **API 文档**: http://localhost:8000/docs

---

## 7. 注意事项

1. 本文档基于当前实现编写，与代码保持高度一致
2. 标注为"计划中"的接口尚未实现，仅供参考
3. 生产环境部署前请修改基础 URL 和安全配置
4. 建议使用 HTTPS 协议保护数据传输安全

