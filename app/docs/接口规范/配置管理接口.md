# 配置管理接口

## 5.1 获取系统配置

**状态**: ✅ 已完成

获取系统配置。系统配置包括四种类型：`models`（模型配置）、`pricing`（定价配置）、`settings`（设置配置）。可以通过查询参数指定要获取的配置类型。

#### 请求

```http
GET /api/config/system?config_types=settings,models
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| config_types | string | ❌ | 逗号分隔的配置类型列表，可选值：`models`、`pricing`、`settings`。如果不指定，默认只返回 `settings` |

#### 响应示例

**只获取 settings（默认）**:
```json
{
  "success": true,
  "data": {
    "llm_provider": "dashscope",
    "deep_think_llm": "qwen-max",
    "quick_think_llm": "qwen-plus",
    "research_depth_default": 3,
    "market_type_default": "美股",
    "memory_enabled": true,
    "online_tools": true,
    "online_news": true,
    "realtime_data": true,
    "max_recur_limit": 5,
    "backend_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
    "custom_openai_base_url": null,
    "data_dir": "./data",
    "results_dir": "./results",
    "data_cache_dir": "./cache",
    "db": {
      "mongo": {
        "mongo_host": "localhost",
        "mongo_port": 27017,
        "mongo_username": null,
        "mongo_password": null,
        "mongo_database": "tradingagents",
        "mongo_auth_source": "admin",
        "mongo_max_connections": 100,
        "mongo_min_connections": 10,
        "mongo_connect_timeout_ms": 5000,
        "mongo_socket_timeout_ms": 30000,
        "mongo_server_selection_timeout_ms": 5000,
        "mongo_uri": "mongodb://localhost:27017/",
        "mongo_db": "tradingagents"
      }
    }
  },
  "message": "系统配置获取成功"
}
```

**获取多种配置类型**:
```json
{
  "success": true,
  "data": {
    "models": [
      {
        "provider": "dashscope",
        "model_name": "qwen-turbo",
        "api_key": "",
        "base_url": null,
        "max_tokens": 4000,
        "temperature": 0.7,
        "enabled": true
      }
    ],
    "pricing": [
      {
        "provider": "dashscope",
        "model_name": "qwen-turbo",
        "input_price_per_1k": 0.002,
        "output_price_per_1k": 0.006,
        "currency": "CNY"
      }
    ],
    "settings": {
      "llm_provider": "dashscope",
      "default_model": "qwen-turbo"
    }
  },
  "message": "系统配置获取成功"
}
```

#### 响应字段说明

**顶层字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 操作是否成功 |
| data | object/array | 配置数据。如果只请求一种配置类型，直接返回该配置；如果请求多种，返回包含所有请求配置的对象 |
| message | string | 响应消息 |

**配置类型说明**:

- **models**: 模型配置列表，每个元素包含 `provider`、`model_name`、`api_key`、`base_url`、`max_tokens`、`temperature`、`enabled` 等字段
- **pricing**: 定价配置列表，每个元素包含 `provider`、`model_name`、`input_price_per_1k`、`output_price_per_1k`、`currency` 等字段
- **settings**: 设置字典，包含 `llm_provider`、`deep_think_llm`、`quick_think_llm`、`research_depth_default`、`market_type_default`、`memory_enabled`、`online_tools`、`online_news`、`realtime_data`、`max_recur_limit`、`backend_url`、`custom_openai_base_url`、`data_dir`、`results_dir`、`data_cache_dir`、`db` 等字段

#### 错误响应

**无效的配置类型**:
```json
{
  "detail": "无效的配置类型: ['invalid_type']。有效类型: ['models', 'pricing', 'settings']"
}
```
HTTP 状态码: 400

**服务器内部错误**:
```json
{
  "detail": "获取系统配置失败: {错误信息}"
}
```
HTTP 状态码: 500

#### 示例

**获取默认配置（settings）**:
```bash
curl http://localhost:8000/api/config/system
```

**获取所有配置**:
```bash
curl "http://localhost:8000/api/config/system?config_types=models,pricing,settings"
```

**只获取 models 和 pricing**:
```bash
curl "http://localhost:8000/api/config/system?config_types=models,pricing"
```

---

## 5.2 更新系统配置

**状态**: ✅ 已完成

更新系统配置并持久化。请求体是一个 JSON 对象，可以包含 `models`、`pricing`、`settings` 中的任意几个键。根据请求中包含的键来更新对应的配置。

#### 请求

```http
PUT /api/config/system
Content-Type: application/json
```

#### 请求体

请求体可以包含以下键的任意几个：

- **models**: `List[Dict]` - 模型配置列表，会完全替换现有模型配置
- **pricing**: `List[Dict]` - 定价配置列表，会完全替换现有定价配置
- **settings**: `Dict` - 设置字典，会完全替换现有设置配置

**示例 1：只更新 settings**:
```json
{
  "settings": {
    "llm_provider": "dashscope",
    "deep_think_llm": "qwen-max",
    "research_depth_default": 4,
    "memory_enabled": false
  }
}
```

**示例 2：同时更新 models 和 pricing**:
```json
{
  "models": [
    {
      "provider": "dashscope",
      "model_name": "qwen-turbo",
      "api_key": "your-api-key",
      "base_url": null,
      "max_tokens": 4000,
      "temperature": 0.7,
      "enabled": true
    }
  ],
  "pricing": [
    {
      "provider": "dashscope",
      "model_name": "qwen-turbo",
      "input_price_per_1k": 0.002,
      "output_price_per_1k": 0.006,
      "currency": "CNY"
    }
  ]
}
```

**示例 3：更新所有配置类型**:
```json
{
  "models": [...],
  "pricing": [...],
  "settings": {
    "llm_provider": "dashscope",
    "default_model": "qwen-turbo"
  }
}
```

#### 请求参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| models | List[Dict] | ❌ | 模型配置列表，每个元素包含 `provider`、`model_name`、`api_key`、`base_url`、`max_tokens`、`temperature`、`enabled` 等字段 |
| pricing | List[Dict] | ❌ | 定价配置列表，每个元素包含 `provider`、`model_name`、`input_price_per_1k`、`output_price_per_1k`、`currency` 等字段 |
| settings | Dict | ❌ | 设置字典，包含各种系统设置参数 |

**注意事项**:
- 请求中必须包含至少一个配置类型（models、pricing、usage、settings 中的至少一个）
- 对于每种配置类型，会完全替换现有配置，不会进行合并
- 如果请求中不包含某个配置类型，该配置不会被更新

#### 响应

```json
{
  "success": true,
  "data": {},
  "message": "系统配置更新成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 操作是否成功 |
| data | object | 空对象（不返回更新后的配置） |
| message | string | 响应消息 |

#### 错误响应

**请求中未包含任何配置类型**:
```json
{
  "detail": "请求中必须包含至少一个配置类型。有效类型: ['models', 'pricing', 'settings']"
}
```
HTTP 状态码: 400

**参数验证错误**:
```json
{
  "detail": [
    {
      "type": "list_type",
      "loc": ["body", "models"],
      "msg": "Input should be a valid list",
      "input": {}
    }
  ]
}
```
HTTP 状态码: 422

**服务器内部错误**:
```json
{
  "detail": "更新系统配置失败: {错误信息}"
}
```
HTTP 状态码: 500

#### 示例

**只更新 settings**:
```bash
curl -X PUT http://localhost:8000/api/config/system \
  -H "Content-Type: application/json" \
  -d '{
    "settings": {
      "research_depth_default": 4,
      "memory_enabled": false
    }
  }'
```

**同时更新 models 和 pricing**:
```bash
curl -X PUT http://localhost:8000/api/config/system \
  -H "Content-Type: application/json" \
  -d '{
    "models": [
      {
        "provider": "dashscope",
        "model_name": "qwen-turbo",
        "api_key": "",
        "enabled": true
      }
    ],
    "pricing": [
      {
        "provider": "dashscope",
        "model_name": "qwen-turbo",
        "input_price_per_1k": 0.002,
        "output_price_per_1k": 0.006,
        "currency": "CNY"
      }
    ]
  }'
```

