# 股票数据查询接口

> 对应路由：`app/routers/stock_data.py`  
> 前缀：`/api/stock-data`

---

## 8.1 获取股票基础信息

**状态**: ✅ 已完成  
**说明**: 从 MongoDB 的 `stock_dict` 集合中获取单只股票的基础信息。

#### 请求

```http
GET /api/stock-data/basic-info/{stock_code}
```

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_code | string | ✅ | 股票代码，例如：`000001` 或 `000001.SZ`。接口内部会自动去掉交易所后缀，仅使用 6 位代码查询。 |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "symbol": "000001",
    "name": "平安银行",
    "market": "SZ",
    "industry": "银行",
    "list_date": "1991-04-03"
  },
  "message": "获取成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object/null | 股票基础信息；未找到时为 `null` 或不返回 |
| message | string | 描述信息 |

**注意**：  
当指定股票代码在 `stock_dict` 集合中不存在时，接口返回 HTTP `404`，`detail` 中包含错误说明。

---

## 8.2 获取全部股票列表

**状态**: ✅ 已完成  
**说明**: 获取系统内所有可用股票的基础信息列表。

#### 请求

```http
GET /api/stock-data/list
```

#### 成功响应示例

```json
{
  "success": true,
  "data": [
    {
      "_id": "675f8f45ce3f67b123456789",
      "symbol": "000001",
      "name": "平安银行",
      "market": "SZ"
    },
    {
      "_id": "675f8f45ce3f67b987654321",
      "symbol": "600519",
      "name": "贵州茅台",
      "market": "SH"
    }
  ],
  "total": 2,
  "message": "获取成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | array | 股票基础信息数组，每个元素为一个股票对象 |
| total | integer | 返回的股票数量 |
| message | string | 描述信息 |

**注意**：  
- 接口返回的 `_id` 字段已被转换为字符串，便于前端展示与调试；实际 MongoDB 中为 `ObjectId` 类型。  
- 当没有任何股票时，`data` 为 `[]`，`total` 为 `0`。

---

## 8.3 获取股票历史交易数据

**状态**: ✅ 已完成  
**说明**: 获取指定股票在给定日期区间内的历史交易数据，并在数据量不足时自动向前扩展日期范围，尽量补足到期望的数据点数。

#### 请求

```http
GET /api/stock-data/historical-data/{stock_code}
```

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_code | string | ✅ | 股票代码（仅支持 A 股），如 `000001.SZ` 或 `600519.SH`。 |

#### 查询参数

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| start_date | string | ✅ | - | 开始日期，格式 `YYYY-MM-DD` |
| end_date | string | ✅ | - | 结束日期，格式 `YYYY-MM-DD` |
| analysis_date | string | ❌ | null | 分析日期，用于智能调整数据范围（格式 `YYYY-MM-DD`） |
| expected_points | integer | ❌ | 60 | 期望的数据点总数，范围 1-500；仅在区间内数据量不足时，向前扩展日期范围以补足数据 |

#### 成功响应示例

```json
{
  "success": true,
  "data": [
    {
      "date": "2025-01-02",
      "open": 10.25,
      "high": 10.80,
      "low": 10.10,
      "close": 10.60,
      "volume": 12345678
    },
    {
      "date": "2025-01-03",
      "open": 10.60,
      "high": 10.90,
      "low": 10.50,
      "close": 10.70,
      "volume": 9876543
    }
  ],
  "total": 2,
  "message": "获取成功，共2条数据"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | array | 历史交易数据数组；每个元素为单个交易日的数据 |
| total | integer | 返回的数据条数（交易日数量） |
| message | string | 描述信息，通常包含实际返回条数 |

**单个交易日对象字段**（`data` 数组元素）:

| 字段 | 类型 | 说明 |
|------|------|------|
| date | string | 交易日期，格式 `YYYY-MM-DD` |
| open | number | 开盘价 |
| high | number | 最高价 |
| low | number | 最低价 |
| close | number | 收盘价 |
| volume | number | 成交量；底层字段可能来自 `vol` / `volume` / `amount` 等，已经统一映射为 `volume` |

**业务规则说明**：

1. **仅支持 A 股**：会通过 `StockUtils.get_market_info` 检查股票是否属于 A 股市场，否则返回 `400`。  
2. **日期范围校验**：`start_date` 必须早于或等于 `end_date`，否则返回 `400`。  
3. **自动扩展数据范围**：  
   - 若在 `[start_date, end_date]` 区间内的数据量小于 `expected_points`，会向前扩展查询区间，从而尽量补足数据量；  
   - 扩展数据与原区间数据按日期合并并去重，最终按日期升序返回；  
   - 若区间内数据量本身已大于等于 `expected_points`，则不会做截断，直接返回完整区间数据。  
4. **空数据**：若在指定区间内没有任何交易数据，则返回 HTTP `404`，`detail` 中说明未找到数据。

---

## 8.4 按股票查询分析报告列表

**状态**: ✅ 已完成  
**说明**: 根据股票代码从 MongoDB 报告集合中查询分析结果列表，可选按时间区间过滤，并按时间倒序返回。

#### 请求

```http
GET /api/stock-data/analysis-reports/{stock_code}
```

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_code | string | ✅ | 股票代码，例如 `000001` 或 `AAPL`。特殊值 `all` 或 `*` 表示不过滤股票代码，返回最近的报告列表。 |

#### 查询参数

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| limit | integer | ❌ | 100 | 最大返回数量，范围 1-1000 |
| start_date | string | ❌ | null | 分析开始日期（含），格式 `YYYY-MM-DD` |
| end_date | string | ❌ | null | 分析结束日期（含），格式 `YYYY-MM-DD` |

#### 成功响应示例

```json
{
  "success": true,
  "data": [
    {
      "_id": "675f9000ce3f67b123456789",
      "stock_symbol": "600519",
      "analysis_date": "2025-01-02",
      "decision": "买入",
      "confidence": 0.87,
      "timestamp": 1735728000
    },
    {
      "_id": "675f8f45ce3f67b987654321",
      "stock_symbol": "600519",
      "analysis_date": "2024-12-31",
      "decision": "持有",
      "confidence": 0.78,
      "timestamp": 1735584000
    }
  ],
  "total": 2,
  "message": "获取成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | array | 分析报告数组；每个元素为一条报告记录（字段由底层 `mongodb_report_manager` 返回） |
| total | integer | 返回的报告数量 |
| message | string | 描述信息 |

**注意**：  
- 返回的 `_id` 字段已被统一转换为字符串。  
- 报告列表会按 `timestamp` 字段从新到旧排序。  
- 当数据库未连接时会返回 HTTP `500`，`detail` 中包含错误说明。

---

## 8.5 根据股票代码查询所属板块

**状态**: ✅ 已完成  
**说明**: 根据股票代码查询该股票所属的概念板块和行业板块。

#### 请求

```http
GET /api/stock-data/sectors_by_id/{stock_id}
```

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_id | string | ✅ | 股票代码（如：`000001` 或 `000001.SZ`），接口会自动去掉交易所后缀 |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "stock_code": "000001",
    "stock_name": "平安银行",
    "market": "SZ",
    "exchange": "SZSE",
    "industry": "银行",
    "concepts": ["银行", "金融科技", "深圳本地股"],
    "industries": ["银行"],
    "concept_count": 3,
    "industry_count": 1
  },
  "message": "查询成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object | 股票板块信息 |
| message | string | 描述信息 |

**data 对象字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| stock_code | string | 股票代码 |
| stock_name | string | 股票名称 |
| market | string | 市场类型（如：SZ、SH） |
| exchange | string | 交易所代码 |
| industry | string | 所属行业（来自股票基础信息） |
| concepts | array[string] | 所属概念板块列表 |
| industries | array[string] | 所属行业板块列表 |
| concept_count | integer | 概念板块数量 |
| industry_count | integer | 行业板块数量 |

**注意**：  
- 股票代码必须是6位数字，如：`000001`。  
- 如果股票代码格式错误，返回 HTTP `400`。  
- 如果板块数据服务不可用，返回 HTTP `500`。

---

## 8.5.1 根据公司名称查询所属板块

**状态**: ✅ 已完成  
**说明**: 根据上市公司名称查询该股票所属的概念板块和行业板块。

#### 请求

```http
GET /api/stock-data/sectors_by_name/{company_name}
```

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| company_name | string | ✅ | 上市公司名称（如：`平安银行`） |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "stock_code": "000001",
    "stock_name": "平安银行",
    "market": "SZ",
    "exchange": "SZSE",
    "industry": "银行",
    "concepts": ["银行", "金融科技", "深圳本地股"],
    "industries": ["银行"],
    "concept_count": 3,
    "industry_count": 1
  },
  "message": "查询成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object | 股票板块信息 |
| message | string | 描述信息 |

**data 对象字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| stock_code | string | 股票代码 |
| stock_name | string | 股票名称 |
| market | string | 市场类型（如：SZ、SH） |
| exchange | string | 交易所代码 |
| industry | string | 所属行业（来自股票基础信息） |
| concepts | array[string] | 所属概念板块列表 |
| industries | array[string] | 所属行业板块列表 |
| concept_count | integer | 概念板块数量 |
| industry_count | integer | 行业板块数量 |

**注意**：  
- 公司名称查询使用精确匹配。  
- 如果未找到匹配的股票，返回 HTTP `404`。  
- 如果股票基础信息服务不可用，返回 HTTP `500`。  
- 如果板块数据服务不可用，返回 HTTP `500`。

---

## 8.6 查询行业板块股票列表

**状态**: ✅ 已完成  
**说明**: 根据指定的行业板块名称列表，返回每个行业板块包含的股票代码列表。

#### 请求

```http
POST /api/stock-data/sectors/industry/stocks
Content-Type: application/json
```

#### 请求体

```json
{
  "industry_names": ["银行", "证券", "保险"]
}
```

#### 请求体字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| industry_names | array[string] | ✅ | 行业板块名称列表（支持多个） |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "银行": [
      {"code": "000001", "name": "平安银行"},
      {"code": "600036", "name": "招商银行"},
      {"code": "601166", "name": "兴业银行"}
    ],
    "证券": [
      {"code": "000776", "name": "广发证券"},
      {"code": "600030", "name": "中信证券"},
      {"code": "601688", "name": "华泰证券"}
    ],
    "保险": [
      {"code": "601318", "name": "中国平安"},
      {"code": "601601", "name": "中国太保"},
      {"code": "601628", "name": "中国人寿"}
    ]
  },
  "message": "查询成功，共 3 个行业板块"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object | 行业板块股票映射，键为板块名称，值为股票信息列表 |
| message | string | 描述信息 |

**data 对象的值（股票信息列表）**:

| 字段 | 类型 | 说明 |
|------|------|------|
| code | string | 股票代码（6位数字） |
| name | string | 股票名称（公司名称） |

**注意**：  
- 如果某个行业板块不存在或没有股票，该板块对应的股票列表为空数组 `[]`。  
- 如果板块数据服务不可用，返回 HTTP `500`。  
- 如果请求体为空或缺少 `industry_names` 字段，返回 HTTP `400`。  
- 每个股票对象包含 `code` 和 `name` 字段，便于前端直接显示。

---

## 8.7 查询概念板块股票列表

**状态**: ✅ 已完成  
**说明**: 根据指定的概念板块名称列表，返回每个概念板块包含的股票代码列表。

#### 请求

```http
POST /api/stock-data/sectors/concept/stocks
Content-Type: application/json
```

#### 请求体

```json
{
  "concept_names": ["新能源", "人工智能", "5G"]
}
```

#### 请求体字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| concept_names | array[string] | ✅ | 概念板块名称列表（支持多个） |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "新能源": [
      {"code": "300750", "name": "宁德时代"},
      {"code": "002594", "name": "比亚迪"},
      {"code": "300014", "name": "亿纬锂能"}
    ],
    "人工智能": [
      {"code": "002230", "name": "科大讯飞"},
      {"code": "300496", "name": "中科创达"},
      {"code": "002415", "name": "海康威视"}
    ],
    "5G": [
      {"code": "000063", "name": "中兴通讯"},
      {"code": "002396", "name": "星网锐捷"},
      {"code": "300308", "name": "中际旭创"}
    ]
  },
  "message": "查询成功，共 3 个概念板块"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object | 概念板块股票映射，键为板块名称，值为股票信息列表 |
| message | string | 描述信息 |

**data 对象的值（股票信息列表）**:

| 字段 | 类型 | 说明 |
|------|------|------|
| code | string | 股票代码（6位数字） |
| name | string | 股票名称（公司名称） |

**注意**：  
- 如果某个概念板块不存在或没有股票，该板块对应的股票列表为空数组 `[]`。  
- 如果板块数据服务不可用，返回 HTTP `500`。  
- 如果请求体为空或缺少 `concept_names` 字段，返回 HTTP `400`。  
- 每个股票对象包含 `code` 和 `name` 字段，便于前端直接显示。

---

## 8.8 更新板块数据

**状态**: ✅ 已完成  
**说明**: 更新概念板块和/或行业板块的数据（从 akshare 获取最新数据并保存到数据库）。

#### 请求

```http
POST /api/stock-data/sectors/update
```

#### 查询参数

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| update_concept | boolean | ❌ | true | 是否更新概念板块 |
| update_industry | boolean | ❌ | true | 是否更新行业板块 |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "concept": {
      "updated": true,
      "count": 150,
      "message": "概念板块更新成功，共更新 150 个板块"
    },
    "industry": {
      "updated": true,
      "count": 80,
      "message": "行业板块更新成功，共更新 80 个板块"
    }
  },
  "message": "板块更新完成"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否全部更新成功 |
| data | object | 更新结果详情 |
| message | string | 描述信息 |

**data 对象字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| concept | object | 概念板块更新结果 |
| industry | object | 行业板块更新结果 |

**concept/industry 对象字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| updated | boolean | 是否更新成功 |
| count | integer | 更新的板块数量 |
| message | string | 更新结果描述 |

**注意**：  
- 更新过程可能需要较长时间，因为需要从 akshare 获取数据并逐个保存。  
- 如果 `update_concept` 和 `update_industry` 都为 `false`，则不会执行任何更新操作。  
- 如果板块数据服务不可用或 akshare 库未安装，返回 HTTP `500`。  
- 更新过程中如果某个板块更新失败，会继续更新其他板块，最终返回部分成功的结果。


