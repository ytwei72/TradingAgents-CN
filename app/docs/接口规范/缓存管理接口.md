# 缓存管理接口

**状态**: ✅ 已完成

缓存管理接口提供对Redis中任务缓存记录的查询功能，支持获取缓存记录总数、分页查询缓存列表以及获取指定任务的缓存详情。

---

## 1. 获取缓存记录总数

**状态**: ✅ 已完成

获取Redis中所有任务缓存记录的总数。

#### 请求

```http
GET /api/cache/count
```

#### 响应

```json
{
  "success": true,
  "total": 150,
  "message": "获取成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 请求是否成功 |
| total | integer | 缓存记录总数 |
| message | string | 响应消息 |

#### 错误响应

**Redis不可用** (500):
```json
{
  "detail": "Redis不可用，请检查Redis配置"
}
```

**Redis连接失败** (500):
```json
{
  "detail": "Redis连接失败"
}
```

#### 示例

```bash
curl http://localhost:8000/api/cache/count
```

---

## 2. 分页查询缓存记录列表

**状态**: ✅ 已完成

分页查询缓存记录的缩略信息，返回包含任务ID、状态、创建时间、更新时间、分析日期、股票代码、公司名称等字段的列表。

#### 请求

```http
GET /api/cache/list?page=1&page_size=10
```

#### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | integer | ❌ | 页码，从1开始，默认1 |
| page_size | integer | ❌ | 每页数量，范围1-100，默认10 |

#### 响应

```json
{
  "success": true,
  "data": [
    {
      "task_id": "4d3b84ab-a7be-414f-93a9-78f25160477d",
      "status": "completed",
      "created_at": "2025-12-02T10:30:00",
      "updated_at": "2025-12-02T11:45:00",
      "analysis_date": "2025-12-02",
      "stock_symbol": "603296",
      "company_name": "华勤技术"
    },
    {
      "task_id": "5e4c95bc-b8cf-525g-a4ba-89g36271588e",
      "status": "running",
      "created_at": "2025-12-02T14:20:00",
      "updated_at": "2025-12-02T14:25:00",
      "analysis_date": "2025-12-02",
      "stock_symbol": "000001",
      "company_name": "平安银行"
    }
  ],
  "total": 150,
  "page": 1,
  "page_size": 10,
  "pages": 15,
  "message": "获取成功"
}
```

#### 响应字段说明

**data数组中的字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| task_id | string | 任务ID（与analysis_id等同） |
| status | string | 任务状态：`pending` / `running` / `completed` / `failed` / `paused` / `stopped` |
| created_at | string | 创建时间，ISO 8601格式 |
| updated_at | string | 更新时间，ISO 8601格式 |
| analysis_date | string | 分析日期，格式 YYYY-MM-DD |
| stock_symbol | string | 股票代码 |
| company_name | string | 上市公司名称 |

**分页信息**:

| 字段 | 类型 | 说明 |
|------|------|------|
| total | integer | 总记录数 |
| page | integer | 当前页码 |
| page_size | integer | 每页数量 |
| pages | integer | 总页数 |

#### 错误响应

**Redis不可用** (500):
```json
{
  "detail": "Redis不可用，请检查Redis配置"
}
```

**Redis连接失败** (500):
```json
{
  "detail": "Redis连接失败"
}
```

#### 示例

```bash
# 获取第一页，每页10条
curl "http://localhost:8000/api/cache/list?page=1&page_size=10"

# 获取第二页，每页20条
curl "http://localhost:8000/api/cache/list?page=2&page_size=20"
```

---

## 3. 获取缓存记录详细信息

**状态**: ✅ 已完成

根据analysis_id（与task_id等同）获取指定任务的缓存记录详细信息，包括current_step、history、props三个子键的数据。每个字段值最多显示50个字符，超出部分用省略号表示。

#### 请求

```http
GET /api/cache/{analysis_id}
```

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| analysis_id | string | ✅ | 分析任务ID（与task_id等同） |

#### 响应

```json
{
  "success": true,
  "data": {
    "current_step": {
      "step_name": "market_analyst",
      "step_index": 1,
      "status": "completed",
      "description": "市场分析师完成分析..."
    },
    "history": [
      {
        "step_name": "market_analyst",
        "step_index": 1,
        "status": "completed",
        "timestamp": "2025-12-02T10:30:00"
      },
      {
        "step_name": "fundamentals_analyst",
        "step_index": 2,
        "status": "completed",
        "timestamp": "2025-12-02T10:35:00"
      }
    ],
    "props": {
      "task_id": "4d3b84ab-a7be-414f-93a9-78f25160477d",
      "status": "completed",
      "stock_symbol": "603296",
      "analysis_date": "2025-12-02",
      "created_at": "2025-12-02T10:30:00",
      "updated_at": "2025-12-02T11:45:00"
    }
  },
  "message": "获取成功"
}
```

#### 响应字段说明

**data对象**:

| 字段 | 类型 | 说明 |
|------|------|------|
| current_step | object \| null | 当前步骤信息，如果不存在则为null |
| history | array \| null | 历史步骤列表，如果不存在则为null |
| props | object \| null | 任务属性信息，如果不存在则为null |

**注意**: 
- 所有字段值中的字符串如果超过50个字符，会被截断并在末尾添加"..."
- 如果某个子键不存在，对应的值为null
- 如果所有子键都不存在，返回404错误

#### 错误响应

**缓存记录不存在** (404):
```json
{
  "detail": "未找到analysis_id为{analysis_id}的缓存记录"
}
```

**Redis不可用** (500):
```json
{
  "detail": "Redis不可用，请检查Redis配置"
}
```

**Redis连接失败** (500):
```json
{
  "detail": "Redis连接失败"
}
```

#### 示例

```bash
# 获取指定任务的缓存详情
curl http://localhost:8000/api/cache/4d3b84ab-a7be-414f-93a9-78f25160477d
```

---

## 缓存数据结构说明

### 缓存键格式

Redis中的缓存键格式为：`task:{task_id}:{sub_key}`

其中：
- `task_id`: 任务ID（UUID格式）
- `sub_key`: 子键名称，支持以下值：
  - `props`: 任务属性信息
  - `current_step`: 当前步骤信息
  - `history`: 历史步骤列表

### 示例缓存键

```
task:4d3b84ab-a7be-414f-93a9-78f25160477d:props
task:4d3b84ab-a7be-414f-93a9-78f25160477d:current_step
task:4d3b84ab-a7be-414f-93a9-78f25160477d:history
```

---

## 使用场景

1. **监控缓存状态**: 使用 `/api/cache/count` 获取缓存记录总数，了解系统缓存使用情况
2. **浏览缓存列表**: 使用 `/api/cache/list` 分页浏览所有缓存记录，查看任务的基本信息
3. **查看缓存详情**: 使用 `/api/cache/{analysis_id}` 查看指定任务的完整缓存信息，用于调试和分析

---

## 注意事项

1. 所有接口都需要Redis服务可用，如果Redis不可用或连接失败，将返回500错误
2. 缓存记录可能会过期或被清理，查询时可能返回404错误
3. 详细信息接口中的字段值会被截断到50个字符，如需完整数据，请直接查询Redis
4. 分页查询的page_size最大值为100，超过此值将返回错误

