# 模型使用日志接口

模型使用日志接口用于记录和查询 LLM 模型的调用情况，包括 token 使用量、成本统计等信息。数据存储在 MongoDB 的 `model_usages` 集合中。

## 时间参数说明

所有查询和统计类接口都支持两种时间模式，二选一使用：

1. **days 模式**：查询最近 N 天的数据
   - 参数：`days` (整数)
   - 示例：`days=7` 表示最近 7 天

2. **日期区间模式**：指定开始和结束日期
   - 参数：`start_date` 和 `end_date` (ISO 8601 格式字符串)
   - 示例：`start_date=2025-12-01T00:00:00&end_date=2025-12-31T23:59:59`
   - 如果只提供 `start_date`，`end_date` 将默认为当前时间
   - 必须同时提供 `end_date` 才完整

**优先级**：如果同时提供了两种模式的参数，优先使用 `days` 模式。

## 6.1 查询使用记录

**状态**: ✅ 已完成

查询模型使用记录，支持多种过滤条件。

#### 请求

```http
GET /api/logs/model_usage/records
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| limit | integer | ❌ | 返回记录数限制，默认 100，最大 10000 |
| **时间模式（二选一）** | | | |
| days | integer | ❌ | 最近 N 天的记录 |
| start_date | string | ❌ | 开始日期（ISO 格式，如 `2025-12-01T00:00:00`） |
| end_date | string | ❌ | 结束日期（ISO 格式），与 start_date 配合使用 |
| **其他过滤条件** | | | |
| provider | string | ❌ | 按供应商过滤（如 `dashscope`、`openai`） |
| model_name | string | ❌ | 按模型名称过滤（如 `qwen-max`、`gpt-4`） |
| session_id | string | ❌ | 按会话 ID 过滤 |
| analysis_type | string | ❌ | 按分析类型过滤 |

#### 响应

```json
{
  "success": true,
  "data": [
    {
      "timestamp": "2025-12-15T10:30:00",
      "provider": "dashscope",
      "model_name": "qwen-max",
      "input_tokens": 1500,
      "output_tokens": 800,
      "cost": 0.05,
      "session_id": "analysis-abc123",
      "analysis_type": "stock_analysis"
    }
  ],
  "total": 1,
  "message": "查询成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 操作是否成功 |
| data | array | 使用记录列表 |
| total | integer | 返回的记录数量 |
| message | string | 响应消息 |

**使用记录字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| timestamp | string | 记录时间（ISO 8601 格式） |
| provider | string | LLM 供应商名称 |
| model_name | string | 模型名称 |
| input_tokens | integer | 输入 token 数量 |
| output_tokens | integer | 输出 token 数量 |
| cost | float | 本次调用成本 |
| session_id | string | 会话/任务 ID |
| analysis_type | string | 分析类型 |

#### 示例

```bash
# 查询最近7天的使用记录（days模式）
curl "http://localhost:8000/api/logs/model_usage/records?days=7&limit=50"

# 按日期区间查询（日期区间模式）
curl "http://localhost:8000/api/logs/model_usage/records?start_date=2025-12-01T00:00:00&end_date=2025-12-15T23:59:59"

# 按供应商和模型过滤
curl "http://localhost:8000/api/logs/model_usage/records?days=30&provider=dashscope&model_name=qwen-max"
```

---

## 6.2 获取使用统计

**状态**: ✅ 已完成

获取模型使用的总体统计信息。

#### 请求

```http
GET /api/logs/model_usage/statistics
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **时间模式（二选一，默认最近30天）** | | | |
| days | integer | ❌ | 统计最近 N 天的数据，范围 1-365 |
| start_date | string | ❌ | 开始日期（ISO 格式） |
| end_date | string | ❌ | 结束日期（ISO 格式），与 start_date 配合使用 |
| **其他过滤条件** | | | |
| provider | string | ❌ | 按供应商过滤 |
| model_name | string | ❌ | 按模型名称过滤 |

#### 响应

```json
{
  "success": true,
  "data": {
    "period_days": 30,
    "total_cost": 12.5678,
    "total_input_tokens": 150000,
    "total_output_tokens": 80000,
    "total_requests": 500,
    "avg_cost": 0.025136,
    "avg_input_tokens": 300.0,
    "avg_output_tokens": 160.0
  },
  "message": "统计查询成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| period_days | integer | 统计周期（天） |
| total_cost | float | 总成本 |
| total_input_tokens | integer | 总输入 token 数 |
| total_output_tokens | integer | 总输出 token 数 |
| total_requests | integer | 总请求数 |
| avg_cost | float | 平均每次请求成本 |
| avg_input_tokens | float | 平均输入 token 数 |
| avg_output_tokens | float | 平均输出 token 数 |

#### 示例

```bash
# 获取最近30天的统计（days模式）
curl "http://localhost:8000/api/logs/model_usage/statistics?days=30"

# 按日期区间统计（日期区间模式）
curl "http://localhost:8000/api/logs/model_usage/statistics?start_date=2025-12-01T00:00:00&end_date=2025-12-31T23:59:59"

# 获取特定供应商的统计
curl "http://localhost:8000/api/logs/model_usage/statistics?days=7&provider=dashscope"
```

---

## 6.3 按供应商统计

**状态**: ✅ 已完成

按供应商分组获取统计信息。

#### 请求

```http
GET /api/logs/model_usage/statistics/providers
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **时间模式（二选一，默认最近30天）** | | | |
| days | integer | ❌ | 统计最近 N 天的数据，范围 1-365 |
| start_date | string | ❌ | 开始日期（ISO 格式） |
| end_date | string | ❌ | 结束日期（ISO 格式），与 start_date 配合使用 |

#### 响应

```json
{
  "success": true,
  "data": {
    "dashscope": {
      "cost": 8.5234,
      "input_tokens": 100000,
      "output_tokens": 50000,
      "requests": 350,
      "avg_cost": 0.024352
    },
    "openai": {
      "cost": 4.0444,
      "input_tokens": 50000,
      "output_tokens": 30000,
      "requests": 150,
      "avg_cost": 0.026963
    }
  },
  "message": "供应商统计查询成功"
}
```

#### 示例

```bash
# 按天数统计
curl "http://localhost:8000/api/logs/model_usage/statistics/providers?days=30"

# 按日期区间统计
curl "http://localhost:8000/api/logs/model_usage/statistics/providers?start_date=2025-12-01T00:00:00&end_date=2025-12-31T23:59:59"
```

---

## 6.4 按模型统计

**状态**: ✅ 已完成

按模型分组获取统计信息。

#### 请求

```http
GET /api/logs/model_usage/statistics/models
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **时间模式（二选一，默认最近30天）** | | | |
| days | integer | ❌ | 统计最近 N 天的数据，范围 1-365 |
| start_date | string | ❌ | 开始日期（ISO 格式） |
| end_date | string | ❌ | 结束日期（ISO 格式），与 start_date 配合使用 |
| **其他过滤条件** | | | |
| provider | string | ❌ | 按供应商过滤 |

#### 响应

```json
{
  "success": true,
  "data": {
    "dashscope/qwen-max": {
      "provider": "dashscope",
      "model_name": "qwen-max",
      "cost": 6.1234,
      "input_tokens": 80000,
      "output_tokens": 40000,
      "requests": 200,
      "avg_cost": 0.030617
    },
    "dashscope/qwen-plus": {
      "provider": "dashscope",
      "model_name": "qwen-plus",
      "cost": 2.4000,
      "input_tokens": 20000,
      "output_tokens": 10000,
      "requests": 150,
      "avg_cost": 0.016000
    }
  },
  "message": "模型统计查询成功"
}
```

#### 示例

```bash
# 获取所有模型的统计（days模式）
curl "http://localhost:8000/api/logs/model_usage/statistics/models?days=30"

# 按日期区间统计（日期区间模式）
curl "http://localhost:8000/api/logs/model_usage/statistics/models?start_date=2025-12-01T00:00:00&end_date=2025-12-31T23:59:59"

# 只获取特定供应商的模型统计
curl "http://localhost:8000/api/logs/model_usage/statistics/models?days=7&provider=dashscope"
```

---

## 6.5 统计记录数量

**状态**: ✅ 已完成

统计符合条件的记录总数。

#### 请求

```http
GET /api/logs/model_usage/count
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **时间模式（二选一，可选）** | | | |
| days | integer | ❌ | 统计最近 N 天的记录 |
| start_date | string | ❌ | 开始日期（ISO 格式） |
| end_date | string | ❌ | 结束日期（ISO 格式），与 start_date 配合使用 |
| **其他过滤条件** | | | |
| provider | string | ❌ | 按供应商过滤 |
| model_name | string | ❌ | 按模型名称过滤 |

#### 响应

```json
{
  "success": true,
  "count": 1500,
  "message": "统计成功"
}
```

#### 示例

```bash
# 统计所有记录数量
curl "http://localhost:8000/api/logs/model_usage/count"

# 统计最近7天的记录数量（days模式）
curl "http://localhost:8000/api/logs/model_usage/count?days=7"

# 按日期区间统计（日期区间模式）
curl "http://localhost:8000/api/logs/model_usage/count?start_date=2025-12-01T00:00:00&end_date=2025-12-15T23:59:59"
```

---

## 6.6 按日期统计

**状态**: ✅ 已完成

按日期（每天）统计模型使用情况，返回每天的每种模型的详细统计数据。

#### 请求

```http
GET /api/logs/model_usage/statistics/daily
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| **时间模式（二选一，默认最近7天）** | | | |
| days | integer | ❌ | 统计最近 N 天的数据，范围 1-365 |
| start_date | string | ❌ | 开始日期（ISO 格式） |
| end_date | string | ❌ | 结束日期（ISO 格式），与 start_date 配合使用 |
| **其他过滤条件** | | | |
| provider | string | ❌ | 按供应商过滤 |
| model_name | string | ❌ | 按模型名称过滤 |

#### 响应

```json
{
  "success": true,
  "data": {
    "2025-12-15": {
      "dashscope/qwen-max": {
        "provider": "dashscope",
        "model_name": "qwen-max",
        "input_tokens": 10000,
        "output_tokens": 5000,
        "total_tokens": 15000,
        "cost": 0.5,
        "requests": 10
      },
      "dashscope/qwen-plus": {
        "provider": "dashscope",
        "model_name": "qwen-plus",
        "input_tokens": 8000,
        "output_tokens": 4000,
        "total_tokens": 12000,
        "cost": 0.3,
        "requests": 8
      }
    },
    "2025-12-14": {
      "dashscope/qwen-max": {
        "provider": "dashscope",
        "model_name": "qwen-max",
        "input_tokens": 12000,
        "output_tokens": 6000,
        "total_tokens": 18000,
        "cost": 0.6,
        "requests": 12
      }
    }
  },
  "message": "按日期统计查询成功"
}
```

#### 响应字段说明

响应数据是一个嵌套的字典结构：
- 第一层：日期（格式：YYYY-MM-DD）
- 第二层：模型标识（格式：provider/model_name）
- 第三层：该模型在该日期的统计数据

**统计字段**：

| 字段 | 类型 | 说明 |
|------|------|------|
| provider | string | 供应商名称 |
| model_name | string | 模型名称 |
| input_tokens | integer | 输入 token 总数 |
| output_tokens | integer | 输出 token 总数 |
| total_tokens | integer | 总 token 数（输入+输出） |
| cost | float | 总成本 |
| requests | integer | 请求次数 |

#### 示例

```bash
# 获取最近7天的每日统计（默认）
curl "http://localhost:8000/api/logs/model_usage/statistics/daily"

# 获取最近30天的每日统计（days模式）
curl "http://localhost:8000/api/logs/model_usage/statistics/daily?days=30"

# 按日期区间统计（日期区间模式）
curl "http://localhost:8000/api/logs/model_usage/statistics/daily?start_date=2025-12-01T00:00:00&end_date=2025-12-15T23:59:59"

# 只统计特定供应商的数据
curl "http://localhost:8000/api/logs/model_usage/statistics/daily?days=7&provider=dashscope"

# 只统计特定模型的数据
curl "http://localhost:8000/api/logs/model_usage/statistics/daily?days=7&provider=dashscope&model_name=qwen-max"
```

---

## 6.7 添加使用记录

**状态**: ✅ 已完成

添加单条模型使用记录。

#### 请求

```http
POST /api/logs/model_usage/records
Content-Type: application/json
```

#### 请求体

```json
{
  "timestamp": "2025-12-15T10:30:00",
  "provider": "dashscope",
  "model_name": "qwen-max",
  "input_tokens": 1500,
  "output_tokens": 800,
  "cost": 0.05,
  "session_id": "analysis-abc123",
  "analysis_type": "stock_analysis"
}
```

#### 请求参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| timestamp | string | ❌ | 时间戳（ISO 格式），不传则使用当前时间 |
| provider | string | ✅ | 供应商名称 |
| model_name | string | ✅ | 模型名称 |
| input_tokens | integer | ✅ | 输入 token 数（≥0） |
| output_tokens | integer | ✅ | 输出 token 数（≥0） |
| cost | float | ✅ | 成本（≥0） |
| session_id | string | ✅ | 会话 ID |
| analysis_type | string | ❌ | 分析类型，默认为空字符串 |

#### 响应

```json
{
  "success": true,
  "record_id": "507f1f77bcf86cd799439011",
  "message": "记录添加成功"
}
```

#### 示例

```bash
curl -X POST "http://localhost:8000/api/logs/model_usage/records" \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "dashscope",
    "model_name": "qwen-max",
    "input_tokens": 1000,
    "output_tokens": 500,
    "cost": 0.05,
    "session_id": "session-123",
    "analysis_type": "stock_analysis"
  }'
```

---

## 6.8 批量添加使用记录

**状态**: ✅ 已完成

批量添加多条模型使用记录。

#### 请求

```http
POST /api/logs/model_usage/records/batch
Content-Type: application/json
```

#### 请求体

```json
[
  {
    "provider": "dashscope",
    "model_name": "qwen-max",
    "input_tokens": 1000,
    "output_tokens": 500,
    "cost": 0.05,
    "session_id": "session-123",
    "analysis_type": "stock_analysis"
  },
  {
    "provider": "dashscope",
    "model_name": "qwen-plus",
    "input_tokens": 800,
    "output_tokens": 400,
    "cost": 0.02,
    "session_id": "session-123",
    "analysis_type": "stock_analysis"
  }
]
```

#### 响应

```json
{
  "success": true,
  "inserted_count": 2,
  "message": "成功插入 2 条记录"
}
```

#### 示例

```bash
curl -X POST "http://localhost:8000/api/logs/model_usage/records/batch" \
  -H "Content-Type: application/json" \
  -d '[
    {"provider": "dashscope", "model_name": "qwen-max", "input_tokens": 1000, "output_tokens": 500, "cost": 0.05, "session_id": "s1", "analysis_type": "test"},
    {"provider": "dashscope", "model_name": "qwen-plus", "input_tokens": 800, "output_tokens": 400, "cost": 0.02, "session_id": "s1", "analysis_type": "test"}
  ]'
```

---

## 6.9 清理旧记录

**状态**: ✅ 已完成

删除指定天数之前的历史记录，用于数据清理和空间管理。

⚠️ **注意**: 此操作不可逆，请谨慎使用。

#### 请求

```http
DELETE /api/logs/model_usage/records/cleanup
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| days | integer | ❌ | 删除 N 天前的记录，默认 90，范围 1-365 |

#### 响应

```json
{
  "success": true,
  "deleted_count": 150,
  "message": "成功清理 150 条超过 90 天的记录"
}
```

#### 示例

```bash
# 清理90天前的旧记录
curl -X DELETE "http://localhost:8000/api/logs/model_usage/records/cleanup?days=90"

# 清理30天前的旧记录
curl -X DELETE "http://localhost:8000/api/logs/model_usage/records/cleanup?days=30"
```

---

## 6.10 服务健康检查

**状态**: ✅ 已完成

检查模型使用记录服务的健康状态。

#### 请求

```http
GET /api/logs/model_usage/health
```

#### 响应

```json
{
  "success": true,
  "connected": true,
  "collection": "model_usages",
  "total_records": 1500,
  "message": "服务正常"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 检查是否成功 |
| connected | boolean | MongoDB 连接状态 |
| collection | string | 集合名称 |
| total_records | integer | 总记录数（仅连接正常时返回） |
| message | string | 状态消息 |

#### 错误响应

**MongoDB 连接不可用**:
```json
{
  "success": true,
  "connected": false,
  "collection": null,
  "message": "MongoDB 连接不可用"
}
```

#### 示例

```bash
curl "http://localhost:8000/api/logs/model_usage/health"
```

