# 策略回测接口

本文档描述 TradingAgents 系统中与策略回测相关的 API 接口。

---

## 1. 研报批量回测

### 接口说明

启动研报批量回测任务，根据选定的研报 ID 列表进行批量回测分析。

### 请求

- **URL**: `/api/backtest/batch/start-backtest`
- **方法**: `POST`
- **Content-Type**: `application/json`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| analysis_ids | List[string] | 是 | 前端选中的研报 analysis_id 列表 |

### 请求示例

```json
{
  "analysis_ids": [
    "analysis_001",
    "analysis_002",
    "analysis_003"
  ]
}
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| success | boolean | 是否执行成功 |
| message | string | 状态说明 |
| data | object | 回测结果数据，包含 profits 和 stats |

### 响应数据结构 (data)

#### profits 数组

每个元素包含单篇研报的收益序列：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| analysis_id | string | 研报 ID |
| stock_symbol | string | 股票代码 |
| company_name | string | 公司名称 |
| analysis_date | string | 分析日期 |
| action | string | 操作类型（如：买入、卖出等） |
| profits | List[float] | 收益序列（%），每个元素对应第1天到第N天的收益 |

#### stats 对象

批量回测统计信息：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| weighted_avg | List[float] | 加权平均收益序列 |

### 响应示例

**成功响应**:

```json
{
  "success": true,
  "message": "研报批量回测完成",
  "data": {
    "profits": [
      {
        "analysis_id": "analysis_001",
        "stock_symbol": "600519",
        "company_name": "贵州茅台",
        "analysis_date": "2025-12-01",
        "action": "买入",
        "profits": [0.5, 1.2, 1.8, 2.3, 2.5]
      },
      {
        "analysis_id": "analysis_002",
        "stock_symbol": "000858",
        "company_name": "五粮液",
        "analysis_date": "2025-12-02",
        "action": "买入",
        "profits": [0.3, 0.8, 1.0, 1.5, 1.8]
      }
    ],
    "stats": {
      "weighted_avg": [0.4, 1.0, 1.4, 1.9, 2.15]
    }
  }
}
```

**错误响应**:

```json
{
  "detail": "analysis_ids 不能为空"
}
```

### HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误（如 analysis_ids 为空） |
| 500 | 服务器内部错误 |

### 备注

- 回测配置参数（horizon_days、extend_days_before、extend_days_after、weight_mode、date_mode）从数据库的 `backtest_config` 中获取
- 回测结果中的收益序列表示从分析日期起，每个交易日对应的累计收益率（百分比）

---

## 2. 错误码说明

| 错误码 | HTTP 状态 | 说明 |
|--------|-----------|------|
| BACKTEST_PARAMS_EMPTY | 400 | analysis_ids 不能为空 |
| BACKTEST_FAILED | 500 | 回测执行失败 |
| CONFIG_LOAD_FAILED | 500 | 回测配置加载失败 |

---

## 3. 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0 | 2025-12-18 | 初始版本，新增研报批量回测接口 |

