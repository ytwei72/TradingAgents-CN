# æ¨¡å‹ä½¿ç”¨æ—¥å¿—æ¥å£

æ¨¡å‹ä½¿ç”¨æ—¥å¿—æ¥å£ç”¨äºè®°å½•å’ŒæŸ¥è¯¢ LLM æ¨¡å‹çš„è°ƒç”¨æƒ…å†µï¼ŒåŒ…æ‹¬ token ä½¿ç”¨é‡ã€æˆæœ¬ç»Ÿè®¡ç­‰ä¿¡æ¯ã€‚æ•°æ®å­˜å‚¨åœ¨ MongoDB çš„ `model_usages` é›†åˆä¸­ã€‚

## æ—¶é—´å‚æ•°è¯´æ˜

æ‰€æœ‰æŸ¥è¯¢å’Œç»Ÿè®¡ç±»æ¥å£éƒ½æ”¯æŒä¸¤ç§æ—¶é—´æ¨¡å¼ï¼ŒäºŒé€‰ä¸€ä½¿ç”¨ï¼š

1. **days æ¨¡å¼**ï¼šæŸ¥è¯¢æœ€è¿‘ N å¤©çš„æ•°æ®
   - å‚æ•°ï¼š`days` (æ•´æ•°)
   - ç¤ºä¾‹ï¼š`days=7` è¡¨ç¤ºæœ€è¿‘ 7 å¤©

2. **æ—¥æœŸåŒºé—´æ¨¡å¼**ï¼šæŒ‡å®šå¼€å§‹å’Œç»“æŸæ—¥æœŸ
   - å‚æ•°ï¼š`start_date` å’Œ `end_date` (ISO 8601 æ ¼å¼å­—ç¬¦ä¸²)
   - ç¤ºä¾‹ï¼š`start_date=2025-12-01T00:00:00&end_date=2025-12-31T23:59:59`
   - å¦‚æœåªæä¾› `start_date`ï¼Œ`end_date` å°†é»˜è®¤ä¸ºå½“å‰æ—¶é—´
   - å¿…é¡»åŒæ—¶æä¾› `end_date` æ‰å®Œæ•´

**ä¼˜å…ˆçº§**ï¼šå¦‚æœåŒæ—¶æä¾›äº†ä¸¤ç§æ¨¡å¼çš„å‚æ•°ï¼Œä¼˜å…ˆä½¿ç”¨ `days` æ¨¡å¼ã€‚

## 6.1 æŸ¥è¯¢ä½¿ç”¨è®°å½•

**çŠ¶æ€**: âœ… å·²å®Œæˆ

æŸ¥è¯¢æ¨¡å‹ä½¿ç”¨è®°å½•ï¼Œæ”¯æŒå¤šç§è¿‡æ»¤æ¡ä»¶ã€‚

#### è¯·æ±‚

```http
GET /api/logs/model_usage/records
```

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| limit | integer | âŒ | è¿”å›è®°å½•æ•°é™åˆ¶ï¼Œé»˜è®¤ 100ï¼Œæœ€å¤§ 10000 |
| **æ—¶é—´æ¨¡å¼ï¼ˆäºŒé€‰ä¸€ï¼‰** | | | |
| days | integer | âŒ | æœ€è¿‘ N å¤©çš„è®°å½• |
| start_date | string | âŒ | å¼€å§‹æ—¥æœŸï¼ˆISO æ ¼å¼ï¼Œå¦‚ `2025-12-01T00:00:00`ï¼‰ |
| end_date | string | âŒ | ç»“æŸæ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ï¼Œä¸ start_date é…åˆä½¿ç”¨ |
| **å…¶ä»–è¿‡æ»¤æ¡ä»¶** | | | |
| provider | string | âŒ | æŒ‰ä¾›åº”å•†è¿‡æ»¤ï¼ˆå¦‚ `dashscope`ã€`openai`ï¼‰ |
| model_name | string | âŒ | æŒ‰æ¨¡å‹åç§°è¿‡æ»¤ï¼ˆå¦‚ `qwen-max`ã€`gpt-4`ï¼‰ |
| session_id | string | âŒ | æŒ‰ä¼šè¯ ID è¿‡æ»¤ |
| analysis_type | string | âŒ | æŒ‰åˆ†æç±»å‹è¿‡æ»¤ |

#### å“åº”

```json
{
  "success": true,
  "data": [
    {
      "timestamp": "2025-12-15T10:30:00",
      "provider": "dashscope",
      "model_name": "qwen-max",
      "input_tokens": 1500,
      "output_tokens": 800,
      "cost": 0.05,
      "session_id": "analysis-abc123",
      "analysis_type": "stock_analysis"
    }
  ],
  "total": 1,
  "message": "æŸ¥è¯¢æˆåŠŸ"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | boolean | æ“ä½œæ˜¯å¦æˆåŠŸ |
| data | array | ä½¿ç”¨è®°å½•åˆ—è¡¨ |
| total | integer | è¿”å›çš„è®°å½•æ•°é‡ |
| message | string | å“åº”æ¶ˆæ¯ |

**ä½¿ç”¨è®°å½•å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| timestamp | string | è®°å½•æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |
| provider | string | LLM ä¾›åº”å•†åç§° |
| model_name | string | æ¨¡å‹åç§° |
| input_tokens | integer | è¾“å…¥ token æ•°é‡ |
| output_tokens | integer | è¾“å‡º token æ•°é‡ |
| cost | float | æœ¬æ¬¡è°ƒç”¨æˆæœ¬ |
| session_id | string | ä¼šè¯/ä»»åŠ¡ ID |
| analysis_type | string | åˆ†æç±»å‹ |

#### ç¤ºä¾‹

```bash
# æŸ¥è¯¢æœ€è¿‘7å¤©çš„ä½¿ç”¨è®°å½•ï¼ˆdaysæ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/records?days=7&limit=50"

# æŒ‰æ—¥æœŸåŒºé—´æŸ¥è¯¢ï¼ˆæ—¥æœŸåŒºé—´æ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/records?start_date=2025-12-01T00:00:00&end_date=2025-12-15T23:59:59"

# æŒ‰ä¾›åº”å•†å’Œæ¨¡å‹è¿‡æ»¤
curl "http://localhost:8000/api/logs/model_usage/records?days=30&provider=dashscope&model_name=qwen-max"
```

---

## 6.2 è·å–ä½¿ç”¨ç»Ÿè®¡

**çŠ¶æ€**: âœ… å·²å®Œæˆ

è·å–æ¨¡å‹ä½¿ç”¨çš„æ€»ä½“ç»Ÿè®¡ä¿¡æ¯ã€‚

#### è¯·æ±‚

```http
GET /api/logs/model_usage/statistics
```

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| **æ—¶é—´æ¨¡å¼ï¼ˆäºŒé€‰ä¸€ï¼Œé»˜è®¤æœ€è¿‘30å¤©ï¼‰** | | | |
| days | integer | âŒ | ç»Ÿè®¡æœ€è¿‘ N å¤©çš„æ•°æ®ï¼ŒèŒƒå›´ 1-365 |
| start_date | string | âŒ | å¼€å§‹æ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ |
| end_date | string | âŒ | ç»“æŸæ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ï¼Œä¸ start_date é…åˆä½¿ç”¨ |
| **å…¶ä»–è¿‡æ»¤æ¡ä»¶** | | | |
| provider | string | âŒ | æŒ‰ä¾›åº”å•†è¿‡æ»¤ |
| model_name | string | âŒ | æŒ‰æ¨¡å‹åç§°è¿‡æ»¤ |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "period_days": 30,
    "total_cost": 12.5678,
    "total_input_tokens": 150000,
    "total_output_tokens": 80000,
    "total_requests": 500,
    "avg_cost": 0.025136,
    "avg_input_tokens": 300.0,
    "avg_output_tokens": 160.0
  },
  "message": "ç»Ÿè®¡æŸ¥è¯¢æˆåŠŸ"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| period_days | integer | ç»Ÿè®¡å‘¨æœŸï¼ˆå¤©ï¼‰ |
| total_cost | float | æ€»æˆæœ¬ |
| total_input_tokens | integer | æ€»è¾“å…¥ token æ•° |
| total_output_tokens | integer | æ€»è¾“å‡º token æ•° |
| total_requests | integer | æ€»è¯·æ±‚æ•° |
| avg_cost | float | å¹³å‡æ¯æ¬¡è¯·æ±‚æˆæœ¬ |
| avg_input_tokens | float | å¹³å‡è¾“å…¥ token æ•° |
| avg_output_tokens | float | å¹³å‡è¾“å‡º token æ•° |

#### ç¤ºä¾‹

```bash
# è·å–æœ€è¿‘30å¤©çš„ç»Ÿè®¡ï¼ˆdaysæ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/statistics?days=30"

# æŒ‰æ—¥æœŸåŒºé—´ç»Ÿè®¡ï¼ˆæ—¥æœŸåŒºé—´æ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/statistics?start_date=2025-12-01T00:00:00&end_date=2025-12-31T23:59:59"

# è·å–ç‰¹å®šä¾›åº”å•†çš„ç»Ÿè®¡
curl "http://localhost:8000/api/logs/model_usage/statistics?days=7&provider=dashscope"
```

---

## 6.3 æŒ‰ä¾›åº”å•†ç»Ÿè®¡

**çŠ¶æ€**: âœ… å·²å®Œæˆ

æŒ‰ä¾›åº”å•†åˆ†ç»„è·å–ç»Ÿè®¡ä¿¡æ¯ã€‚

#### è¯·æ±‚

```http
GET /api/logs/model_usage/statistics/providers
```

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| **æ—¶é—´æ¨¡å¼ï¼ˆäºŒé€‰ä¸€ï¼Œé»˜è®¤æœ€è¿‘30å¤©ï¼‰** | | | |
| days | integer | âŒ | ç»Ÿè®¡æœ€è¿‘ N å¤©çš„æ•°æ®ï¼ŒèŒƒå›´ 1-365 |
| start_date | string | âŒ | å¼€å§‹æ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ |
| end_date | string | âŒ | ç»“æŸæ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ï¼Œä¸ start_date é…åˆä½¿ç”¨ |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "dashscope": {
      "cost": 8.5234,
      "input_tokens": 100000,
      "output_tokens": 50000,
      "requests": 350,
      "avg_cost": 0.024352
    },
    "openai": {
      "cost": 4.0444,
      "input_tokens": 50000,
      "output_tokens": 30000,
      "requests": 150,
      "avg_cost": 0.026963
    }
  },
  "message": "ä¾›åº”å•†ç»Ÿè®¡æŸ¥è¯¢æˆåŠŸ"
}
```

#### ç¤ºä¾‹

```bash
# æŒ‰å¤©æ•°ç»Ÿè®¡
curl "http://localhost:8000/api/logs/model_usage/statistics/providers?days=30"

# æŒ‰æ—¥æœŸåŒºé—´ç»Ÿè®¡
curl "http://localhost:8000/api/logs/model_usage/statistics/providers?start_date=2025-12-01T00:00:00&end_date=2025-12-31T23:59:59"
```

---

## 6.4 æŒ‰æ¨¡å‹ç»Ÿè®¡

**çŠ¶æ€**: âœ… å·²å®Œæˆ

æŒ‰æ¨¡å‹åˆ†ç»„è·å–ç»Ÿè®¡ä¿¡æ¯ã€‚

#### è¯·æ±‚

```http
GET /api/logs/model_usage/statistics/models
```

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| **æ—¶é—´æ¨¡å¼ï¼ˆäºŒé€‰ä¸€ï¼Œé»˜è®¤æœ€è¿‘30å¤©ï¼‰** | | | |
| days | integer | âŒ | ç»Ÿè®¡æœ€è¿‘ N å¤©çš„æ•°æ®ï¼ŒèŒƒå›´ 1-365 |
| start_date | string | âŒ | å¼€å§‹æ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ |
| end_date | string | âŒ | ç»“æŸæ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ï¼Œä¸ start_date é…åˆä½¿ç”¨ |
| **å…¶ä»–è¿‡æ»¤æ¡ä»¶** | | | |
| provider | string | âŒ | æŒ‰ä¾›åº”å•†è¿‡æ»¤ |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "dashscope/qwen-max": {
      "provider": "dashscope",
      "model_name": "qwen-max",
      "cost": 6.1234,
      "input_tokens": 80000,
      "output_tokens": 40000,
      "requests": 200,
      "avg_cost": 0.030617
    },
    "dashscope/qwen-plus": {
      "provider": "dashscope",
      "model_name": "qwen-plus",
      "cost": 2.4000,
      "input_tokens": 20000,
      "output_tokens": 10000,
      "requests": 150,
      "avg_cost": 0.016000
    }
  },
  "message": "æ¨¡å‹ç»Ÿè®¡æŸ¥è¯¢æˆåŠŸ"
}
```

#### ç¤ºä¾‹

```bash
# è·å–æ‰€æœ‰æ¨¡å‹çš„ç»Ÿè®¡ï¼ˆdaysæ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/statistics/models?days=30"

# æŒ‰æ—¥æœŸåŒºé—´ç»Ÿè®¡ï¼ˆæ—¥æœŸåŒºé—´æ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/statistics/models?start_date=2025-12-01T00:00:00&end_date=2025-12-31T23:59:59"

# åªè·å–ç‰¹å®šä¾›åº”å•†çš„æ¨¡å‹ç»Ÿè®¡
curl "http://localhost:8000/api/logs/model_usage/statistics/models?days=7&provider=dashscope"
```

---

## 6.5 ç»Ÿè®¡è®°å½•æ•°é‡

**çŠ¶æ€**: âœ… å·²å®Œæˆ

ç»Ÿè®¡ç¬¦åˆæ¡ä»¶çš„è®°å½•æ€»æ•°ã€‚

#### è¯·æ±‚

```http
GET /api/logs/model_usage/count
```

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| **æ—¶é—´æ¨¡å¼ï¼ˆäºŒé€‰ä¸€ï¼Œå¯é€‰ï¼‰** | | | |
| days | integer | âŒ | ç»Ÿè®¡æœ€è¿‘ N å¤©çš„è®°å½• |
| start_date | string | âŒ | å¼€å§‹æ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ |
| end_date | string | âŒ | ç»“æŸæ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ï¼Œä¸ start_date é…åˆä½¿ç”¨ |
| **å…¶ä»–è¿‡æ»¤æ¡ä»¶** | | | |
| provider | string | âŒ | æŒ‰ä¾›åº”å•†è¿‡æ»¤ |
| model_name | string | âŒ | æŒ‰æ¨¡å‹åç§°è¿‡æ»¤ |

#### å“åº”

```json
{
  "success": true,
  "count": 1500,
  "message": "ç»Ÿè®¡æˆåŠŸ"
}
```

#### ç¤ºä¾‹

```bash
# ç»Ÿè®¡æ‰€æœ‰è®°å½•æ•°é‡
curl "http://localhost:8000/api/logs/model_usage/count"

# ç»Ÿè®¡æœ€è¿‘7å¤©çš„è®°å½•æ•°é‡ï¼ˆdaysæ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/count?days=7"

# æŒ‰æ—¥æœŸåŒºé—´ç»Ÿè®¡ï¼ˆæ—¥æœŸåŒºé—´æ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/count?start_date=2025-12-01T00:00:00&end_date=2025-12-15T23:59:59"
```

---

## 6.6 æŒ‰æ—¥æœŸç»Ÿè®¡

**çŠ¶æ€**: âœ… å·²å®Œæˆ

æŒ‰æ—¥æœŸï¼ˆæ¯å¤©ï¼‰ç»Ÿè®¡æ¨¡å‹ä½¿ç”¨æƒ…å†µï¼Œè¿”å›æ¯å¤©çš„æ¯ç§æ¨¡å‹çš„è¯¦ç»†ç»Ÿè®¡æ•°æ®ã€‚

#### è¯·æ±‚

```http
GET /api/logs/model_usage/statistics/daily
```

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| **æ—¶é—´æ¨¡å¼ï¼ˆäºŒé€‰ä¸€ï¼Œé»˜è®¤æœ€è¿‘7å¤©ï¼‰** | | | |
| days | integer | âŒ | ç»Ÿè®¡æœ€è¿‘ N å¤©çš„æ•°æ®ï¼ŒèŒƒå›´ 1-365 |
| start_date | string | âŒ | å¼€å§‹æ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ |
| end_date | string | âŒ | ç»“æŸæ—¥æœŸï¼ˆISO æ ¼å¼ï¼‰ï¼Œä¸ start_date é…åˆä½¿ç”¨ |
| **å…¶ä»–è¿‡æ»¤æ¡ä»¶** | | | |
| provider | string | âŒ | æŒ‰ä¾›åº”å•†è¿‡æ»¤ |
| model_name | string | âŒ | æŒ‰æ¨¡å‹åç§°è¿‡æ»¤ |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "2025-12-15": {
      "dashscope/qwen-max": {
        "provider": "dashscope",
        "model_name": "qwen-max",
        "input_tokens": 10000,
        "output_tokens": 5000,
        "total_tokens": 15000,
        "cost": 0.5,
        "requests": 10
      },
      "dashscope/qwen-plus": {
        "provider": "dashscope",
        "model_name": "qwen-plus",
        "input_tokens": 8000,
        "output_tokens": 4000,
        "total_tokens": 12000,
        "cost": 0.3,
        "requests": 8
      }
    },
    "2025-12-14": {
      "dashscope/qwen-max": {
        "provider": "dashscope",
        "model_name": "qwen-max",
        "input_tokens": 12000,
        "output_tokens": 6000,
        "total_tokens": 18000,
        "cost": 0.6,
        "requests": 12
      }
    }
  },
  "message": "æŒ‰æ—¥æœŸç»Ÿè®¡æŸ¥è¯¢æˆåŠŸ"
}
```

#### å“åº”å­—æ®µè¯´æ˜

å“åº”æ•°æ®æ˜¯ä¸€ä¸ªåµŒå¥—çš„å­—å…¸ç»“æ„ï¼š
- ç¬¬ä¸€å±‚ï¼šæ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰
- ç¬¬äºŒå±‚ï¼šæ¨¡å‹æ ‡è¯†ï¼ˆæ ¼å¼ï¼šprovider/model_nameï¼‰
- ç¬¬ä¸‰å±‚ï¼šè¯¥æ¨¡å‹åœ¨è¯¥æ—¥æœŸçš„ç»Ÿè®¡æ•°æ®

**ç»Ÿè®¡å­—æ®µ**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| provider | string | ä¾›åº”å•†åç§° |
| model_name | string | æ¨¡å‹åç§° |
| input_tokens | integer | è¾“å…¥ token æ€»æ•° |
| output_tokens | integer | è¾“å‡º token æ€»æ•° |
| total_tokens | integer | æ€» token æ•°ï¼ˆè¾“å…¥+è¾“å‡ºï¼‰ |
| cost | float | æ€»æˆæœ¬ |
| requests | integer | è¯·æ±‚æ¬¡æ•° |

#### ç¤ºä¾‹

```bash
# è·å–æœ€è¿‘7å¤©çš„æ¯æ—¥ç»Ÿè®¡ï¼ˆé»˜è®¤ï¼‰
curl "http://localhost:8000/api/logs/model_usage/statistics/daily"

# è·å–æœ€è¿‘30å¤©çš„æ¯æ—¥ç»Ÿè®¡ï¼ˆdaysæ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/statistics/daily?days=30"

# æŒ‰æ—¥æœŸåŒºé—´ç»Ÿè®¡ï¼ˆæ—¥æœŸåŒºé—´æ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/model_usage/statistics/daily?start_date=2025-12-01T00:00:00&end_date=2025-12-15T23:59:59"

# åªç»Ÿè®¡ç‰¹å®šä¾›åº”å•†çš„æ•°æ®
curl "http://localhost:8000/api/logs/model_usage/statistics/daily?days=7&provider=dashscope"

# åªç»Ÿè®¡ç‰¹å®šæ¨¡å‹çš„æ•°æ®
curl "http://localhost:8000/api/logs/model_usage/statistics/daily?days=7&provider=dashscope&model_name=qwen-max"
```

---

## 6.7 æ·»åŠ ä½¿ç”¨è®°å½•

**çŠ¶æ€**: âœ… å·²å®Œæˆ

æ·»åŠ å•æ¡æ¨¡å‹ä½¿ç”¨è®°å½•ã€‚

#### è¯·æ±‚

```http
POST /api/logs/model_usage/records
Content-Type: application/json
```

#### è¯·æ±‚ä½“

```json
{
  "timestamp": "2025-12-15T10:30:00",
  "provider": "dashscope",
  "model_name": "qwen-max",
  "input_tokens": 1500,
  "output_tokens": 800,
  "cost": 0.05,
  "session_id": "analysis-abc123",
  "analysis_type": "stock_analysis"
}
```

#### è¯·æ±‚å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| timestamp | string | âŒ | æ—¶é—´æˆ³ï¼ˆISO æ ¼å¼ï¼‰ï¼Œä¸ä¼ åˆ™ä½¿ç”¨å½“å‰æ—¶é—´ |
| provider | string | âœ… | ä¾›åº”å•†åç§° |
| model_name | string | âœ… | æ¨¡å‹åç§° |
| input_tokens | integer | âœ… | è¾“å…¥ token æ•°ï¼ˆâ‰¥0ï¼‰ |
| output_tokens | integer | âœ… | è¾“å‡º token æ•°ï¼ˆâ‰¥0ï¼‰ |
| cost | float | âœ… | æˆæœ¬ï¼ˆâ‰¥0ï¼‰ |
| session_id | string | âœ… | ä¼šè¯ ID |
| analysis_type | string | âŒ | åˆ†æç±»å‹ï¼Œé»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸² |

#### å“åº”

```json
{
  "success": true,
  "record_id": "507f1f77bcf86cd799439011",
  "message": "è®°å½•æ·»åŠ æˆåŠŸ"
}
```

#### ç¤ºä¾‹

```bash
curl -X POST "http://localhost:8000/api/logs/model_usage/records" \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "dashscope",
    "model_name": "qwen-max",
    "input_tokens": 1000,
    "output_tokens": 500,
    "cost": 0.05,
    "session_id": "session-123",
    "analysis_type": "stock_analysis"
  }'
```

---

## 6.8 æ‰¹é‡æ·»åŠ ä½¿ç”¨è®°å½•

**çŠ¶æ€**: âœ… å·²å®Œæˆ

æ‰¹é‡æ·»åŠ å¤šæ¡æ¨¡å‹ä½¿ç”¨è®°å½•ã€‚

#### è¯·æ±‚

```http
POST /api/logs/model_usage/records/batch
Content-Type: application/json
```

#### è¯·æ±‚ä½“

```json
[
  {
    "provider": "dashscope",
    "model_name": "qwen-max",
    "input_tokens": 1000,
    "output_tokens": 500,
    "cost": 0.05,
    "session_id": "session-123",
    "analysis_type": "stock_analysis"
  },
  {
    "provider": "dashscope",
    "model_name": "qwen-plus",
    "input_tokens": 800,
    "output_tokens": 400,
    "cost": 0.02,
    "session_id": "session-123",
    "analysis_type": "stock_analysis"
  }
]
```

#### å“åº”

```json
{
  "success": true,
  "inserted_count": 2,
  "message": "æˆåŠŸæ’å…¥ 2 æ¡è®°å½•"
}
```

#### ç¤ºä¾‹

```bash
curl -X POST "http://localhost:8000/api/logs/model_usage/records/batch" \
  -H "Content-Type: application/json" \
  -d '[
    {"provider": "dashscope", "model_name": "qwen-max", "input_tokens": 1000, "output_tokens": 500, "cost": 0.05, "session_id": "s1", "analysis_type": "test"},
    {"provider": "dashscope", "model_name": "qwen-plus", "input_tokens": 800, "output_tokens": 400, "cost": 0.02, "session_id": "s1", "analysis_type": "test"}
  ]'
```

---

## 6.9 æ¸…ç†æ—§è®°å½•

**çŠ¶æ€**: âœ… å·²å®Œæˆ

åˆ é™¤æŒ‡å®šå¤©æ•°ä¹‹å‰çš„å†å²è®°å½•ï¼Œç”¨äºæ•°æ®æ¸…ç†å’Œç©ºé—´ç®¡ç†ã€‚

âš ï¸ **æ³¨æ„**: æ­¤æ“ä½œä¸å¯é€†ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚

#### è¯·æ±‚

```http
DELETE /api/logs/model_usage/records/cleanup
```

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| days | integer | âŒ | åˆ é™¤ N å¤©å‰çš„è®°å½•ï¼Œé»˜è®¤ 90ï¼ŒèŒƒå›´ 1-365 |

#### å“åº”

```json
{
  "success": true,
  "deleted_count": 150,
  "message": "æˆåŠŸæ¸…ç† 150 æ¡è¶…è¿‡ 90 å¤©çš„è®°å½•"
}
```

#### ç¤ºä¾‹

```bash
# æ¸…ç†90å¤©å‰çš„æ—§è®°å½•
curl -X DELETE "http://localhost:8000/api/logs/model_usage/records/cleanup?days=90"

# æ¸…ç†30å¤©å‰çš„æ—§è®°å½•
curl -X DELETE "http://localhost:8000/api/logs/model_usage/records/cleanup?days=30"
```

---

## 6.10 æœåŠ¡å¥åº·æ£€æŸ¥

**çŠ¶æ€**: âœ… å·²å®Œæˆ

æ£€æŸ¥æ¨¡å‹ä½¿ç”¨è®°å½•æœåŠ¡çš„å¥åº·çŠ¶æ€ã€‚

#### è¯·æ±‚

```http
GET /api/logs/model_usage/health
```

#### å“åº”

```json
{
  "success": true,
  "connected": true,
  "collection": "model_usages",
  "total_records": 1500,
  "message": "æœåŠ¡æ­£å¸¸"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | boolean | æ£€æŸ¥æ˜¯å¦æˆåŠŸ |
| connected | boolean | MongoDB è¿æ¥çŠ¶æ€ |
| collection | string | é›†åˆåç§° |
| total_records | integer | æ€»è®°å½•æ•°ï¼ˆä»…è¿æ¥æ­£å¸¸æ—¶è¿”å›ï¼‰ |
| message | string | çŠ¶æ€æ¶ˆæ¯ |

#### é”™è¯¯å“åº”

**MongoDB è¿æ¥ä¸å¯ç”¨**:
```json
{
  "success": true,
  "connected": false,
  "collection": null,
  "message": "MongoDB è¿æ¥ä¸å¯ç”¨"
}
```

#### ç¤ºä¾‹

```bash
curl "http://localhost:8000/api/logs/model_usage/health"
```

---

## 7. æ“ä½œæ—¥å¿—æ¥å£

æ“ä½œæ—¥å¿—æ¥å£ç”¨äºæŸ¥è¯¢å’Œæµè§ˆç»“æ„åŒ–æ—¥å¿—æ–‡ä»¶ï¼ˆ`tradingagents_structured.log` åŠå…¶å¤‡ä»½æ–‡ä»¶ï¼‰ã€‚æ—¥å¿—æ–‡ä»¶é‡‡ç”¨ JSON Lines æ ¼å¼ï¼Œæ¯è¡Œä¸€æ¡ JSON è®°å½•ã€‚

### æ—¶é—´å‚æ•°è¯´æ˜

æŸ¥è¯¢æ¥å£æ”¯æŒä¸¤ç§æ—¶é—´æ¨¡å¼ï¼ŒäºŒé€‰ä¸€ä½¿ç”¨ï¼š

1. **days æ¨¡å¼**ï¼šæŸ¥è¯¢æœ€è¿‘ N å¤©çš„æ•°æ®
   - å‚æ•°ï¼š`days` (æ•´æ•°)
   - ç¤ºä¾‹ï¼š`days=7` è¡¨ç¤ºæœ€è¿‘ 7 å¤©

2. **æ—¥æœŸåŒºé—´æ¨¡å¼**ï¼šæŒ‡å®šå¼€å§‹å’Œç»“æŸæ—¥æœŸ
   - å‚æ•°ï¼š`start_date` å’Œ `end_date` (YYYY-MM-DD æ ¼å¼å­—ç¬¦ä¸²)
   - ç¤ºä¾‹ï¼š`start_date=2025-12-01&end_date=2025-12-31`
   - å¦‚æœåªæä¾› `start_date`ï¼Œ`end_date` å°†é»˜è®¤ä¸ºå½“å‰æ—¶é—´
   - å¦‚æœåªæä¾› `end_date`ï¼Œ`start_date` å°†é»˜è®¤ä¸ºæœ€æ—©æ—¶é—´

**ä¼˜å…ˆçº§**ï¼šå¦‚æœåŒæ—¶æä¾›äº†ä¸¤ç§æ¨¡å¼çš„å‚æ•°ï¼Œä¼˜å…ˆä½¿ç”¨ `days` æ¨¡å¼ã€‚

---

## 7.1 æŸ¥è¯¢æ“ä½œæ—¥å¿—

**çŠ¶æ€**: âœ… å·²å®Œæˆ

æŸ¥è¯¢ç»“æ„åŒ–æ—¥å¿—æ–‡ä»¶ä¸­çš„æ—¥å¿—è®°å½•ï¼Œæ”¯æŒå¤šç§è¿‡æ»¤æ¡ä»¶ã€‚

#### è¯·æ±‚

```http
GET /api/logs/operation/query
```

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| limit | integer | âŒ | è¿”å›ç»“æœæ•°é‡é™åˆ¶ï¼Œé»˜è®¤ 1000ï¼ŒèŒƒå›´ 1-10000 |
| **æ—¶é—´æ¨¡å¼ï¼ˆäºŒé€‰ä¸€ï¼‰** | | | |
| days | integer | âŒ | æœ€è¿‘ N å¤©çš„è®°å½• |
| start_date | string | âŒ | å¼€å§‹æ—¥æœŸï¼ˆYYYY-MM-DD æ ¼å¼ï¼Œå¦‚ `2025-12-01`ï¼‰ |
| end_date | string | âŒ | ç»“æŸæ—¥æœŸï¼ˆYYYY-MM-DD æ ¼å¼ï¼‰ï¼Œä¸ start_date é…åˆä½¿ç”¨ |
| **å…¶ä»–è¿‡æ»¤æ¡ä»¶** | | | |
| keyword | string | âŒ | å…³é”®å­—æœç´¢ï¼ˆåœ¨ messageã€moduleã€functionã€logger å­—æ®µä¸­æœç´¢ï¼‰ |
| level | string | âŒ | æ—¥å¿—çº§åˆ«è¿‡æ»¤ï¼ˆINFOã€WARNINGã€ERRORï¼‰ |
| logger | string | âŒ | Logger åç§°è¿‡æ»¤ |

#### å“åº”

```json
{
  "success": true,
  "data": [
    {
      "timestamp": "2025-12-09T09:44:05.591394",
      "level": "INFO",
      "logger": "agents",
      "message": "ğŸ“Š ä¼˜åŒ–Aè‚¡æ•°æ®æä¾›å™¨åˆå§‹åŒ–å®Œæˆ",
      "module": "optimized_china_data",
      "function": "__init__",
      "line": 29
    }
  ],
  "total": 1000,
  "filtered_total": 50,
  "message": "è·å–æ—¥å¿—æˆåŠŸ"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | boolean | æ“ä½œæ˜¯å¦æˆåŠŸ |
| data | array | æ—¥å¿—è®°å½•åˆ—è¡¨ |
| total | integer | æ—¥å¿—æ–‡ä»¶ä¸­çš„æ€»è®°å½•æ•° |
| filtered_total | integer | ç­›é€‰åçš„è®°å½•æ•° |
| message | string | å“åº”æ¶ˆæ¯ |

**æ—¥å¿—è®°å½•å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| timestamp | string | æ—¶é—´æˆ³ï¼ˆISO 8601 æ ¼å¼ï¼‰ |
| level | string | æ—¥å¿—çº§åˆ«ï¼ˆINFOã€WARNINGã€ERROR ç­‰ï¼‰ |
| logger | string | Logger åç§° |
| message | string | æ—¥å¿—æ¶ˆæ¯å†…å®¹ |
| module | string | æ¨¡å—åç§°ï¼ˆå¯é€‰ï¼‰ |
| function | string | å‡½æ•°åç§°ï¼ˆå¯é€‰ï¼‰ |
| line | integer | è¡Œå·ï¼ˆå¯é€‰ï¼‰ |

#### ç¤ºä¾‹

```bash
# æŸ¥è¯¢æœ€è¿‘7å¤©çš„æ—¥å¿—ï¼ˆdaysæ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/operation/query?days=7&limit=100"

# æŒ‰æ—¥æœŸåŒºé—´æŸ¥è¯¢ï¼ˆæ—¥æœŸåŒºé—´æ¨¡å¼ï¼‰
curl "http://localhost:8000/api/logs/operation/query?start_date=2025-12-01&end_date=2025-12-31"

# å…³é”®å­—æœç´¢
curl "http://localhost:8000/api/logs/operation/query?days=7&keyword=AKShare"

# æŒ‰æ—¥å¿—çº§åˆ«è¿‡æ»¤
curl "http://localhost:8000/api/logs/operation/query?days=7&level=ERROR"

# æŒ‰Loggerè¿‡æ»¤
curl "http://localhost:8000/api/logs/operation/query?days=7&logger=agents"

# ç»„åˆæŸ¥è¯¢
curl "http://localhost:8000/api/logs/operation/query?days=7&keyword=é”™è¯¯&level=ERROR&limit=50"
```

---

## 7.2 è·å–æ—¥å¿—ç»Ÿè®¡ä¿¡æ¯

**çŠ¶æ€**: âœ… å·²å®Œæˆ

è·å–æ—¥å¿—æ–‡ä»¶çš„åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶åˆ—è¡¨ã€å¤§å°ã€ä¿®æ”¹æ—¶é—´ç­‰ã€‚

#### è¯·æ±‚

```http
GET /api/logs/operation/stats
```

#### å“åº”

```json
{
  "success": true,
  "data": {
    "total_files": 3,
    "files": [
      {
        "filename": "tradingagents_structured.log",
        "size": 1024000,
        "modified_time": "2025-12-16T11:35:09.013868",
        "exists": true
      },
      {
        "filename": "tradingagents_structured.log.1",
        "size": 512000,
        "modified_time": "2025-12-15T10:20:30.123456",
        "exists": true
      }
    ]
  }
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | boolean | æ“ä½œæ˜¯å¦æˆåŠŸ |
| data | object | ç»Ÿè®¡æ•°æ® |
| data.total_files | integer | æ—¥å¿—æ–‡ä»¶æ€»æ•° |
| data.files | array | æ–‡ä»¶ä¿¡æ¯åˆ—è¡¨ |
| data.files[].filename | string | æ–‡ä»¶å |
| data.files[].size | integer | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| data.files[].modified_time | string | æœ€åä¿®æ”¹æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |
| data.files[].exists | boolean | æ–‡ä»¶æ˜¯å¦å­˜åœ¨ |
| data.files[].error | string | è¯»å–é”™è¯¯ä¿¡æ¯ï¼ˆä»…åœ¨å‡ºé”™æ—¶å­˜åœ¨ï¼‰ |

#### ç¤ºä¾‹

```bash
curl "http://localhost:8000/api/logs/operation/stats"
```

