# 自选股管理接口

> 对应路由：`app/routers/favorite_stocks.py`  
> 前缀：`/api/favorite-stocks`

---

## 9.1 创建自选股

**状态**: ✅ 已完成  
**说明**: 创建一条自选股记录。如果未提供股票名称，系统会自动从股票字典查询并填充。

#### 请求

```http
POST /api/favorite-stocks
Content-Type: application/json
```

#### 请求体

```json
{
  "stock_code": "000001",
  "user_id": "default",
  "stock_name": "平安银行",
  "market_type": "A股",
  "category": "银行股",
  "tags": ["蓝筹", "金融"],
  "themes": ["银行", "金融科技"],
  "sectors": ["银行"],
  "notes": "重点关注"
}
```

#### 请求参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_code | string | ✅ | 股票代码（如：000001） |
| user_id | string | ❌ | 用户ID，默认"default" |
| stock_name | string | ❌ | 股票名称，如不提供将从股票字典自动查询 |
| market_type | string | ❌ | 市场类型（如：A股、港股、美股） |
| category | string | ❌ | 分类，默认"default" |
| tags | array[string] | ❌ | 标签列表，默认[] |
| themes | array[string] | ❌ | 概念板块（Theme）列表，默认[] |
| sectors | array[string] | ❌ | 行业板块（Sector）列表，默认[] |
| notes | string | ❌ | 备注，默认"无" |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "stock_code": "000001",
    "user_id": "default",
    "stock_name": "平安银行",
    "market_type": "A股",
    "category": "银行股",
    "tags": ["蓝筹", "金融"],
    "themes": ["银行", "金融科技"],
    "sectors": ["银行"],
    "notes": "重点关注",
    "created_at": "2025-01-15T10:30:00",
    "updated_at": "2025-01-15T10:30:00"
  },
  "message": "创建成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object/null | 创建的自选股记录 |
| message | string | 描述信息 |

**注意**：  
- 如果用户ID和股票代码的组合已存在，接口返回 HTTP `400`，提示记录已存在。
- 如果未提供股票名称，系统会自动从 `stock_dict` 集合查询并填充。

---

## 9.2 查询自选股列表

**状态**: ✅ 已完成  
**说明**: 查询自选股列表，支持按用户ID、股票代码、分类、标签等条件过滤，支持分页和排序。

#### 请求

```http
GET /api/favorite-stocks?user_id=default&category=银行股&limit=100&skip=0&sort_by=created_at&sort_order=desc
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| user_id | string | ❌ | 用户ID，默认"default" |
| stock_code | string | ❌ | 股票代码（可选，用于精确查询） |
| category | string | ❌ | 分类（可选） |
| tag | string | ❌ | 标签（可选） |
| limit | integer | ❌ | 最大返回数量，默认100，范围1-1000 |
| skip | integer | ❌ | 跳过记录数（用于分页），默认0 |
| sort_by | string | ❌ | 排序字段，默认"created_at" |
| sort_order | string | ❌ | 排序方向（asc/desc），默认"desc" |

#### 成功响应示例

```json
{
  "success": true,
  "data": [
    {
      "stock_code": "000001",
      "user_id": "default",
      "stock_name": "平安银行",
      "market_type": "A股",
      "category": "银行股",
      "tags": ["蓝筹", "金融"],
      "themes": ["银行", "金融科技"],
      "sectors": ["银行"],
      "notes": "重点关注",
      "created_at": "2025-01-15T10:30:00",
      "updated_at": "2025-01-15T10:30:00"
    },
    {
      "stock_code": "600519",
      "user_id": "default",
      "stock_name": "贵州茅台",
      "category": "白酒股",
      "tags": ["蓝筹", "消费"],
      "themes": ["白酒"],
      "sectors": ["食品饮料"],
      "notes": "无",
      "created_at": "2025-01-14T15:20:00",
      "updated_at": "2025-01-14T15:20:00"
    }
  ],
  "total": 2,
  "message": "查询成功，共2条记录"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | array | 自选股记录数组 |
| total | integer | 符合条件的总记录数 |
| message | string | 描述信息 |

---

## 9.3 查询单个自选股详情

**状态**: ✅ 已完成  
**说明**: 根据股票代码查询指定自选股的详细信息。

#### 请求

```http
GET /api/favorite-stocks/{stock_code}?user_id=default
```

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_code | string | ✅ | 股票代码 |

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| user_id | string | ❌ | 用户ID，默认"default" |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "stock_code": "000001",
    "user_id": "default",
    "stock_name": "平安银行",
    "market_type": "A股",
    "category": "银行股",
    "tags": ["蓝筹", "金融"],
    "themes": ["银行", "金融科技"],
    "sectors": ["银行"],
    "notes": "重点关注",
    "created_at": "2025-01-15T10:30:00",
    "updated_at": "2025-01-15T10:30:00"
  },
  "message": "查询成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object/null | 自选股记录；未找到时为 `null` |
| message | string | 描述信息 |

**注意**：  
当指定股票代码的自选股记录不存在时，接口返回 HTTP `404`。

---

## 9.4 更新自选股

**状态**: ✅ 已完成  
**说明**: 更新指定自选股的记录信息。

#### 请求

```http
PUT /api/favorite-stocks/{stock_code}?user_id=default
Content-Type: application/json
```

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_code | string | ✅ | 股票代码 |

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| user_id | string | ❌ | 用户ID，默认"default" |

#### 请求体

```json
{
  "stock_name": "平安银行股份有限公司",
  "category": "金融股",
  "tags": ["蓝筹", "金融", "银行"],
  "themes": ["银行", "金融科技", "数字金融"],
  "sectors": ["银行"],
  "notes": "更新后的备注"
}
```

#### 请求参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_name | string | ❌ | 股票名称 |
| market_type | string | ❌ | 市场类型 |
| category | string | ❌ | 分类 |
| tags | array[string] | ❌ | 标签列表 |
| themes | array[string] | ❌ | 概念板块（Theme）列表 |
| sectors | array[string] | ❌ | 行业板块（Sector）列表 |
| notes | string | ❌ | 备注 |

**注意**：所有字段都是可选的，只更新提供的字段。

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "stock_code": "000001",
    "user_id": "default",
    "stock_name": "平安银行股份有限公司",
    "market_type": "A股",
    "category": "金融股",
    "tags": ["蓝筹", "金融", "银行"],
    "themes": ["银行", "金融科技", "数字金融"],
    "sectors": ["银行"],
    "notes": "更新后的备注",
    "created_at": "2025-01-15T10:30:00",
    "updated_at": "2025-01-15T11:00:00"
  },
  "message": "更新成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object | 更新后的自选股记录 |
| message | string | 描述信息 |

**注意**：  
- 如果未找到指定记录，接口返回 HTTP `404`。
- 如果没有提供任何要更新的字段，接口返回 HTTP `400`。

---

## 9.5 删除自选股

**状态**: ✅ 已完成  
**说明**: 删除指定的自选股记录。

#### 请求

```http
DELETE /api/favorite-stocks/{stock_code}?user_id=default
```

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_code | string | ✅ | 股票代码 |

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| user_id | string | ❌ | 用户ID，默认"default" |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "stock_code": "000001",
    "user_id": "default",
    "stock_name": "平安银行",
    "category": "银行股",
    "tags": ["蓝筹", "金融"],
    "themes": ["银行"],
    "sectors": ["银行"],
    "notes": "重点关注",
    "created_at": "2025-01-15T10:30:00",
    "updated_at": "2025-01-15T10:30:00"
  },
  "message": "删除成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object | 被删除的自选股记录（删除前的数据） |
| message | string | 描述信息 |

**注意**：  
当指定股票代码的自选股记录不存在时，接口返回 HTTP `404`。

---

## 9.6 获取自选股统计信息

**状态**: ✅ 已完成  
**说明**: 获取自选股的统计信息，包括总数、按分类统计、按标签统计等。

#### 请求

```http
GET /api/favorite-stocks/statistics/summary?user_id=default
```

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| user_id | string | ❌ | 用户ID，默认"default" |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
    "total_count": 10,
    "category_stats": {
      "银行股": 3,
      "白酒股": 2,
      "科技股": 5
    },
    "tag_stats": {
      "蓝筹": 8,
      "金融": 3,
      "消费": 2,
      "科技": 5
    }
  },
  "message": "统计成功"
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否请求成功 |
| data | object | 统计信息对象 |
| data.total_count | integer | 自选股总数 |
| data.category_stats | object | 按分类统计，键为分类名称，值为该分类的股票数量 |
| data.tag_stats | object | 按标签统计，键为标签名称，值为该标签的股票数量 |
| message | string | 描述信息 |

---

## 数据模型

### 自选股记录结构

```json
{
  "stock_code": "000001",
  "user_id": "default",
  "stock_name": "平安银行",
  "market_type": "A股",
  "category": "银行股",
  "tags": ["蓝筹", "金融"],
  "themes": ["银行", "金融科技"],
  "sectors": ["银行"],
  "notes": "重点关注",
  "created_at": "2025-01-15T10:30:00",
  "updated_at": "2025-01-15T10:30:00"
}
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| stock_code | string | ✅ | 股票代码（6位数字，如：000001） |
| user_id | string | ✅ | 用户ID，用于区分不同用户的自选股 |
| stock_name | string | ❌ | 股票名称，如不提供会自动从股票字典查询 |
| market_type | string | ❌ | 市场类型（A股、港股、美股等） |
| category | string | ❌ | 分类，用于对自选股进行分类管理 |
| tags | array[string] | ❌ | 标签列表，用于标记和筛选 |
| themes | array[string] | ❌ | 概念板块（Theme）列表 |
| sectors | array[string] | ❌ | 行业板块（Sector）列表 |
| notes | string | ❌ | 备注信息，默认"无" |
| created_at | datetime | ✅ | 创建时间（自动生成） |
| updated_at | datetime | ✅ | 更新时间（自动生成） |

### 唯一性约束

- 同一用户ID下，股票代码必须唯一（复合唯一索引：`user_id + stock_code`）

---

## 错误响应

所有接口在发生错误时，都会返回统一的错误响应格式：

```json
{
  "detail": "错误描述信息"
}
```

### 常见错误码

| HTTP状态码 | 说明 | 示例 |
|-----------|------|------|
| 400 | 请求参数错误 | 记录已存在、缺少必填参数等 |
| 404 | 资源不存在 | 未找到指定的自选股记录 |
| 500 | 服务器内部错误 | MongoDB连接失败、数据库操作异常等 |

---

## 使用示例

### 示例1：创建自选股

```bash
curl -X POST http://localhost:8000/api/favorite-stocks \
  -H "Content-Type: application/json" \
  -d '{
    "stock_code": "000001",
    "category": "银行股",
    "tags": ["蓝筹", "金融"],
    "notes": "重点关注"
  }'
```

### 示例2：查询自选股列表（按分类过滤）

```bash
curl "http://localhost:8000/api/favorite-stocks?category=银行股&limit=10"
```

### 示例3：更新自选股标签

```bash
curl -X PUT "http://localhost:8000/api/favorite-stocks/000001" \
  -H "Content-Type: application/json" \
  -d '{
    "tags": ["蓝筹", "金融", "银行", "价值投资"]
  }'
```

### 示例4：获取统计信息

```bash
curl "http://localhost:8000/api/favorite-stocks/statistics/summary"
```

